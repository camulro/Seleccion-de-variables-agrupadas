---
title: "Análisis alzheimer"
subtitle: ' '
author: "Carolina Mulet"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, comment = "")
```

\tableofcontents

<!-- # 0. Lectura y limpieza del banco de datos -->

```{r library}
# Cargamos las librerías que necesitaremos:
library(kableExtra)
library(dplyr)
library(mice)
library(VIM)
library(corrplot)
library(BAS)
library(table1)
library(ggplot2)
library(paletteer)
```


```{r, results='asis'}
read_excel_allsheets <- function(filename, tibble = FALSE) {
  sheets <- readxl::excel_sheets(filename)
  x <- lapply(sheets, function(X) readxl::read_excel(filename, sheet = X))
  if(!tibble) x <- lapply(x, as.data.frame)
  names(x) <- sheets
  x
}

datos <- read_excel_allsheets("./data/original-data/20221128_BBDD_COMPLETA_FIS 2019_bioestadistica_UV_2.xlsx")
# View(datos$Peroxidación)
# View(datos$Lípidos)
# View(datos$MicroRNAs)

datos_LP_PO <- full_join(datos$Lípidos, datos$Peroxidación,
                         by = "Pacientes") %>% 
  arrange(Pacientes) %>% 
  rename(Clasif.L = `CLASIF FINAL.x`, # lipidos
         Clasif.P = `CLASIF FINAL.y`, # peroxidación
         sex.L = genero.x,
         sex.P = genero.y,
         edad.L = edad.x,
         edad.P = edad.y) %>% 
  mutate(Grupos = ifelse(Pacientes %in% datos$Lípidos$Pacientes, 
                         Clasif.L, NA),
         Grupos = ifelse(Pacientes %in% datos$Peroxidación$Pacientes, 
                         Clasif.P, Grupos),
         Edad = ifelse(Pacientes %in% datos$Lípidos$Pacientes,
                       edad.L, NA),
         Edad = ifelse(Pacientes %in% datos$Peroxidación$Pacientes,
                       edad.P, Edad),
         Genero = ifelse(Pacientes %in% datos$Lípidos$Pacientes,
                         sex.L, NA),
         Genero = ifelse(Pacientes %in% datos$Peroxidación$Pacientes,
                         sex.P, Genero)) %>% 
  select(-c(starts_with("Clasif"), starts_with("edad."), starts_with("sex")))
# Falta meter mRNAs

datos$MicroRNAs <- datos$MicroRNAs %>%
  rename(Clasif.M = `CLASIF FINAL`,
         sex.M = genero,
         edad.M = edad) 

datos_LP_PO_MR <- full_join(datos_LP_PO, datos$MicroRNAs, 
                            by = "Pacientes") %>% 
  arrange(Pacientes) %>% 
  mutate(Grupos = ifelse(Pacientes %in% datos_LP_PO$Pacientes,
                         Grupos, NA),
         Grupos = ifelse(Pacientes %in% datos$MicroRNAs$Pacientes, 
                         Clasif.M, Grupos),
         Grupos = ifelse(Grupos == "Otro", 0, Grupos),
         Grupos = ifelse(Grupos == "Control", 0, Grupos),
         Grupos = ifelse(Grupos == "AD", 1, Grupos),
         Grupos = as.factor(Grupos),
         Edad = ifelse(Pacientes %in% datos_LP_PO$Pacientes, 
                       Edad, NA),
         Edad = ifelse(Pacientes %in% datos$MicroRNAs$Pacientes, 
                       edad.M, Edad),
         Genero = ifelse(Pacientes %in% datos_LP_PO$Pacientes, 
                         Genero, NA),
         Genero = ifelse(Pacientes %in% datos$MicroRNAs$Pacientes, 
                         sex.M, Genero),
         Genero = as.factor(Genero)) %>% 
  select(-c(starts_with("Clasif"), starts_with("edad."), starts_with("sex")))

# View(datos_LP_PO_MR) 
num_NAS <- sum(is.na(datos_LP_PO_MR))/(ncol(datos_LP_PO_MR)*nrow(datos_LP_PO_MR))
cat("La proporción de valres faltantes del banco de datos es de", num_NAS,".\n")
```



# 1. Exploración

```{r}
tamano <- function(x, ...) {
    y <- unlist(x)
    n <- sum(!is.na(y))/2
}

table1(~ Genero + Edad|Grupos, data = datos_LP_PO_MR[,-1], 
    droplevels = F, 
    render.continuous = c(. = "Mean (SD)", . = "Median [Q1, Q3]"), 
    na.is.category = FALSE, 
    overall = "Total de pacientes", 
    extra.col = list(N = tamano), 
    render.missing = NULL, 
    extra.col.pos = c(1),
    topclass ="Rtable1-zebra",
    caption = "Tabla 1: Descriptivo numérico de las variables singulares.")
```

```{r}
names(datos$Peroxidación)[c(2,3,26)] <- c("Genero", "Edad", "Grupos")
datos2 <- select(datos_LP_PO_MR, names(datos$Peroxidación))
table1(~ .| Grupos, data = datos2[-c(1:3)], 
    droplevels = F, 
    render.continuous = c(. = "Mean (SD)", . = "Median [Q1, Q3]"), 
    na.is.category = FALSE, 
    overall = FALSE, 
    extra.col = list(N = tamano), 
    render.missing = NULL, 
    extra.col.pos = c(1),
    topclass = "Rtable1-zebra",
    caption = "Tabla 2: Descriptivo numérico de los compuestos de peroxidación.")
```


```{r, include = TRUE, fig.width = 10, fig.height = 4, fig.align = "center", fig.cap = ' '}
x <- datos2[datos2$Grupos == 0,-c(1:3, 26)]
ma <- mahalanobis(x, apply(x, 2, mean, na.rm = TRUE), cov(x, use = "na.or.complete"))
k <- dim(x)[2] # Número de variables
Lim <- k + 3 * sqrt(k * 2) # Límite distancia de Mahalanobis
# plot(ma, pch = 20, ylim = c(0, max(ma, Lim, na.rm = TRUE)))
# text(ma, rownames(x), pos = 2)
# abline(h = Lim)
# title("Distancia de Mahalanobis")

x <- x[ma < Lim,] # quito Observaciones atípicas
```

```{r, fig.height = 5, fig.width = 6}
ggplot(data = stack(x)) +
  geom_boxplot(alpha = 0.7, outlier.colour = 1, 
               aes(x = ind, y = values, fill = ind)) +
  labs(x = "Compuestos de peroxidación de lípidos", y = "nmol/L", subtitle = "No-AD") +
  theme_bw() + theme(legend.position = "none") + coord_flip(ylim = c(0,10)) 
```

```{r, include = TRUE, fig.width = 10, fig.height = 4, fig.align = "center", fig.cap = ' '}
x <- datos2[datos2$Grupos == 1,-c(1:3, 26)]
ma <- mahalanobis(x, apply(x, 2, mean, na.rm = TRUE), cov(x, use = "na.or.complete"))
k <- dim(x)[2] # Número de variables
Lim <- k + 3 * sqrt(k * 2) # Límite distancia de Mahalanobis
# plot(ma, pch = 20, ylim = c(0, max(ma, Lim, na.rm = TRUE)))
# text(ma, rownames(x), pos = 2)
# abline(h = Lim)
# title("Distancia de Mahalanobis")

x <- x[ma < Lim,] # quito Observaciones atípicas
```

```{r, fig.height= 5, fig.width=6, fig.cap="Figura 1: Diagrama de cajas de los compuestos de peroxidación de lípidos."}
ggplot(data = stack(x)) +
  geom_boxplot(alpha = 0.7, outlier.colour = 1, 
               aes(x = ind, y = values, fill = ind)) +
  labs(x = " ", y = "nmol/L", subtitle = "AD") +
  theme_bw() + theme(legend.position = "none") + coord_flip(ylim = c(0,10))
```

```{r}
names(datos$Lípidos)[c(2,3,10)] <- c("Genero", "Edad", "Grupos")
datos2 <- select(datos_LP_PO_MR, names(datos$Lípidos))
names(datos2)[-c(1:3)] <- c("18:1 LPE", "18:0 LPC", "16:1 SM", "16:0 SM", 
                            "DOPE", "18:0 SM", "Grupos")

table1(~ .|Grupos, data = datos2[-c(1:3)], 
    droplevels = F, 
    render.continuous = c(. = "Mean (SD)", . = "Median [Q1, Q3]"), 
    na.is.category = FALSE, 
    overall = FALSE, 
    extra.col = list(N = tamano), 
    render.missing = NULL, 
    extra.col.pos = c(1),
    topclass = "Rtable1-zebra",
    caption = "Tabla 3: Descriptivo numérico de los lípidos.")
```

```{r, include = TRUE, fig.width = 10, fig.height = 4, fig.align = "center", fig.cap = ' '}
x <- datos2[datos2$Grupos == 0,-c(1:3, 10)]
ma <- mahalanobis(x, apply(x, 2, mean, na.rm = TRUE), cov(x, use = "na.or.complete"))
k <- dim(x)[2] # Número de variables
Lim <- k + 3 * sqrt(k * 2) # Límite distancia de Mahalanobis
# plot(ma, pch = 20, ylim = c(0, max(ma, Lim, na.rm = TRUE)))
# text(ma, rownames(x), pos = 2)
# abline(h = Lim)
# title("Distancia de Mahalanobis")

x <- x[ma < Lim,] # quito Observaciones atípicas
```

```{r, fig.height= 5, fig.width=6}
cols <- paletteer_d("ggthemes::Green_Orange_Teal")
ggplot(data = stack(x)) +
  geom_boxplot(alpha = 0.7, outlier.colour = 1, 
               aes(x = ind, y = values, fill = ind)) +
  scale_fill_manual(values = cols[seq(7,12)]) +
  labs(x = "Lípidos", y = "μg m/L", subtitle = "No-AD") +
  theme_bw() + theme(legend.position = "none") + coord_flip(ylim = c(0,300)) 
```

```{r, include = TRUE, fig.width = 10, fig.height = 4, fig.align = "center", fig.cap = ' '}
x <- datos2[datos2$Grupos == 1,-c(1:3, 10)]
ma <- mahalanobis(x, apply(x, 2, mean, na.rm = TRUE), cov(x, use = "na.or.complete"))
k <- dim(x)[2] # Número de variables
Lim <- k + 3 * sqrt(k * 2) # Límite distancia de Mahalanobis
# plot(ma, pch = 20, ylim = c(0, max(ma, Lim, na.rm = TRUE)))
# text(ma, rownames(x), pos = 2)
# abline(h = Lim)
# title("Distancia de Mahalanobis")

x <- x[ma < Lim,] # quito Observaciones atípicas
```

```{r, fig.height= 5, fig.width=6, fig.cap="Figura 2: Diagrama de cajas de los lípidos."}
ggplot(data = stack(x)) +
  geom_boxplot(alpha = 0.7, outlier.colour = 1, 
               aes(x = ind, y = values, fill = ind)) +
  scale_fill_manual(values = cols[seq(7,12)]) +
  labs(x = " ", y = "μg m/L", subtitle = "AD") +
  theme_bw() + theme(legend.position = "none") + coord_flip(ylim = c(0,300))
```

```{r}
names(datos$MicroRNAs)[c(2,3,12)] <- c("Genero", "Edad", "Grupos")
datos2 <- select(datos_LP_PO_MR, names(datos$MicroRNAs))
names(datos2)[-c(1:3)] <- c("miR-92a-3p", "miR486-5p", "miR-29a-3p", 
                            "miR-486-3p", "miR-150-5", "miR-320b", 
                            "miR-483-3p", "miR-342-3p", "Grupos")

table1(~ .| Grupos, data = datos2[-c(1:3)], 
    droplevels = F, 
    render.continuous = c(. = "Mean (SD)", . = "Median [Q1, Q3]"), 
    na.is.category = FALSE, 
    overall = FALSE, 
    extra.col = list(N = tamano), 
    render.missing = NULL, 
    extra.col.pos = c(1),
    topclass = "Rtable1-zebra",
    caption = "Tabla 4: Descriptivo numérico de los MicroRNAs.")
```


```{r, include = TRUE, fig.width = 10, fig.height = 4, fig.align = "center", fig.cap = ' '}
x <- datos2[datos2$Grupos == 0,-c(1:3,12)]
ma <- mahalanobis(x, apply(x, 2, mean, na.rm = TRUE), cov(x, use = "na.or.complete"))
k <- dim(x)[2] # Número de variables
Lim <- k + 3 * sqrt(k * 2) # Límite distancia de Mahalanobis
# plot(ma, pch = 20, ylim = c(0, max(ma, Lim, na.rm = TRUE)))
# text(ma, rownames(x), pos = 2)
# abline(h = Lim)
# title("Distancia de Mahalanobis")

x <- x[ma < Lim,] # quito Observaciones atípicas
```

```{r, fig.height= 5, fig.width=6}
cols <- paletteer_d("ggthemes::Purple_Pink_Gray")
ggplot(data = stack(x)) +
  geom_boxplot(alpha = 0.7, outlier.colour = 1, 
               aes(x = ind, y = values, fill = ind)) +
  scale_fill_manual(values = cols) +
  labs(x = "MicroRNAs", y = "Conteos normalizados", subtitle = "No-AD") +
  theme_bw() + theme(legend.position = "none") + coord_flip(ylim = c(0,13.5)) 

```

```{r, include = TRUE, fig.width = 10, fig.height = 4, fig.align = "center", fig.cap = ' '}
x <- datos2[datos2$Grupos == 1,-c(1:3, 12)]
ma <- mahalanobis(x, apply(x, 2, mean, na.rm = TRUE), cov(x, use = "na.or.complete"))
k <- dim(x)[2] # Número de variables
Lim <- k + 3 * sqrt(k * 2) # Límite distancia de Mahalanobis
# plot(ma, pch = 20, ylim = c(0, max(ma, Lim, na.rm = TRUE)))
# text(ma, rownames(x), pos = 2)
# abline(h = Lim)
# title("Distancia de Mahalanobis")

x <- x[ma < Lim,] # quito Observaciones atípicas
```

```{r, fig.height= 5, fig.width=6, fig.cap="Diagrama de cajas de los MicroRNAs."}
ggplot(data = stack(x)) +
  geom_boxplot(alpha = 0.7, outlier.colour = 1, 
               aes(x = ind, y = values, fill = ind)) +
  scale_fill_manual(values = cols) +
  labs(x = " ", y = "Conteos normalizados", subtitle = "AD") +
  theme_bw() + theme(legend.position = "none") + coord_flip(ylim = c(0,13.5))
```

## 1.1 Tratamiento NAs

Con la librería mice. Se elige una de las bases de datos imputadas.

```{r NAs, include = TRUE, fig.width = 5, fig.height = 8, fig.align = "center", fig.cap = ' '}
df <- select(datos_LP_PO_MR, -c( "Grupos", "Edad", "Genero"))
library(naniar)
# miss_var_summary(df)
# miss_case_table(df)

# aggr(df, col = c('#1A5276','#7B241C'), numbers = TRUE, sortVars = TRUE, labels = names(df), cex.axis = .7, gap = 3, ylab = c("Histograma de datos perdidos", "Comportamiento"))
```

```{r NAs mice, include = TRUE}
# df2 <- df
# nombres <- paste0("V", seq(1,ncol(df))) # no sé por qué dan problemas los nombres
# names(df2) <- nombres
# set.seed(123)
# dimp <- mice(df2, m = 5, meth = "pmm", maxit = 50, seed = 123)
# # summary(dimp)
# df2 <- complete(dimp, 3)
# 
# names(df2) <- names(df)
# df_sin_NAs <- cbind(df2, Edad = datos_LP_PO_MR$Edad, Genero =
#                       datos_LP_PO_MR$Genero, Grupos = datos_LP_PO_MR$Grupos)
# save(df_sin_NAs, file = "./data/df_sin_NA.Rdata")
load("./data/df_sin_NA.Rdata")
# summary(df_sin_NAs)
```

## 1.2 Estudio correlaciones

```{r grupos}
df_sin_NAs_P <- select(df_sin_NAs,
                       names(datos$Peroxidación)[-c(1:3, ncol(datos$Peroxidación))])
df_sin_NAs_L <- select(df_sin_NAs, names(datos$Lípidos)[-c(1:3, ncol(datos$Lípidos))])
df_sin_NAs_M <- select(df_sin_NAs, names(datos$MicroRNAs)[-c(1:3, ncol(datos$MicroRNAs))])

df_sin_NAs2 <- select(df_sin_NAs, -c("Pacientes", "Edad", "Genero", "Grupos"))

library(corrplot)
library(Hmisc)
matcor <- cor(df_sin_NAs2)
pmat <- round(rcorr(as.matrix(df_sin_NAs2))$ P, 3)

library(kableExtra)
```



```{r, fig.width = 15, fig.height = 10, fig.align = "center", fig.cap = 'Figura 1: ', eval = FALSE}
kable(round(matcor,3),
    caption = " Tabla 4: Matriz de correlaciones para las variables de interés del banco de datos.") %>%
  kable_styling(font_size = 9, full_width = FALSE) %>%
  column_spec(1, bold = TRUE) %>% row_spec(0, monospace = TRUE, angle = -45, bold = TRUE)
kable(pmat,
    caption = "Tabla 5: Matriz de p-valores asociados a los coeficientes de correlación de las variables de interés del banco de datos.") %>%
  kable_styling(font_size = 9, full_width = FALSE)%>%
  column_spec(1, bold = TRUE) %>% row_spec(0, monospace = TRUE, angle = -45, bold = TRUE)
# Gigante, no se entiende nada
```

### Compuestos de peroxidación

```{r, fig.width = 15, fig.height = 10, fig.align = "center", fig.cap = 'Figura 1: ', eval = FALSE}
matcor <- cor(df_sin_NAs_P)
pmat <- round(rcorr(as.matrix(df_sin_NAs_P))$ P, 3)

kable(round(matcor,3),
    caption = " Tabla 6: Matriz de correlaciones para las variables de interés del banco de datos.") %>%
  kable_styling(font_size = 9, full_width = FALSE) %>%
  column_spec(1, bold = TRUE) %>% row_spec(0, monospace = TRUE, angle = -45, bold = TRUE)
kable(pmat,
    caption = "Tabla 7: Matriz de p-valores asociados a los coeficientes de correlación de las variables de interés del banco de datos.") %>%
  kable_styling(font_size = 9, full_width = FALSE)%>%
  column_spec(1, bold = TRUE) %>% row_spec(0, monospace = TRUE, angle = -45, bold = TRUE)
```

```{r, fig.width = 16, fig.height = 12, fig.align = "center", fig.cap = 'Figura 4: Representación gráfica de la matriz de correlación de los compuestos de peroxidación.'}
matcor <- cor(df_sin_NAs_P)
corrplot(matcor, method = "ellipse", type = "lower", tl.pos = 'lt', diag = T, 
         tl.col = "black", tl.srt = 45, cl.pos = "n")
corrplot(matcor, method = "number", type = "upper", tl.pos = 'n', diag = FALSE, add = T)
```

### Lípidos

```{r, fig.width = 15, fig.height = 10, fig.align = "center", fig.cap = 'Figura 1: ', eval = FALSE}
matcor <- cor(df_sin_NAs_L)
pmat <- round(rcorr(as.matrix(df_sin_NAs_L))$ P, 3)

kable(round(matcor,3),
    caption = " Tabla 7: Matriz de correlaciones para las variables de interés del banco de datos.") %>%
  kable_styling(font_size = 9, full_width = FALSE) %>%
  column_spec(1, bold = TRUE) %>% row_spec(0, monospace = TRUE, angle = -45, bold = TRUE)
kable(pmat,
    caption = "Tabla 8: Matriz de p-valores asociados a los coeficientes de correlación de las variables de interés del banco de datos.") %>%
  kable_styling(font_size = 9, full_width = FALSE)%>%
  column_spec(1, bold = TRUE) %>% row_spec(0, monospace = TRUE, angle = -45, bold = TRUE)
```

```{r, fig.width = 5, fig.height = 4, fig.align = "center", fig.cap = 'Figura 5: Representación gráfica de la matriz de correlación de los lípidos.'}
datos2 <- df_sin_NAs_L
names(datos2) <- c("18:1 LPE", "18:0 LPC", "16:1 SM", "16:0 SM", 
                            "DOPE", "18:0 SM")
matcor <- cor(datos2)
corrplot(matcor, method = "ellipse", type = "lower", tl.pos = 'lt', diag = T, 
         tl.col = "black", tl.srt = 45, cl.pos = "n")
corrplot(matcor, method = "number", type = "upper", tl.pos = 'n', diag = FALSE, add = T)
```

### MicroRNAs

```{r, fig.width = 15, fig.height = 10, fig.align = "center", fig.cap = 'Figura 1: ', eval = FALSE}
matcor <- cor(df_sin_NAs_M)
pmat <- round(rcorr(as.matrix(df_sin_NAs_M))$ P, 3)

kable(round(matcor,3),
    caption = " Tabla 9: Matriz de correlaciones para las variables de interés del banco de datos.") %>%
  kable_styling(font_size = 9, full_width = FALSE) %>%
  column_spec(1, bold = TRUE) %>% row_spec(0, monospace = TRUE, angle = -45, bold = TRUE)
kable(pmat,
    caption = "Tabla 10: Matriz de p-valores asociados a los coeficientes de correlación de las variables de interés del banco de datos.") %>%
  kable_styling(font_size = 9, full_width = FALSE)%>%
  column_spec(1, bold = TRUE) %>% row_spec(0, monospace = TRUE, angle = -45, bold = TRUE)
```

```{r, fig.width = 6, fig.height = 5, fig.align = "center", fig.cap = 'Figura 6: Representación gráfica de la matriz de correlación de los microRNAs.'}
datos2 <- df_sin_NAs_M
names(datos2) <- c("miR-92a-3p", "miR486-5p", "miR-29a-3p", 
                            "miR-486-3p", "miR-150-5", "miR-320b", 
                            "miR-483-3p", "miR-342-3p")
matcor <- cor(datos2)
corrplot(matcor, method = "ellipse", type = "lower", tl.pos = 'lt', diag = T, 
         tl.col = "black", tl.srt = 45, cl.pos = "n")
corrplot(matcor, method = "number", type = "upper", tl.pos = 'n', diag = FALSE, add = T)
```


# 2 Selección de variables bayesiana

## 2.1 Selección de variables con BAS

```{r bas, include = TRUE}
formula <- Grupos ~ .

# Estandarizo las variables 
df_sin_NAs2 <- scale(as.matrix(df_sin_NAs[,-c(1, 39:40)]), center = TRUE, scale = TRUE)
df_sin_NAs2 <- data.frame(df_sin_NAs2)
names(df_sin_NAs2) <- names(df_sin_NAs)[2:38]

df_sin_NAs2$Genero <- df_sin_NAs$Genero
df_sin_NAs2$Grupos <- df_sin_NAs$Grupos

# bas_sel <- bas.glm(formula,
#                      data = df_sin_NAs2,
#                      family = binomial(link = "logit"),
#                      betaprior = robust(),
#                      method = "BAS",
#                     laplace = TRUE)
# 
# save(bas_sel, file = "./resultados_alzheimer/bas_sel.Rdata")
load("./resultados_alzheimer/bas_sel.Rdata")

kable(summary(bas_sel)[,-c(5:6)], caption = "Probabilidades de inclusión a posteriori de las variables obtenidas con BAS.") %>%
  kable_paper()
```

## 2.2 Selección de variables considerando la presencia de grupos

```{r, include = TRUE}
source("GibbsSampling.R")

df_sin_NAs2$Genero <- ifelse(df_sin_NAs$Genero == "M", 1, 0) # F categoría de referencia
df_sin_NAs2$Grupos <- ifelse(df_sin_NAs$Grupos == "1", 1, 0) # 0 categoría de referencia

names(datos$Peroxidación)[c(4,6:11,14,15,17:25)] <- 
  paste0("`", names(datos$Peroxidación)[c(4,6:11,14,15,17:25)], "`")

names(datos$Lípidos)[c(4:7,9)] <- 
  paste0("`", names(datos$Lípidos)[c(4:7,9)], "`")

names(datos$MicroRNAs)[c(4:11)] <- 
  paste0("`", names(datos$MicroRNAs)[c(4:11)], "`")

groups <- list(peroxidation = names(datos$Peroxidación)[-c(1:3,26)], 
               lipids = names(datos$Lípidos)[-c(1:3,10)], 
               microRNAs = names(datos$MicroRNAs)[-c(1:3,12)])

formula = Grupos ~ .
previas <- c("SBSB", "SBConst", "SB")
# gSBSB <- GS(formula,
#           df_sin_NAs2,
#           groups = groups,
#           prior.betas = "Robust",
#           prior.models = previas[1],
#           n.iter = 1000,
#           init.model = "Full",
#           n.burnin = 100,
#           n.thin = 1)
# save(gSBSB, file = "./resultados_alzheimer/gSBSB.Rdata")
load("./resultados_alzheimer/gSBSB.Rdata")

kable(gSBSB$inclprob, caption = "Probabilidades de inclusión de los grupos, variables agrupadas y singulares obtenidas con SB-SB.") %>%
  kable_paper()
```

```{r, fig.width = 15, fig.height = 10, fig.align = "center", fig.cap = ' '}
# gSBC <- GS(formula,
#           df_sin_NAs2,
#           groups = groups,
#           prior.betas = "Robust",
#           prior.models = previas[2],
#           n.iter = 1000,
#           init.model = "Full",
#           n.burnin = 100,
#           n.thin = 1)
# save(gSBC, file = "./resultados_alzheimer/gSBC.Rdata")
load("./resultados_alzheimer/gSBC.Rdata")

kable(gSBC$inclprob, caption = "Probabilidades de inclusión de los grupos, variables agrupadas y singulares obtenidas con SB-Const.") %>%
  kable_paper()
```

### Sin considerar la estructura de grupo: previa SB

```{r plotdisp, include = TRUE, fig.width = 12, fig.height = 12, fig.align = "center", fig.cap = ' '}
# gSB <- GS(formula,
#           df_sin_NAs2,
#           groups = groups,
#           prior.betas = "Robust",
#           prior.models = previas[3],
#           n.iter = 1000,
#           init.model = "Full",
#           n.burnin = 100,
#           n.thin = 1)
# save(gSB, file = "./resultados_alzheimer/gSB.Rdata")
load("./resultados_alzheimer/gSB.Rdata")

kable(gSB$inclprob, caption = "Probabilidades de inclusión de los grupos, variables agrupadas y singulares obtenidas con SB.") %>%
  kable_paper()
```

```{r, include = TRUE, fig.width = 8, fig.height = 5, fig.align = "center", fig.cap = ' ', eval = FALSE}
## Con el nulo como modelo inicial (no cambia nada)

# gSBSB <- GS(formula,
#           df_sin_NAs2,
#           groups = groups,
#           prior.betas = "Robust",
#           prior.models = previas[1],
#           n.iter = 1000,
#           init.model = "Null",
#           n.burnin = 100,
#           n.thin = 1)
# save(gSBSB, file = "./resultados_alzheimer/gSBSB2.Rdata")
load("./resultados_alzheimer/gSBSB2.Rdata")

kable(gSBSB$inclprob, caption = "Probabilidades de inclusión de los grupos, variables agrupadas y singulares obtenidas con SB-SB.") %>%
  kable_paper()
```

```{r, include = TRUE, fig.width = 8, fig.height = 5, fig.align = "center", fig.cap = ' ', eval = FALSE}
# gSBC <- GS(formula,
#           df_sin_NAs2,
#           groups = groups,
#           prior.betas = "Robust",
#           prior.models = previas[2],
#           n.iter = 1000,
#           init.model = "Null",
#           n.burnin = 100,
#           n.thin = 1)
# save(gSBC, file = "./resultados_alzheimer/gSBC2.Rdata")
load("./resultados_alzheimer/gSBC2.Rdata")

kable(gSBC$inclprob, caption = "Probabilidades de inclusión de los grupos, variables agrupadas y singulares obtenidas con SB-Const.") %>%
  kable_paper()
```

```{r , include = TRUE, fig.width = 8, fig.height = 5, fig.align = "center", fig.cap = ' ', eval = FALSE}
# gSB <- GS(formula,
#           df_sin_NAs2,
#           groups = groups,
#           prior.betas = "Robust",
#           prior.models = previas[3],
#           n.iter = 1000,
#           init.model = "Null",
#           n.burnin = 100,
#           n.thin = 1)
# save(gSB, file = "./resultados_alzheimer/gSB2.Rdata")
load("./resultados_alzheimer/gSB2.Rdata")

kable(gSB$inclprob, caption = "Probabilidades de inclusión de los grupos, variables agrupadas y singulares obtenidas con SB.") %>%
  kable_paper()
```
 
### Quitando NAs

Se han imputado muchos datos, veamos si con los datos originales eliminando los individuos con algún NA se obtiene lo mismo.

```{r, include = TRUE}
datos <- read_excel_allsheets("./data/original-data/20221128_BBDD_COMPLETA_FIS 2019_bioestadistica_UV_2.xlsx")

datos_LP_PO2 <- na.omit(datos_LP_PO)
datos_LP_PO2 <- scale(as.matrix(datos_LP_PO2[,-c(1, 30,32)]), center = TRUE, scale = TRUE)
datos_LP_PO2 <- data.frame(datos_LP_PO2)
names(datos_LP_PO2) <- names(datos_LP_PO)[-c(1,30,32)]
datos_LP_PO2$Genero <- ifelse(na.omit(datos_LP_PO)$Genero == "M", 1, 0) # F categoría de referencia
datos_LP_PO2$Grupos <- ifelse(na.omit(datos_LP_PO)$Grupos == "AD", 1, 0) # 0 categoría de referencia


names(datos$Peroxidación)[c(4,6:11,14,15,17:25)] <-
  paste0("`", names(datos$Peroxidación)[c(4,6:11,14,15,17:25)], "`")

names(datos$Lípidos)[c(4:7,9)] <-
  paste0("`", names(datos$Lípidos)[c(4:7,9)], "`")

names(datos$MicroRNAs)[c(4:11)] <-
  paste0("`", names(datos$MicroRNAs)[c(4:11)], "`")

groups <- list(peroxidation = names(datos$Peroxidación)[-c(1:3,26)], 
               lipids = names(datos$Lípidos)[-c(1:3,10)]) 
               # microRNAs = names(datos$MicroRNAs)[-c(1:3,12)])

formula <- Grupos ~ .
previas <- c("SBSB", "SBConst", "SB")
# gSBSB <- GS(formula,
#           datos_LP_PO2,
#           groups = groups,
#           prior.betas = "Robust",
#           prior.models = previas[1],
#           n.iter = 1000,
#           init.model = "Full",
#           n.burnin = 100,
#           n.thin = 1)
# save(gSBSB, file = "./resultados_alzheimer/na.omit/gSBSB.Rdata")
load("./resultados_alzheimer/na.omit/gSBSB.Rdata")

kable(gSBSB$inclprob, caption = "Probabilidades de inclusión de los grupos, variables agrupadas y singulares obtenidas con SB-SB.") %>%
  kable_paper()

# gSBC <- GS(formula,
#           datos_LP_PO2,
#           groups = groups,
#           prior.betas = "Robust",
#           prior.models = previas[2],
#           n.iter = 1000,
#           init.model = "Full",
#           n.burnin = 100,
#           n.thin = 1)
# save(gSBC, file = "./resultados_alzheimer/na.omit/gSBC.Rdata")
load("./resultados_alzheimer/na.omit/gSBC.Rdata")

kable(gSBC$inclprob, caption = "Probabilidades de inclusión de los grupos, variables agrupadas y singulares obtenidas con SB-Const.") %>%
  kable_paper()

# gSB <- GS(formula,
#           datos_LP_PO2,
#           groups = groups,
#           prior.betas = "Robust",
#           prior.models = previas[3],
#           n.iter = 1000,
#           init.model = "Full",
#           n.burnin = 100,
#           n.thin = 1)
# save(gSB, file = "./resultados_alzheimer/na.omit/gSB.Rdata")
# load("./resultados_alzheimer/na.omit/gSB.Rdata")

kable(gSB$inclprob, caption = "Probabilidades de inclusión de los grupos, variables agrupadas y singulares obtenidas con SB.") %>%
  kable_paper()
```
 