---
title: "Experimentos TFM"
author: "Carolina Mulet"
date: "2024-06-04"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE)
```

```{r, include=FALSE}
library(dplyr)
library(ggplot2)
library(paletteer)
library(kableExtra)
library(stringr)
library(grpreg)
"%notin%" <- function(x, table) match(x, table, nomatch = 0) == 0
```


# Experimento 1

Quiero ver qué pasa cuando aumento el número de grupos falsos, manteniendo el mismo número de variables en cada grupo (4). Los datos los genero con:

$\theta = 1 + \beta_1X_1+\beta_2X_2$, $\pi=\frac{e^{\theta}}{1 + e^{\theta}}$ e $Y\sim Ber(\pi)$.

Y luego añado 2 grupos falsos más, con el mismo número de variables, a los datos que le paso al método de selección.

Con $\beta_1=(-0.6, -0.56, -0.53, 0.49)$ y $\beta_2=(-0.45, 0.4, 0.35, 0.3)$.

### Grupos

En general:

```{r, fig.width = 6, fig.height = 4, fig.align = "center", fig.cap = ' '}
# Los resultados son: una lista para cada iteración del bucle y luego una lista
# para cada previa considerada: CC, SBC, SBSB y SB, en ese orden.
p <- c(3, 5, 7)
probs <- c()
method <- c()
for (i in 1:10) {
  load(paste0("./Resultados_simulados/E1/resultado1.", i, ".Rdata"))
  load(paste0("./Resultados_simulados/E1/resultado2.", i, ".Rdata"))
  load(paste0("./Resultados_simulados/E1/resultado3.", i, ".Rdata"))
  load(paste0("./Resultados_simulados/E1/resultado1.", i, "SB.Rdata"))
  load(paste0("./Resultados_simulados/E1/resultado2.", i, "SB.Rdata"))
  load(paste0("./Resultados_simulados/E1/resultado3.", i, "SB.Rdata"))
  
  probs <- c(probs,
             resultado1[[1]]$inclprob[,1][resultado1[[1]]$inclprob[,1] != "-"], # CC
             resultado1[[2]]$inclprob[,1][resultado1[[2]]$inclprob[,1] != "-"], # SBC
             resultado1[[3]]$inclprob[,1][resultado1[[3]]$inclprob[,1] != "-"], # SBSB
             resultado1SB[[1]]$inclprob[,1][resultado1SB[[1]]$inclprob[,1] != "-"], # SB
             resultado2[[1]]$inclprob[,1][resultado2[[1]]$inclprob[,1] != "-"], 
             resultado2[[2]]$inclprob[,1][resultado2[[2]]$inclprob[,1] != "-"],
             resultado2[[3]]$inclprob[,1][resultado2[[3]]$inclprob[,1] != "-"],
             resultado2SB[[1]]$inclprob[,1][resultado2SB[[1]]$inclprob[,1] != "-"],
             resultado3[[1]]$inclprob[,1][resultado3[[1]]$inclprob[,1] != "-"],
             resultado3[[2]]$inclprob[,1][resultado3[[2]]$inclprob[,1] != "-"],
             resultado3[[3]]$inclprob[,1][resultado3[[3]]$inclprob[,1] != "-"],
             resultado3SB[[1]]$inclprob[,1][resultado3SB[[1]]$inclprob[,1] != "-"])
  
  for (j in 1:3) {
    method <- c(method,
                rep("Const-Const", p[j]), rep("SB-Const", p[j]), 
                rep("SB-SB", p[j]), rep("SB", p[j]))
  }
}

pr <- paste0("p=", rep(c(rep(p[1],p[1]*4), rep(p[2],p[2]*4),
                         rep(p[3],p[3]*4)), 10)) # Número de grupos

q <- c(rep(c(rep(c(rep("true",2), rep("false", (p[1] - 2))),4), 
             rep(c(rep("true",2), rep("false", (p[2] - 2))),4), 
             rep(c(rep("true",2), rep("false", (p[3] - 2))),4)), 10)) # V/F

Grupos <- rep(c(rep(c("G1", "G2", "G3"),4), 
                rep(c("G1", "G2", "G3", "G4", "G5"),4), 
                rep(c("G1", "G2", "G3", "G4", "G5", "G6", "G7"),4)), 10) 

probs <- as.numeric(probs)
method <- factor(method, levels = c("SB", "Const-Const", "SB-Const", "SB-SB"))
pr <- factor(pr)
q <- factor(q)
Grupos <- factor(Grupos)

exp1 <- data.frame(pr, probs, q, method, Grupos)
ggplot(exp1, aes(x = pr, y = probs, color = q)) +
  geom_point(shape = 21, size = 1, stroke = 1) +
  geom_hline(yintercept = 0.5, linetype = 2, color = 8, alpha = 0.5, size = 1) + 
  labs(x = "Número de grupos", y = "Probabilidad inclusión a posteriori") + 
  theme_bw() + theme(legend.position = "none") + 
  facet_wrap(~ method, ncol = 4) + coord_cartesian(ylim = c(0, 1))
```

En función del número de grupos:

```{r, fig.width = 6, fig.height = 4, fig.align = "center", fig.cap = ' '}
cols <- paletteer_d("ggthemes::Green_Orange_Teal")
ggplot(data = exp1[exp1$pr == "p=3",], aes(x = Grupos, y = probs, fill = Grupos)) +
  geom_boxplot(alpha = 0.8, colour = "#474747", outlier.colour = 1) +
  scale_fill_manual(values = cols) +
  geom_hline(yintercept = 0.5, linetype = 2, color = 8, alpha = 0.5, size = 1) + 
  labs(x = "3 grupos", y = "Probabilidad inclusión a posteriori") + 
  theme_bw() + 
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank()) +
  facet_wrap(~ method, ncol = 4) + coord_cartesian(ylim = c(0, 1))

ggplot(data = exp1[exp1$pr == "p=5",], aes(x = Grupos, y = probs, fill = Grupos)) +
  geom_boxplot(alpha = 0.8, colour = "#474747", outlier.colour = 1) +
  scale_fill_manual(values = cols) +
  geom_hline(yintercept = 0.5, linetype = 2, color = 8, alpha = 0.5, size = 1) + 
  labs(x = "5 grupos", y = "Probabilidad inclusión a posteriori") + 
  theme_bw() + 
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank()) +
  facet_wrap(~ method, ncol = 4) + coord_cartesian(ylim = c(0, 1))

ggplot(data = exp1[exp1$pr == "p=7",], aes(x = Grupos, y = probs, fill = Grupos)) +
  geom_boxplot(alpha = 0.8, colour = "#474747", outlier.colour = 1) +
  scale_fill_manual(values = cols) +
  geom_hline(yintercept = 0.5, linetype = 2, color = 8, alpha = 0.5, size = 1) + 
  labs(x = "7 grupos", y = "Probabilidad inclusión a posteriori") + 
  theme_bw()  + 
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank()) +
  facet_wrap(~ method, ncol = 4) + coord_cartesian(ylim = c(0, 1))
  
```

Porcentaje de grupos incorrectos:

```{r}
# Calculamos los grupos incorrectamente seleccionados
previas <- c("SB", "Const-Const", "SB-Const", "SB-SB")
matriz <- c()
for (j in 1:length(previas)) {
  matriz <- c(matriz, 
              nrow(exp1[exp1[,3] == "false" & exp1[,2] > 0.5 & 
                exp1$method == previas[j] & exp1$pr == "p=3",])/(1*10)*100,
              nrow(exp1[exp1[,3] == "false" & exp1[,2] > 0.5 & 
                exp1$method == previas[j] & exp1$pr == "p=5",])/(3*10)*100,
              nrow(exp1[exp1[,3] == "false" & exp1[,2] > 0.5 & 
                exp1$method == previas[j] & exp1$pr == "p=7",])/(5*10)*100)
}
matriz <- paste0(matriz, "%")
matriz <- matrix(matriz, ncol = 4)
rownames(matriz) <- c(unique(exp1$pr))
colnames(matriz) <- previas
kable(matriz, caption = "Porcentaje de grupos incorrectamente seleccionados 
      para cada previa elegida.") %>%
  kable_styling()

# Calculamos los grupos incorrectamente no seleccionados
matriz <- c()
for (j in 1:length(previas)) {
  matriz <- c(matriz, 
              nrow(exp1[exp1[,3] == "true" & exp1[,2] < 0.5 & 
                exp1$method == previas[j] & exp1$pr == "p=3",])/(2*10)*100,
              nrow(exp1[exp1[,3] == "true" & exp1[,2] < 0.5 & 
                exp1$method == previas[j] & exp1$pr == "p=5",])/(2*10)*100,
              nrow(exp1[exp1[,3] == "true" & exp1[,2] < 0.5 & 
                exp1$method == previas[j] & exp1$pr == "p=7",])/(2*10)*100)
}
matriz <- paste0(matriz, "%")
matriz <- matrix(matriz, ncol = 4)
rownames(matriz) <- c(unique(exp1$pr))
colnames(matriz) <- previas
kable(matriz, caption = "Porcentaje de grupos incorrectamente no seleccionados 
      para cada previa elegida.") %>%
  kable_styling()
```

### Variables agrupadas verdaderas (de G1 y G2)
 
 En general:

```{r, fig.width = 6, fig.height = 4, fig.align = "center", fig.cap = ' ', results='hide'}
p <- c(3, 5, 7)
probs <- c()
method <- c()
for (i in 1:10) {
  load(paste0("./Resultados_simulados/E1/resultado1.", i, ".Rdata"))
  load(paste0("./Resultados_simulados/E1/resultado2.", i, ".Rdata"))
  load(paste0("./Resultados_simulados/E1/resultado3.", i, ".Rdata"))
  load(paste0("./Resultados_simulados/E1/resultado1.", i, "SB.Rdata"))
  load(paste0("./Resultados_simulados/E1/resultado2.", i, "SB.Rdata"))
  load(paste0("./Resultados_simulados/E1/resultado3.", i, "SB.Rdata"))
  
  probs <- c(probs,
             resultado1[[1]]$inclprob[,2][c(2:5,7:10)], # CC
             resultado1[[2]]$inclprob[,2][c(2:5,7:10)], # SBC
             resultado1[[3]]$inclprob[,2][c(2:5,7:10)], # SBSB
             resultado1SB[[1]]$inclprob[,2][c(2:5,7:10)], # SB
             resultado2[[1]]$inclprob[,2][c(2:5,7:10)],
             resultado2[[2]]$inclprob[,2][c(2:5,7:10)],
             resultado2[[3]]$inclprob[,2][c(2:5,7:10)],
             resultado2SB[[1]]$inclprob[,2][c(2:5,7:10)],
             resultado3[[1]]$inclprob[,2][c(2:5,7:10)],
             resultado3[[2]]$inclprob[,2][c(2:5,7:10)],
             resultado3[[3]]$inclprob[,2][c(2:5,7:10)],
             resultado3SB[[1]]$inclprob[,2][c(2:5,7:10)])
  
  method <- c(method,
              rep(c(rep("Const-Const", 8), rep("SB-Const", 8), 
                    rep("SB-SB", 8), rep("SB", 8)), 3))
}

pr <- paste0("p=", rep(c(rep(p[1], 8*4), rep(p[2], 8*4), 
                         rep(p[3], 8*4)), 10)) # Número de grupos
Vars <- rep(c(paste0("1.", 1:4), paste0("2.", 1:4)), 4*3*10)
Grupos <- paste0("G", rep(c(rep(1, 4), rep(2,4)), 4*3*10))

probs <- as.numeric(probs)
method <- factor(method, levels = c("SB", "Const-Const", "SB-Const", "SB-SB"))
pr <- factor(pr)
Vars <- factor(Vars)
Grupos <- factor(Grupos)

exp1vars <- data.frame(pr, probs, method, Vars, Grupos)
# ggplot(exp1vars, aes(x = pr, y = probs, colour = probs)) +
#   geom_point(shape = 21, size = 1, stroke = 1) +
#   geom_hline(yintercept = 0.5, linetype = 2, color = 8, alpha = 0.5, size = 1) +
#   labs(x = "Número de grupos", y = "Probabilidad inclusión a posteriori") +
#   theme_bw() + theme(legend.position = "none") + #+ coord_cartesian(ylim = c(0, 1))
#   facet_wrap(~ method, ncol = 4) +
#   scale_colour_gradient2(low="red",
#                          high="lightblue",
#                          mid="orange",
#                          midpoint=0.5) + 
#   coord_cartesian(ylim = c(0, 1))
```

```{r, fig.width = 6, fig.height = 4, fig.align = "center", fig.cap = ' '}
cols <- paletteer_d("ggpomological::pomological_palette")
ggplot(data = exp1vars, aes(x = pr, y = probs, fill = method)) +
  geom_boxplot(alpha = 0.7, outlier.colour = 1) +
  scale_fill_manual(values = cols[c(1,3,4,2)]) +
  geom_hline(yintercept = 0.5, linetype = 2, color = 8, alpha = 0.5, linewidth = 1) +
  labs(x = "Número de grupos", y = "Probabilidad inclusión a posteriori") +
  theme_bw() +
  guides(fill = guide_legend(title = "Previas")) 
```

En función del número de grupos:

```{r, fig.width = 10, fig.height = 6, fig.align = "center", fig.cap = ' '}
cols <- paletteer_d("colorBlindness::Blue2DarkOrange12Steps")[-c(5,6)]
ggplot(data = exp1vars[exp1vars$pr == "p=3",], aes(x = Vars, y = probs, fill = Vars)) +
  geom_boxplot(alpha = 0.8, colour = "#474747", outlier.colour = 1) +
  scale_fill_manual(values = cols) +
  geom_hline(yintercept = 0.5, linetype = 2, color = 8, alpha = 0.5, size = 1) + 
  labs(x = "3 grupos", y = "Probabilidad inclusión a posteriori") + 
  theme_bw() + 
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank()) +
  facet_wrap(~ method, ncol = 4) + coord_cartesian(ylim = c(0, 1))

ggplot(data = exp1vars[exp1vars$pr == "p=5",], aes(x = Vars, y = probs, fill = Vars)) +
  geom_boxplot(alpha = 0.8, colour = "#474747", outlier.colour = 1) +
  scale_fill_manual(values = cols) +
  geom_hline(yintercept = 0.5, linetype = 2, color = 8, alpha = 0.5, size = 1) + 
  labs(x = "5 grupos", y = "Probabilidad inclusión a posteriori") + 
  theme_bw() + 
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank()) +
  facet_wrap(~ method, ncol = 4) + coord_cartesian(ylim = c(0, 1))

ggplot(data = exp1vars[exp1vars$pr == "p=7",], aes(x = Vars, y = probs, fill = Vars)) +
  geom_boxplot(alpha = 0.8, colour = "#474747", outlier.colour = 1) +
  scale_fill_manual(values = cols) +
  geom_hline(yintercept = 0.5, linetype = 2, color = 8, alpha = 0.5, size = 1) + 
  labs(x = "7 grupos", y = "Probabilidad inclusión a posteriori") + 
  theme_bw() + 
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank()) +
  facet_wrap(~ method, ncol = 4) + coord_cartesian(ylim = c(0, 1))
  
```

Variables agrupadas incorrectamente no seleccionadas de los 2 primeros grupos:

```{r}
previas <- c("SB", "Const-Const", "SB-Const", "SB-SB")
# SB
matriz <- c()
for (j in 1:2) {
  matriz <- c(matriz, 
              nrow(exp1vars[ exp1vars[,2] < 0.5 & exp1vars$Grupos == paste0("G",j) &
                exp1vars$method == previas[1] & exp1vars$pr=="p=3",])/(4*10)*100,
              nrow(exp1vars[ exp1vars[,2] < 0.5 & exp1vars$Grupos == paste0("G",j) &
                exp1vars$method == previas[1] & exp1vars$pr=="p=5",])/(4*10)*100,
              nrow(exp1vars[ exp1vars[,2] < 0.5 & exp1vars$Grupos == paste0("G",j) &
                exp1vars$method == previas[1] & exp1vars$pr=="p=7",])/(4*10)*100)
}
matriz <- paste0(matriz, "%")
matriz <- matrix(matriz, ncol = 2)
rownames(matriz) <- c(unique(exp1$pr))
colnames(matriz) <- paste0("G", 1:2)
kable(matriz, caption = "Porcentaje de variables agrupadas incorrectamente no seleccionadas para SB.") %>%
  kable_styling()

# Const-Const
matriz <- c()
for (j in 1:2) {
  matriz <- c(matriz, 
              nrow(exp1vars[ exp1vars[,2] < 0.5 & exp1vars$Grupos == paste0("G",j) &
                exp1vars$method == previas[2] & exp1vars$pr=="p=3",])/(4*10)*100,
              nrow(exp1vars[ exp1vars[,2] < 0.5 & exp1vars$Grupos == paste0("G",j) &
                exp1vars$method == previas[2] & exp1vars$pr=="p=5",])/(4*10)*100,
              nrow(exp1vars[ exp1vars[,2] < 0.5 & exp1vars$Grupos == paste0("G",j) &
                exp1vars$method == previas[2] & exp1vars$pr=="p=7",])/(4*10)*100)
}
matriz <- paste0(matriz, "%")
matriz <- matrix(matriz, ncol = 2)
rownames(matriz) <- c(unique(exp1$pr))
colnames(matriz) <- paste0("G", 1:2)
kable(matriz, caption = "Porcentaje de variables agrupadas incorrectamente no seleccionadas para Const-Const.") %>%
  kable_styling()

# SB-Const
matriz <- c()
for (j in 1:2) {
  matriz <- c(matriz, 
              nrow(exp1vars[ exp1vars[,2] < 0.5 & exp1vars$Grupos == paste0("G",j) &
                exp1vars$method == previas[3] & exp1vars$pr=="p=3",])/(4*10)*100,
              nrow(exp1vars[ exp1vars[,2] < 0.5 & exp1vars$Grupos == paste0("G",j) &
                exp1vars$method == previas[3] & exp1vars$pr=="p=5",])/(4*10)*100,
              nrow(exp1vars[ exp1vars[,2] < 0.5 & exp1vars$Grupos == paste0("G",j) &
                exp1vars$method == previas[3] & exp1vars$pr=="p=7",])/(4*10)*100)
}
matriz <- paste0(matriz, "%")
matriz <- matrix(matriz, ncol = 2)
rownames(matriz) <- c(unique(exp1$pr))
colnames(matriz) <- paste0("G", 1:2)
kable(matriz, caption = "Porcentaje de variables agrupadas incorrectamente no seleccionadas para SB-Const.") %>%
  kable_styling()

# SB-SB
matriz <- c()
for (j in 1:2) {
  matriz <- c(matriz, 
              nrow(exp1vars[ exp1vars[,2] < 0.5 & exp1vars$Grupos == paste0("G",j) &
                exp1vars$method == previas[4] & exp1vars$pr=="p=3",])/(4*10)*100,
              nrow(exp1vars[ exp1vars[,2] < 0.5 & exp1vars$Grupos == paste0("G",j) &
                exp1vars$method == previas[4] & exp1vars$pr=="p=5",])/(4*10)*100,
              nrow(exp1vars[ exp1vars[,2] < 0.5 & exp1vars$Grupos == paste0("G",j) &
                exp1vars$method == previas[4] & exp1vars$pr=="p=7",])/(4*10)*100)
}
matriz <- paste0(matriz, "%")
matriz <- matrix(matriz, ncol = 2)
rownames(matriz) <- c(unique(exp1$pr))
colnames(matriz) <- paste0("G", 1:2)
kable(matriz, caption = "Porcentaje de variables agrupadas incorrectamente no seleccionadas para SB-SB.") %>%
  kable_styling()
```

# Experimento 2.1: Añadir 3, 8 y 13 variables agrupadas falsas

Quiero ver qué pasa cuando aumento el número de variables falsas en cada grupo, manteniendo el mismo número de grupos, 4.
Los datos los genero con:

$\theta = 1 + \beta_1X_1$, $\pi=\frac{e^{\theta}}{1 + e^{\theta}}$ e $Y\sim Ber(\pi)$.

El primer grupo solo con las dos primeras variables verdaderas.
Y luego añado 3 grupos falsos más. Lo hago con 5, 10 y 15 variables cada uno.

Con $\beta_{11} = 0.56$ y $\beta_{12} = 0.49$.

### Grupos

  En general:

```{r, fig.width = 6, fig.height = 4, fig.align = "center", fig.cap = ' ', results='hide'}
# l = 5
load("./Resultados_simulados/E2/resultado4.1.Rdata")
load("./Resultados_simulados/E2/resultado4.1SB.Rdata")
# l = 10
load("./Resultados_simulados/E2/resultado4.2.Rdata")
load("./Resultados_simulados/E2/resultado4.2SB.Rdata")
# l = 15
load("./Resultados_simulados/E2/resultado4.3.Rdata")
load("./Resultados_simulados/E2/resultado4.3SB.Rdata")

# Primer banco de datos
probs <- c(resultado4.1[[1]]$inclprob[resultado4.1[[1]]$inclprob[,1] != "-", 1], # CC
           resultado4.1[[2]]$inclprob[resultado4.1[[2]]$inclprob[,1] != "-", 1], # SBC
           resultado4.1[[3]]$inclprob[resultado4.1[[3]]$inclprob[,1] != "-", 1], # SBSB
           resultado4.1SB[[1]]$inclprob[resultado4.1SB[[1]]$inclprob[,1] != "-", 1], # SB
           resultado4.2[[1]]$inclprob[resultado4.2[[1]]$inclprob[,1] != "-", 1],
           resultado4.2[[2]]$inclprob[resultado4.2[[2]]$inclprob[,1] != "-", 1],
           resultado4.2[[3]]$inclprob[resultado4.2[[3]]$inclprob[,1] != "-", 1],
           resultado4.2SB[[1]]$inclprob[resultado4.2SB[[1]]$inclprob[,1] != "-", 1],
           resultado4.3[[1]]$inclprob[resultado4.3[[1]]$inclprob[,1] != "-", 1],
           resultado4.3[[2]]$inclprob[resultado4.3[[2]]$inclprob[,1] != "-", 1],
           resultado4.3[[3]]$inclprob[resultado4.3[[3]]$inclprob[,1] != "-", 1],
           resultado4.3SB[[1]]$inclprob[resultado4.3SB[[1]]$inclprob[,1] != "-", 1])

pr <- paste0("p=", c(rep(5, 4*4), rep(10, 4*4), rep(15, 4*4))) # Núm variables
method <- rep(c(rep("Const-Const", 4), rep("SB-Const", 4),
                rep("SB-SB", 4), rep("SB", 4)),3)
q <- rep(c(rep("true", 1), rep("false", 3)), 4*3) # V/F
Grupos <- paste0("G", c(rep(1:4, 4*3)))
Grupos <- factor(Grupos, levels = paste0("G", 1:4))

probs <- as.numeric(probs)
pr <- factor(pr, levels = c("p=5", "p=10", "p=15"))
method <- factor(method, levels = c("SB", "Const-Const", "SB-Const", "SB-SB"))
q <- factor(q)

exp2 <- data.frame(probs, pr, method, q, Grupos)
ggplot(exp2, aes(x = pr, y = probs, color = q)) +
  geom_point(shape = 21, size = 1, stroke = 1) +
  geom_hline(yintercept = 0.5, linetype = 2, color = 8, alpha = 0.5, size = 1) + 
  labs(x = "Número de variables por grupo", 
       y = "Probabilidad inclusión a posteriori") + 
  theme_bw() + theme(legend.position = "none") + 
  coord_cartesian(ylim = c(0, 1)) + facet_wrap(~ method, ncol = 4)
```

En función del número de variables en cada grupo:

```{r, fig.width = 7, fig.height = 4, fig.align = "center", fig.cap = ' '}
ggplot(data = exp2[exp2$pr == "p=5",], aes(x = Grupos, y = probs, color = q)) +
  geom_col(aes(fill = q), alpha = 0.7) + 
  geom_hline(yintercept = 0.5, linetype = 2, color = 8, alpha = 0.5, size = 1) + 
  theme_bw() + theme(legend.position = "none") + 
  labs(x = "5 variables", y = "Probabilidad inclusión a posteriori") +
  facet_wrap(~ method, ncol = 4) + coord_cartesian(ylim = c(0, 1))
  
ggplot(data = exp2[exp2$pr == "p=10",], aes(x = Grupos, y = probs, color = q)) +
  geom_col(aes(fill = q), alpha = 0.7) + 
  geom_hline(yintercept = 0.5, linetype = 2, color = 8, alpha = 0.5, size = 1) + 
  theme_bw() + theme(legend.position = "none") + 
  labs(x = "10 variables", y = "Probabilidad inclusión a posteriori") + 
  facet_wrap(~ method, ncol = 4) + coord_cartesian(ylim = c(0, 1))
 
ggplot(data = exp2[exp2$pr == "p=15",], aes(x = Grupos, y = probs, color = q)) +
  geom_col(aes(fill = q), alpha = 0.7) + 
  theme_bw() + theme(legend.position = "none") + 
  labs(x = "15 variables", y = "Probabilidad inclusión a posteriori") +
  facet_wrap(~ method, ncol = 4) + coord_cartesian(ylim = c(0, 1))
```

Probabilidad de inclusión a posteriori para cada grupo:

```{r}
previas <- c("SB", "Const-Const", "SB-Const", "SB-SB")
matriz <- c()
for (j in 1:4) {
  matriz <- c(matriz, 
              exp2[exp2$Grupos == paste0("G", j) &
                exp2$method == previas[1] & exp2$pr=="p=5", 1],
              exp2[exp2$Grupos == paste0("G", j) &
                exp2$method == previas[1] & exp2$pr=="p=10", 1],
              exp2[exp2$Grupos == paste0("G", j) &
                exp2$method == previas[1] & exp2$pr=="p=15", 1])
}
matriz <- round(matriz, 2)
matriz <- matrix(matriz, ncol = 4)
rownames(matriz) <- c(unique(exp2$pr))
colnames(matriz) <- paste0("G", 1:4)
kable(matriz, caption = "Probabilidad para cada grupo según el número de variables con SB.") %>%
  kable_styling()

matriz <- c()
for (j in 1:4) {
  matriz <- c(matriz, 
              exp2[exp2$Grupos == paste0("G", j) &
                exp2$method == previas[2] & exp2$pr=="p=5", 1],
              exp2[exp2$Grupos == paste0("G", j) &
                exp2$method == previas[2] & exp2$pr=="p=10", 1],
              exp2[exp2$Grupos == paste0("G", j) &
                exp2$method == previas[2] & exp2$pr=="p=15", 1])
}
matriz <- round(matriz, 2)
matriz <- matrix(matriz, ncol = 4)
rownames(matriz) <- c(unique(exp2$pr))
colnames(matriz) <- paste0("G", 1:4)
kable(matriz, caption = "Probabilidad para cada grupo según el número de variables con Const-Const.") %>%
  kable_styling()

matriz <- c()
for (j in 1:4) {
  matriz <- c(matriz, 
              exp2[exp2$Grupos == paste0("G", j) &
                exp2$method == previas[3] & exp2$pr=="p=5", 1],
              exp2[exp2$Grupos == paste0("G", j) &
                exp2$method == previas[3] & exp2$pr=="p=10", 1],
              exp2[exp2$Grupos == paste0("G", j) &
                exp2$method == previas[3] & exp2$pr=="p=15", 1])
}
matriz <- round(matriz, 2)
matriz <- matrix(matriz, ncol = 4)
rownames(matriz) <- c(unique(exp2$pr))
colnames(matriz) <- paste0("G", 1:4)
kable(matriz, caption = "Probabilidad para cada grupo según el número de variables con SB-Const.") %>%
  kable_styling()

matriz <- c()
for (j in 1:4) {
  matriz <- c(matriz, 
              exp2[exp2$Grupos == paste0("G", j) &
                exp2$method == previas[4] & exp2$pr=="p=5", 1],
              exp2[exp2$Grupos == paste0("G", j) &
                exp2$method == previas[4] & exp2$pr=="p=10", 1],
              exp2[exp2$Grupos == paste0("G", j) &
                exp2$method == previas[4] & exp2$pr=="p=15", 1])
}
matriz <- round(matriz, 2)
matriz <- matrix(matriz, ncol = 4)
rownames(matriz) <- c(unique(exp2$pr))
colnames(matriz) <- paste0("G", 1:4)
kable(matriz, caption = "Probabilidad para cada grupo según el número de variables con SB-SB.") %>%
  kable_styling()
```

### Variables agrupadas

En general:

```{r, fig.width = 6, fig.height = 4, fig.align = "center", fig.cap = ' ', results='hide'}
# l = 5
load("./Resultados_simulados/E2/resultado4.1.Rdata")
load("./Resultados_simulados/E2/resultado4.1SB.Rdata")
# l = 10
load("./Resultados_simulados/E2/resultado4.2.Rdata")
load("./Resultados_simulados/E2/resultado4.2SB.Rdata")
# l = 15
load("./Resultados_simulados/E2/resultado4.3.Rdata")
load("./Resultados_simulados/E2/resultado4.3SB.Rdata")

# Primer banco de datos
probs <- c(resultado4.1[[1]]$inclprob[2:6, 2], # CC
           resultado4.1[[2]]$inclprob[2:6, 2], # SBC
           resultado4.1[[3]]$inclprob[2:6, 2], # SBSB
           resultado4.1SB[[1]]$inclprob[2:6, 2], # SB
           resultado4.2[[1]]$inclprob[2:11, 2],
           resultado4.2[[2]]$inclprob[2:11, 2],
           resultado4.2[[3]]$inclprob[2:11, 2],
           resultado4.2SB[[1]]$inclprob[2:11, 2],
           resultado4.3[[1]]$inclprob[2:16, 2],
           resultado4.3[[2]]$inclprob[2:16, 2],
           resultado4.3[[3]]$inclprob[2:16, 2],
           resultado4.3SB[[1]]$inclprob[2:16, 2])

pr <- paste0("p=", c(rep(5, 4*5), rep(10, 4*10), rep(15, 4*15)))
method <- c(rep("Const-Const", 5), rep("SB-Const", 5), 
            rep("SB-SB", 5), rep("SB", 5),
            rep("Const-Const", 10), rep("SB-Const", 10), 
            rep("SB-SB", 10), rep("SB", 10),
            rep("Const-Const", 15), rep("SB-Const", 15), 
            rep("SB-SB", 15), rep("SB", 15))
q <- c(rep(c(rep("true",2), rep("false", 3)),4),
       rep(c(rep("true",2), rep("false", 8)),4),
       rep(c(rep("true",2), rep("false", 13)),4))

Vars <- c(rep(1:5, 4), rep(1:10, 4), rep(1:15, 4))
Vars <- factor(Vars, levels =  1:15)

probs <- as.numeric(probs)
pr <- factor(pr, levels = c("p=5", "p=10", "p=15"))
method <- factor(method, levels = c("SB", "Const-Const", "SB-Const", "SB-SB"))
q <- factor(q)

exp2 <- data.frame(probs, pr, method, q, Vars)
ggplot(exp2, aes(x = pr, y = probs, color = q)) +
  geom_point(shape = 21, size = 1, stroke = 1) +
  geom_hline(yintercept = 0.5, linetype = 2, color = 8, alpha = 0.5, size = 1) + 
  labs(x = "Número de variables por grupo", 
       y = "Probabilidad inclusión a posteriori") + 
  theme_bw() + theme(legend.position = "none") + 
  coord_cartesian(ylim = c(0, 1)) + facet_wrap(~ method, ncol = 4)
```

En función del número de variables en cada grupo:

```{r, fig.width = 7, fig.height = 4, fig.align = "center", fig.cap = ' '}
ggplot(data = exp2[exp2$pr == "p=5",], aes(x = Vars, y = probs, color = q)) +
  geom_col(aes(fill = q), alpha = 0.7) + 
  geom_hline(yintercept = 0.5, linetype = 2, color = 8, alpha = 0.5, size = 1) + 
  theme_bw() + theme(legend.position = "none", axis.text = element_text(size = 6)) + 
  labs(x = "5 variables", y = "Probabilidad inclusión a posteriori") +
  coord_cartesian(ylim = c(0, 1)) + facet_wrap(~ method, ncol = 4)
  
ggplot(data = exp2[exp2$pr == "p=10",], aes(x = Vars, y = probs, color = q)) +
  geom_col(aes(fill = q), alpha = 0.7) + 
  geom_hline(yintercept = 0.5, linetype = 2, color = 8, alpha = 0.5, size = 1) + 
  theme_bw() + theme(legend.position = "none", axis.text = element_text(size = 6)) + 
  labs(x = "10 variables", y = "Probabilidad inclusión a posteriori") + 
  coord_cartesian(ylim = c(0, 1)) + facet_wrap(~ method, ncol = 4)

ggplot(data = exp2[exp2$pr == "p=15",], aes(x = Vars, y = probs, color = q)) +
  geom_col(aes(fill = q), alpha = 0.7) + 
  geom_hline(yintercept = 0.5, linetype = 2, color = 8, alpha = 0.5, size = 1) + 
  theme_bw() + theme(legend.position = "none", axis.text = element_text(size = 6)) + 
  labs(x = "15 variables", y = "Probabilidad inclusión a posteriori") + 
  coord_cartesian(ylim = c(0, 1)) + facet_wrap(~ method, ncol = 4)
```

Con $\beta_{11} = -0.43$ y $\beta_{12} = -0.37$.

### Grupos

  En general:

```{r, fig.width = 6, fig.height = 4, fig.align = "center", fig.cap = ' ', results='hide'}
# l = 5
load("./Resultados_simulados/E2/resultado4.1.Rdata")
load("./Resultados_simulados/E2/resultado4.1SB.Rdata")
# l = 10
load("./Resultados_simulados/E2/resultado4.2.Rdata")
load("./Resultados_simulados/E2/resultado4.2SB.Rdata")
# l = 15
load("./Resultados_simulados/E2/resultado4.3.Rdata")
load("./Resultados_simulados/E2/resultado4.3SB.Rdata")

# Segundo banco de datos
probs <- c(resultado4.1[[5]]$inclprob[resultado4.1[[5]]$inclprob[,1] != "-", 1], # CC
           resultado4.1[[6]]$inclprob[resultado4.1[[6]]$inclprob[,1] != "-", 1], # SBC
           resultado4.1[[7]]$inclprob[resultado4.1[[7]]$inclprob[,1] != "-", 1], # SBSB
           resultado4.1SB[[2]]$inclprob[resultado4.1SB[[2]]$inclprob[,1] != "-", 1], # SB
           resultado4.2[[5]]$inclprob[resultado4.2[[5]]$inclprob[,1] != "-", 1],
           resultado4.2[[6]]$inclprob[resultado4.2[[6]]$inclprob[,1] != "-", 1],
           resultado4.2[[7]]$inclprob[resultado4.2[[7]]$inclprob[,1] != "-", 1],
           resultado4.2SB[[2]]$inclprob[resultado4.2SB[[2]]$inclprob[,1] != "-", 1],
           resultado4.3[[5]]$inclprob[resultado4.3[[5]]$inclprob[,1] != "-", 1],
           resultado4.3[[6]]$inclprob[resultado4.3[[6]]$inclprob[,1] != "-", 1],
           resultado4.3[[7]]$inclprob[resultado4.3[[7]]$inclprob[,1] != "-", 1],
           resultado4.3SB[[2]]$inclprob[resultado4.3SB[[2]]$inclprob[,1] != "-", 1])

pr <- paste0("p=", c(rep(5, 4*4), rep(10, 4*4), rep(15, 4*4)))
method <- rep(c(rep("Const-Const", 4), rep("SB-Const", 4), 
                rep("SB-SB", 4), rep("SB", 4)),3)
q <- rep(c(rep("true",1), rep("false", 3)), 4*3)
Grupos <- paste0("G", c(rep(1:4, 4*3)))
Grupos <- factor(Grupos, levels = paste0("G", 1:4))

probs <- as.numeric(probs)
pr <- factor(pr, levels = c("p=5", "p=10", "p=15"))
method <- factor(method, levels = c("SB", "Const-Const", "SB-Const", "SB-SB"))
q <- factor(q)


exp2 <- data.frame(probs, pr, method, q, Grupos)
ggplot(exp2, aes(x = pr, y = probs, color = q)) +
  geom_point(shape = 21, size = 1, stroke = 1) +
  geom_hline(yintercept = 0.5, linetype = 2, color = 8, alpha = 0.5, size = 1) + 
  labs(x = "Número de variables por grupo", 
       y = "Probabilidad inclusión a posteriori") + 
  theme_bw() + theme(legend.position = "none") + 
  coord_cartesian(ylim = c(0, 1)) + facet_wrap(~ method, ncol = 4)
```

En función del número de variables en cada grupo:

```{r, fig.width = 6, fig.height = 4, fig.align = "center", fig.cap = ' '}
ggplot(data = exp2[exp2$pr == "p=5",], aes(x = Grupos, y = probs, color = q)) +
  geom_col(aes(fill = q), alpha = 0.7) + 
  geom_hline(yintercept = 0.5, linetype = 2, color = 8, alpha = 0.5, size = 1) + 
  theme_bw() + theme(legend.position = "none") + 
  labs(x = "5 variables", y = "Probabilidad inclusión a posteriori") +
  coord_cartesian(ylim = c(0, 1)) + facet_wrap(~ method, ncol = 4)
  
ggplot(data = exp2[exp2$pr == "p=10",], aes(x = Grupos, y = probs, color = q)) +
  geom_col(aes(fill = q), alpha = 0.7) + 
  geom_hline(yintercept = 0.5, linetype = 2, color = 8, alpha = 0.5, size = 1) + 
  theme_bw() + theme(legend.position = "none") + 
  labs(x= "10 variables", y= "Probabilidad inclusión a posteriori") + 
  coord_cartesian(ylim = c(0, 1)) + facet_wrap(~ method, ncol = 4)

ggplot(data = exp2[exp2$pr == "p=15",], aes(x = Grupos, y = probs, color = q)) +
  geom_col(aes(fill = q), alpha = 0.7) + 
  geom_hline(yintercept = 0.5, linetype = 2, color = 8, alpha = 0.5, size = 1) + 
  theme_bw() + theme(legend.position = "none") + 
  labs(x= "15 variables", y= "Probabilidad inclusión a posteriori") + 
  coord_cartesian(ylim = c(0, 1)) + facet_wrap(~ method, ncol = 4)
```

Probabilidad de inclusión a posteriori para cada grupo:

```{r}
previas <- c("SB", "Const-Const", "SB-Const", "SB-SB")

# SB
matriz <- c()
for (j in 1:4) {
  matriz <- c(matriz, 
              exp2[exp2$Grupos == paste0("G", j) &
                exp2$method == previas[1] & exp2$pr == "p=5", 1],
              exp2[exp2$Grupos == paste0("G", j) &
                exp2$method == previas[1] & exp2$pr == "p=10", 1],
              exp2[exp2$Grupos == paste0("G", j) &
                exp2$method == previas[1] & exp2$pr == "p=15", 1])
}
matriz <- round(matriz, 2)
matriz <- matrix(matriz, ncol = 4)
rownames(matriz) <- c(unique(exp2$pr))
colnames(matriz) <- paste0("G", 1:4)
kable(matriz, caption = "Probabilidad para cada grupo 
      según el número de variables con SB.") %>%
  kable_styling()

# Const-Const
matriz <- c()
for (j in 1:4) {
  matriz <- c(matriz, 
              exp2[exp2$Grupos == paste0("G", j) &
                exp2$method == previas[2] & exp2$pr == "p=5", 1],
              exp2[exp2$Grupos == paste0("G", j) &
                exp2$method == previas[2] & exp2$pr == "p=10", 1],
              exp2[exp2$Grupos == paste0("G", j) &
                exp2$method == previas[2] & exp2$pr == "p=15", 1])
}

matriz <- round(matriz, 2)
matriz <- matrix(matriz, ncol = 4)
rownames(matriz) <- c(unique(exp2$pr))
colnames(matriz) <- paste0("G", 1:4)
kable(matriz, caption = "Probabilidad para cada grupo 
      según el número de variables con Const-Const.") %>%
  kable_styling()

# SB-Const
matriz <- c()
for (j in 1:4) {
  matriz <- c(matriz, 
              exp2[exp2$Grupos == paste0("G", j) &
                exp2$method == previas[3] & exp2$pr == "p=5", 1],
              exp2[exp2$Grupos == paste0("G", j) &
                exp2$method == previas[3] & exp2$pr == "p=10", 1],
              exp2[exp2$Grupos == paste0("G", j) &
                exp2$method == previas[3] & exp2$pr == "p=15", 1])
}
matriz <- round(matriz, 2)
matriz <- matrix(matriz, ncol = 4)
rownames(matriz) <- c(unique(exp2$pr))
colnames(matriz) <- paste0("G", 1:4)
kable(matriz, caption = "Probabilidad para cada grupo 
      según el número de variables con SB-Const.") %>%
  kable_styling()

# SB-SB
matriz <- c()
for (j in 1:4) {
  matriz <- c(matriz, 
              exp2[exp2$Grupos == paste0("G", j) &
                exp2$method == previas[4] & exp2$pr=="p=5", 1],
              exp2[exp2$Grupos == paste0("G", j) &
                exp2$method == previas[4] & exp2$pr=="p=10", 1],
              exp2[exp2$Grupos == paste0("G", j) &
                exp2$method == previas[4] & exp2$pr=="p=15", 1])
}
matriz <- round(matriz, 2)
matriz <- matrix(matriz, ncol = 4)
rownames(matriz) <- c(unique(exp2$pr))
colnames(matriz) <- paste0("G", 1:4)
kable(matriz, caption = "Probabilidad para cada grupo 
      según el número de variables con SB-SB.") %>%
  kable_styling()
```

### Variables agrupadas

En general:

```{r, fig.width = 6, fig.height = 4, fig.align = "center", fig.cap = ' ', results='hide'}
probs <- c(resultado4.1[[5]]$inclprob[2:6, 2], # CC
           resultado4.1[[6]]$inclprob[2:6, 2], # SBC
           resultado4.1[[7]]$inclprob[2:6, 2], # SBSB
           resultado4.1SB[[2]]$inclprob[2:6, 2], # SB
           resultado4.2[[5]]$inclprob[2:11, 2],
           resultado4.2[[6]]$inclprob[2:11, 2],
           resultado4.2[[7]]$inclprob[2:11, 2],
           resultado4.2SB[[2]]$inclprob[2:11, 2],
           resultado4.3[[5]]$inclprob[2:16, 2],
           resultado4.3[[6]]$inclprob[2:16, 2],
           resultado4.3[[7]]$inclprob[2:16, 2],
           resultado4.3SB[[2]]$inclprob[2:16, 2]) 

pr <- paste0("p=", c(rep(5, 4*5), rep(10, 4*10), rep(15, 4*15)))
method <- c(rep("Const-Const", 5), rep("SB-Const", 5), 
            rep("SB-SB", 5), rep("SB", 5),
            rep("Const-Const", 10), rep("SB-Const", 10), 
            rep("SB-SB", 10), rep("SB", 10),
            rep("Const-Const", 15), rep("SB-Const", 15), 
            rep("SB-SB", 15), rep("SB", 15))
q <- c(rep(c(rep("true",2), rep("false", 3)),4),
       rep(c(rep("true",2), rep("false", 8)),4),
       rep(c(rep("true",2), rep("false", 13)),4))

Vars <- c(rep(1:5, 4), rep(1:10, 4), rep(1:15, 4))
Vars <- factor(Vars, levels = 1:15)

probs <- as.numeric(probs)
pr <- factor(pr, levels = c("p=5", "p=10", "p=15"))
method <- factor(method, levels = c("SB", "Const-Const", "SB-Const", "SB-SB"))
q <- factor(q)

exp2 <- data.frame(probs, pr, method, q, Vars)
ggplot(exp2, aes(x = pr, y = probs, color = q)) +
  geom_point(shape = 21, size = 1, stroke = 1) +
  geom_hline(yintercept = 0.5, linetype = 2, color = 8, alpha = 0.5, size = 1) + 
  labs(x = "Número de variables por grupo", 
       y = "Probabilidad inclusión a posteriori") + 
  theme_bw() + theme(legend.position = "none") + 
  coord_cartesian(ylim = c(0, 1)) + facet_wrap(~ method, ncol = 4)
```

En función del número de variables en cada grupo:

```{r, fig.width = 6, fig.height = 4, fig.align = "center", fig.cap = ' '}
ggplot(data = exp2[exp2$pr == "p=5",], aes(x = Vars, y = probs, color = q)) +
  geom_col(aes(fill = q), alpha = 0.7) + 
  geom_hline(yintercept = 0.5, linetype = 2, color = 8, alpha = 0.5, size = 1) + 
  theme_bw() + theme(legend.position = "none", axis.text = element_text(size = 6)) + 
  labs(x = "5 variables", y = "Probabilidad inclusión a posteriori") + 
  coord_cartesian(ylim = c(0, 1)) + facet_wrap(~ method, ncol = 4)
  
ggplot(data = exp2[exp2$pr == "p=10",], aes(x = Vars, y = probs, color = q)) +
  geom_col(aes(fill = q), alpha = 0.7) + 
  geom_hline(yintercept = 0.5, linetype = 2, color = 8, alpha = 0.5, size = 1) + 
  theme_bw() + theme(legend.position = "none", axis.text = element_text(size = 6)) + 
  labs(x = "10 variables", y = "Probabilidad inclusión a posteriori") + 
  coord_cartesian(ylim = c(0, 1)) + facet_wrap(~ method, ncol = 4)

ggplot(data = exp2[exp2$pr == "p=15",], aes(x = Vars, y = probs, color = q)) +
  geom_col(aes(fill = q), alpha = 0.7) + 
  geom_hline(yintercept = 0.5, linetype = 2, color = 8, alpha = 0.5, size = 1) + 
  theme_bw() + theme(legend.position = "none", axis.text = element_text(size = 6)) + 
  labs(x = "15 variables", y = "Probabilidad inclusión a posteriori") + 
  coord_cartesian(ylim = c(0, 1)) + facet_wrap(~ method, ncol = 4)
```

# Experimento 2.2: 5, 10 y 15 variables agrupadas verdaderas

Quiero ver qué pasa cuando aumento el número de variables que generan los datos en cada grupo, manteniendo el mismo número de grupos, 4.
Los datos los genero con:

$\theta = 1 + \beta_1X_1$, $\pi=\frac{e^{\theta}}{1 + e^{\theta}}$ e $Y\sim Ber(\pi)$. Todas las variables del primer grupo generan los datos.

Y luego añado 3 grupos falsos más. Lo repito con 5, 10 y 15 variables cada uno.

Con 5 variables: $\beta_1 = (0.63, 0.58, -0.53, 0.5, -0.46)$.

Con 10 variables: $\beta_1 = (0.63, 0.58, -0.53, 0.5, -0.46, 0.63, 0.58, -0.53, 0.5, -0.46)$.

Con 15 variables: $\beta_1 = c(0.63, 0.58, -0.53, 0.5, -0.46, 0.63, 0.58, -0.53, 0.5, -0.46, 0.63, 0.58, -0.53, 0.5, -0.46)$.

### Grupos

```{r, fig.width = 6, fig.height = 4, fig.align = "center", fig.cap = ' ', results='hide'}
# l = 5
load("./Resultados_simulados/E2/resultado4.4.Rdata")
load("./Resultados_simulados/E2/resultado4.4SB.Rdata")
# l = 10
load("./Resultados_simulados/E2/resultado4.5.Rdata")
load("./Resultados_simulados/E2/resultado4.5SB.Rdata")
# l = 15
load("./Resultados_simulados/E2/resultado4.6.Rdata")
load("./Resultados_simulados/E2/resultado4.6SB.Rdata")

# Primer banco de datos
probs <- c(resultado4.4[[1]]$inclprob[resultado4.4[[1]]$inclprob[,1] != "-", 1], # CC
           resultado4.4[[2]]$inclprob[resultado4.4[[2]]$inclprob[,1] != "-", 1], # SBC
           resultado4.4[[3]]$inclprob[resultado4.4[[3]]$inclprob[,1] != "-", 1], # SBSB
           resultado4.4SB[[1]]$inclprob[resultado4.4SB[[1]]$inclprob[,1] != "-", 1], # SB
           resultado4.5[[1]]$inclprob[resultado4.5[[1]]$inclprob[,1] != "-", 1],
           resultado4.5[[2]]$inclprob[resultado4.5[[2]]$inclprob[,1] != "-", 1],
           resultado4.5[[3]]$inclprob[resultado4.5[[3]]$inclprob[,1] != "-", 1],
           resultado4.5SB[[1]]$inclprob[resultado4.5SB[[1]]$inclprob[,1] != "-", 1],
           resultado4.6[[1]]$inclprob[resultado4.6[[1]]$inclprob[,1] != "-", 1],
           resultado4.6[[2]]$inclprob[resultado4.6[[2]]$inclprob[,1] != "-", 1],
           resultado4.6[[3]]$inclprob[resultado4.6[[3]]$inclprob[,1] != "-", 1],
           resultado4.6SB[[1]]$inclprob[resultado4.6SB[[1]]$inclprob[,1] != "-", 1])

pr <- paste0("p=", c(rep(5, 4*4), rep(10, 4*4), rep(15, 4*4)))
method <- rep(c(rep("Const-Const", 4), rep("SB-Const", 4), 
                rep("SB-SB", 4), rep("SB", 4)),3)
Grupos <- paste0("G", c(rep(1:4, 4*3)))
Grupos <- factor(Grupos, levels = paste0("G", 1:4))

method <- factor(method, levels = c("SB", "Const-Const", "SB-Const", "SB-SB"))
probs <- as.numeric(probs)
pr <- factor(pr, levels = c("p=5", "p=10", "p=15"))
q <- rep(c("true", rep("false",3)), 4*3)
q <- factor(q)

exp2 <- data.frame(probs, pr, method, q, Grupos)
ggplot(exp2, aes(x = pr, y = probs, color = q)) +
  geom_point(shape = 21, size = 1, stroke = 1) +
  geom_hline(yintercept = 0.5, linetype = 2, color = 8, alpha = 0.5, size = 1) + 
  labs(x = "Número de variables por grupo", 
       y = "Probabilidad inclusión a posteriori") + 
  theme_bw() + theme(legend.position = "none") + 
  coord_cartesian(ylim = c(0, 1)) + facet_wrap(~ method, ncol = 4)
```

En función del número de variables en cada grupo:

```{r, fig.width = 6, fig.height = 4, fig.align = "center", fig.cap = ' '}
cols <- paletteer_d("ggthemes::Tableau_10")
ggplot(data = exp2[exp2$pr == "p=5",], aes(x = Grupos, y = probs, color = q)) +
  geom_col(aes(fill = q), alpha = 0.7) + 
  geom_hline(yintercept = 0.5, linetype = 2, color = 8, alpha = 0.5, size = 1) + 
  theme_bw() + theme(legend.position = "none") + 
  labs(x = "5 variables", y = "Probabilidad inclusión a posteriori") + 
  coord_cartesian(ylim = c(0, 1)) + facet_wrap(~ method, ncol = 4)
  
ggplot(data = exp2[exp2$pr == "p=10",], aes(x = Grupos, y = probs, color = q)) +
  geom_col(aes(fill = q), alpha = 0.7) + 
  geom_hline(yintercept = 0.5, linetype = 2, color = 8, alpha = 0.5, size = 1) + 
  theme_bw() + theme(legend.position = "none")+ 
  labs(x = "10 variables", y = "Probabilidad inclusión a posteriori")+ 
  coord_cartesian(ylim = c(0, 1)) + facet_wrap(~ method, ncol = 4)

ggplot(data = exp2[exp2$pr == "p=15",], aes(x = Grupos, y = probs, color = q)) +
  geom_col(aes(fill = q), alpha = 0.7) + 
  geom_hline(yintercept = 0.5, linetype = 2, color = 8, alpha = 0.5, size = 1) + 
  theme_bw() + theme(legend.position = "none") + 
  labs(x = "15 variables", y = "Probabilidad inclusión a posteriori") + 
  coord_cartesian(ylim = c(0, 1)) + facet_wrap(~ method, ncol = 4)
```

```{r}
previas <- c("SB", "Const-Const", "SB-Const", "SB-SB")

# SB
matriz <- c()
for (j in 1:4) {
  matriz <- c(matriz, 
              exp2[exp2$Grupos == paste0("G", j) &
                exp2$method == previas[1] & exp2$pr == "p=5", 1],
              exp2[exp2$Grupos == paste0("G", j) &
                exp2$method == previas[1] & exp2$pr == "p=10", 1],
              exp2[exp2$Grupos == paste0("G", j) &
                exp2$method == previas[1] & exp2$pr == "p=15", 1])
}
matriz <- round(matriz, 2)
matriz <- matrix(matriz, ncol = 4)
rownames(matriz) <- c(unique(exp2$pr))
colnames(matriz) <- paste0("G", 1:4)
kable(matriz, caption = "Probabilidad para cada grupo 
      según el número de variables con SB.") %>%
  kable_styling()

# Const-Const
matriz <- c()
for (j in 1:4) {
  matriz <- c(matriz, 
              exp2[exp2$Grupos == paste0("G", j) &
                exp2$method == previas[2] & exp2$pr == "p=5", 1],
              exp2[exp2$Grupos == paste0("G", j) &
                exp2$method == previas[2] & exp2$pr == "p=10", 1],
              exp2[exp2$Grupos == paste0("G", j) &
                exp2$method == previas[2] & exp2$pr == "p=15", 1])
}
matriz <- round(matriz, 2)
matriz <- matrix(matriz, ncol = 4)
rownames(matriz) <- c(unique(exp2$pr))
colnames(matriz) <- paste0("G", 1:4)
kable(matriz, caption = "Probabilidad para cada grupo 
      según el número de variables con Const-Const.") %>%
  kable_styling()

# SB-Const
matriz <- c()
for (j in 1:4) {
  matriz <- c(matriz, 
              exp2[exp2$Grupos == paste0("G", j) &
                exp2$method == previas[3] & exp2$pr == "p=5", 1],
              exp2[exp2$Grupos == paste0("G", j) &
                exp2$method == previas[3] & exp2$pr == "p=10", 1],
              exp2[exp2$Grupos == paste0("G", j) &
                exp2$method == previas[3] & exp2$pr == "p=15", 1])
}
matriz <- round(matriz, 2)
matriz <- matrix(matriz, ncol = 4)
rownames(matriz) <- c(unique(exp2$pr))
colnames(matriz) <- paste0("G", 1:4)
kable(matriz, caption = "Probabilidad para cada grupo 
      según el número de variables con SB-Const.") %>%
  kable_styling()

# SB-SB
matriz <- c()
for (j in 1:4) {
  matriz <- c(matriz, 
              exp2[exp2$Grupos == paste0("G", j) &
                exp2$method == previas[4] & exp2$pr == "p=5", 1],
              exp2[exp2$Grupos == paste0("G", j) &
                exp2$method == previas[4] & exp2$pr == "p=10", 1],
              exp2[exp2$Grupos == paste0("G", j) &
                exp2$method == previas[4] & exp2$pr == "p=15", 1])
}
matriz <- round(matriz, 2)
matriz <- matrix(matriz, ncol = 4)
rownames(matriz) <- c(unique(exp2$pr))
colnames(matriz) <- paste0("G", 1:4)
kable(matriz, caption = "Probabilidad para cada grupo 
      según el número de variables con SB-SB.") %>%
  kable_styling()
```

### Variables agrupadas verdaderas (G1)

En general:

```{r, fig.width = 6, fig.height = 4, fig.align = "center", fig.cap = ' ', results='hide'}
# Dibujar las probabilidades de las variables agrupadas
# Primer banco de datos
probs <- c(resultado4.4[[1]]$inclprob[2:6, 2], # CC
           resultado4.4[[2]]$inclprob[2:6, 2], # SBC
           resultado4.4[[3]]$inclprob[2:6, 2], # SBSB
           resultado4.4SB[[1]]$inclprob[2:6, 2], # SB
           resultado4.5[[1]]$inclprob[2:11, 2],
           resultado4.5[[2]]$inclprob[2:11, 2],
           resultado4.5[[3]]$inclprob[2:11, 2],
           resultado4.5SB[[1]]$inclprob[2:11, 2],
           resultado4.6[[1]]$inclprob[2:16, 2],
           resultado4.6[[2]]$inclprob[2:16, 2],
           resultado4.6[[3]]$inclprob[2:16, 2],
           resultado4.6SB[[1]]$inclprob[2:16, 2]) 

pr <- paste0("p=", c(rep(5, 4*5), rep(10, 4*10), rep(15, 4*15)))
method <- c(rep("Const-Const", 5), rep("SB-Const", 5), 
            rep("SB-SB", 5), rep("SB", 5),
            rep("Const-Const", 10), rep("SB-Const", 10), 
            rep("SB-SB", 10), rep("SB", 10),
            rep("Const-Const", 15), rep("SB-Const", 15), 
            rep("SB-SB", 15), rep("SB", 15))
Vars <- c(rep(1:5,4), rep(1:10,4), rep(1:15,4))
Vars <- factor(Vars, levels = 1:15)

probs <- as.numeric(probs)
pr <- factor(pr, levels = c("p=5", "p=10", "p=15"))
method <- factor(method, levels = c("SB", "Const-Const", "SB-Const", "SB-SB"))

exp2 <- data.frame(probs, pr, method, Vars)
ggplot(exp2, aes(x = pr, y = probs)) +
  geom_point(shape = 21, size = 1, stroke = 1, color = "lightblue3") +
  geom_hline(yintercept = 0.5, linetype = 2, color = 8, alpha = 0.5, size = 1) + 
  labs(x = "Número de variables por grupo", 
       y = "Probabilidad inclusión a posteriori") + 
  theme_bw() + theme(legend.position = "none") + 
  coord_cartesian(ylim = c(0, 1)) + facet_wrap(~ method, ncol = 4)
```

En función del número de variables en cada grupo:

```{r, fig.width = 6, fig.height = 4, fig.align = "center", fig.cap = ' '}
cols <- paletteer_d("ggthemes::Hue_Circle")
ggplot(data = exp2[exp2$pr == "p=5",], aes(x = Vars, y = probs)) +
  geom_col(aes(fill = Vars), alpha = 0.7) + 
  geom_hline(yintercept = 0.5, linetype = 2, color = 8, alpha = 0.5, size = 1) + 
  scale_fill_manual(values = cols) +
  theme_bw() + 
  theme(legend.position = "none", axis.text = element_text(size = 6)) + 
  labs(x = "5 variables", y = "Probabilidad inclusión a posteriori") +
  coord_cartesian(ylim = c(0, 1)) + facet_wrap(~ method, ncol = 4)
  
ggplot(data = exp2[exp2$pr == "p=10",], aes(x = Vars, y = probs)) +
  geom_col(aes(fill = Vars), alpha = 0.7) + 
  geom_hline(yintercept = 0.5, linetype = 2, color = 8, alpha = 0.5, size = 1) + 
    scale_fill_manual(values = cols) +
  theme_bw() + 
  theme(legend.position = "none", axis.text = element_text(size = 6)) + 
  labs(x = "10 variables", y = "Probabilidad inclusión a posteriori") + 
  coord_cartesian(ylim = c(0, 1)) + facet_wrap(~ method, ncol = 4)

ggplot(data = exp2[exp2$pr == "p=15",], aes(x = Vars, y = probs)) +
  geom_col(aes(fill = Vars), alpha = 0.7) + 
  geom_hline(yintercept = 0.5, linetype = 2, color = 8, alpha = 0.5, size = 1) + 
    scale_fill_manual(values = cols) +
  theme_bw() + theme(legend.position = "none", axis.text = element_text(size = 6)) + 
  labs(x = "15 variables", y = "Probabilidad inclusión a posteriori") +
  coord_cartesian(ylim = c(0, 1)) + facet_wrap(~ method, ncol = 4)
```


Con 5 variables: $\beta_1 = (-0.41, 0.39, -0.35, 0.3, 0.27)$.

Con 10 variables: $\beta_1 = (-0.41, 0.39, -0.35, 0.3, 0.27, -0.41, 0.39, -0.35, 0.3, 0.27)$.

Con 15 variables: $\beta_1 = (-0.41, 0.39, -0.35, 0.3, 0.27, -0.41, 0.39, -0.35, 0.3, 0.27, -0.41, 0.39, -0.35, 0.3, 0.27)$.

### Grupos

```{r, fig.width = 6, fig.height = 4, fig.align = "center", fig.cap = ' ', results='hide'}
# l = 5
load("./Resultados_simulados/E2/resultado4.4.Rdata")
load("./Resultados_simulados/E2/resultado4.4SB.Rdata")
# l = 10
load("./Resultados_simulados/E2/resultado4.5.Rdata")
load("./Resultados_simulados/E2/resultado4.5SB.Rdata")
# l = 15
load("./Resultados_simulados/E2/resultado4.6.Rdata")
load("./Resultados_simulados/E2/resultado4.6SB.Rdata")

# Dibujar las probabilidades de los grupos
# Segundo banco de datos
probs <- c(resultado4.4[[5]]$inclprob[resultado4.4[[5]]$inclprob[,1] != "-", 1], # CC
           resultado4.4[[6]]$inclprob[resultado4.4[[6]]$inclprob[,1] != "-", 1], # SBC
           resultado4.4[[7]]$inclprob[resultado4.4[[7]]$inclprob[,1] != "-", 1], # SBSB
           resultado4.4SB[[2]]$inclprob[resultado4.4SB[[2]]$inclprob[,1] != "-", 1], # SB
           resultado4.5[[5]]$inclprob[resultado4.5[[5]]$inclprob[,1] != "-", 1],
           resultado4.5[[6]]$inclprob[resultado4.5[[6]]$inclprob[,1] != "-", 1],
           resultado4.5[[7]]$inclprob[resultado4.5[[7]]$inclprob[,1] != "-", 1],
           resultado4.5SB[[2]]$inclprob[resultado4.5SB[[2]]$inclprob[,1] != "-", 1],
           resultado4.6[[5]]$inclprob[resultado4.6[[5]]$inclprob[,1] != "-", 1],
           resultado4.6[[6]]$inclprob[resultado4.6[[6]]$inclprob[,1] != "-", 1],
           resultado4.6[[7]]$inclprob[resultado4.6[[7]]$inclprob[,1] != "-", 1],
           resultado4.6SB[[2]]$inclprob[resultado4.6SB[[2]]$inclprob[,1] != "-", 1])

pr <- paste0("p=", c(rep(5, 4*4), rep(10, 4*4), rep(15, 4*4)))
method <- rep(c(rep("Const-Const", 4), rep("SB-Const", 4), 
                rep("SB-SB", 4), rep("SB", 4)), 3)
Grupos <- paste0("G", c(rep(1:4, 4*3)))
Grupos <- factor(Grupos, levels = paste0("G", 1:4))

probs <- as.numeric(probs)
pr <- factor(pr, levels = c("p=5", "p=10", "p=15"))
method <- factor(method, levels = c("SB", "Const-Const", "SB-Const", "SB-SB"))
q <- rep(c("true", rep("false",3)), 4*3)
q <- factor(q)

exp2 <- data.frame(probs, pr, method, q, Grupos)
ggplot(exp2, aes(x = pr, y = probs, color = q)) +
  geom_point(shape = 21, size = 1, stroke = 1) +
  geom_hline(yintercept = 0.5, linetype = 2, color = 8, alpha = 0.5, size = 1) + 
  labs(x = "", y = "Probabilidad inclusión a posteriori") + 
  theme_bw() + theme(legend.position = "none") + 
  coord_cartesian(ylim = c(0, 1)) + facet_wrap(~ method, ncol = 4)
```

En función del número de variables en cada grupo:

```{r, fig.width = 6, fig.height = 4, fig.align = "center", fig.cap = ' '}
ggplot(data = exp2[exp2$pr == "p=5",], aes(x = Grupos, y = probs, color = q)) +
  geom_col(aes(fill = q), alpha = 0.7) + 
  geom_hline(yintercept = 0.5, linetype = 2, color = 8, alpha = 0.5, size = 1) + 
  theme_bw() + theme(legend.position = "none") + 
  labs(x = "5 variables", y = "Probabilidad inclusión a posteriori") +
  coord_cartesian(ylim = c(0, 1)) + facet_wrap(~ method, ncol = 4)
  
ggplot(data = exp2[exp2$pr == "p=10",], aes(x = Grupos, y = probs, color = q)) +
  geom_col(aes(fill = q), alpha = 0.7) + 
  geom_hline(yintercept = 0.5, linetype = 2, color = 8, alpha = 0.5, size = 1) +
  theme_bw() + theme(legend.position = "none") + 
  labs(x = "10 variables", y = "Probabilidad inclusión a posteriori") +
  coord_cartesian(ylim = c(0, 1)) + facet_wrap(~ method, ncol = 4)

ggplot(data = exp2[exp2$pr == "p=15",], aes(x = Grupos, y = probs, color = q)) +
  geom_col(aes(fill = q), alpha = 0.7) + 
  geom_hline(yintercept = 0.5, linetype = 2, color = 8, alpha = 0.5, size = 1) + 
  theme_bw() + theme(legend.position = "none") + 
  labs(x = "15 variables", y = "Probabilidad inclusión a posteriori") + 
  coord_cartesian(ylim = c(0, 1)) + facet_wrap(~ method, ncol = 4)
```

```{r}
previas <- c("SB", "Const-Const", "SB-Const", "SB-SB")

# SB
matriz <- c()
for (j in 1:4) {
  matriz <- c(matriz, 
              exp2[exp2$Grupos == paste0("G", j) &
                exp2$method == previas[1] & exp2$pr == "p=5", 1],
              exp2[exp2$Grupos == paste0("G", j) &
                exp2$method == previas[1] & exp2$pr == "p=10", 1],
              exp2[exp2$Grupos == paste0("G", j) &
                exp2$method == previas[1] & exp2$pr == "p=15", 1])
}
matriz <- round(matriz, 2)
matriz <- matrix(matriz, ncol = 4)
rownames(matriz) <- c(unique(exp2$pr))
colnames(matriz) <- paste0("G", 1:4)
kable(matriz, caption = "Probabilidad para cada grupo 
      según el número de variables con SB.") %>%
  kable_styling()

# Const-Const
matriz <- c()
for (j in 1:4) {
  matriz <- c(matriz, 
              exp2[exp2$Grupos == paste0("G", j) &
                exp2$method == previas[2] & exp2$pr == "p=5", 1],
              exp2[exp2$Grupos == paste0("G", j) &
                exp2$method == previas[2] & exp2$pr == "p=10", 1],
              exp2[exp2$Grupos == paste0("G", j) &
                exp2$method == previas[2] & exp2$pr == "p=15", 1])
}
matriz <- round(matriz, 2)
matriz <- matrix(matriz, ncol = 4)
rownames(matriz) <- c(unique(exp2$pr))
colnames(matriz) <- paste0("G", 1:4)
kable(matriz, caption = "Probabilidad para cada grupo 
      según el número de variables con Const-Const.") %>%
  kable_styling()

# SB-Const
matriz <- c()
for (j in 1:4) {
  matriz <- c(matriz, 
              exp2[exp2$Grupos == paste0("G", j) &
                exp2$method == previas[3] & exp2$pr == "p=5", 1],
              exp2[exp2$Grupos == paste0("G", j) &
                exp2$method == previas[3] & exp2$pr == "p=10", 1],
              exp2[exp2$Grupos == paste0("G", j) &
                exp2$method == previas[3] & exp2$pr == "p=15", 1])
}
matriz <- round(matriz, 2)
matriz <- matrix(matriz, ncol = 4)
rownames(matriz) <- c(unique(exp2$pr))
colnames(matriz) <- paste0("G", 1:4)
kable(matriz, caption = "Probabilidad para cada grupo 
      según el número de variables con SB-Const.") %>%
  kable_styling()

# SB-SB
matriz <- c()
for (j in 1:4) {
  matriz <- c(matriz, 
              exp2[exp2$Grupos == paste0("G", j) &
                exp2$method == previas[4] & exp2$pr == "p=5", 1],
              exp2[exp2$Grupos == paste0("G", j) &
                exp2$method == previas[4] & exp2$pr == "p=10", 1],
              exp2[exp2$Grupos == paste0("G", j) &
                exp2$method == previas[4] & exp2$pr == "p=15", 1])
}
matriz <- round(matriz, 2)
matriz <- matrix(matriz, ncol = 4)
rownames(matriz) <- c(unique(exp2$pr))
colnames(matriz) <- paste0("G", 1:4)
kable(matriz, caption = "Probabilidad para cada grupo 
      según el número de variables con SB-SB.") %>%
  kable_styling()
```

### Variables agrupadas

En general:

```{r, fig.width = 6, fig.height = 4, fig.align = "center", fig.cap = ' ', results='hide'}
probs <- c(resultado4.4[[5]]$inclprob[2:6, 2], # CC
           resultado4.4[[6]]$inclprob[2:6, 2], # SBC
           resultado4.4[[7]]$inclprob[2:6, 2], # SBSB
           resultado4.4SB[[2]]$inclprob[2:6, 2], # SB
           resultado4.5[[5]]$inclprob[2:11, 2],
           resultado4.5[[6]]$inclprob[2:11, 2],
           resultado4.5[[7]]$inclprob[2:11, 2],
           resultado4.5SB[[2]]$inclprob[2:11, 2],
           resultado4.6[[5]]$inclprob[2:16, 2],
           resultado4.6[[6]]$inclprob[2:16, 2],
           resultado4.6[[7]]$inclprob[2:16, 2],
           resultado4.6SB[[2]]$inclprob[2:16, 2])

pr <- paste0("p=", c(rep(5, 4*5), rep(10, 4*10), rep(15, 4*15)))
method <- c(rep("Const-Const", 5), rep("SB-Const", 5), 
            rep("SB-SB", 5), rep("SB", 5),
            rep("Const-Const", 10), rep("SB-Const", 10), 
            rep("SB-SB", 10), rep("SB", 10),
            rep("Const-Const", 15), rep("SB-Const", 15), 
            rep("SB-SB", 15), rep("SB", 15))
Vars <- c(rep(1:5,4), rep(1:10,4), rep(1:15,4))
Vars <- factor(Vars, levels = 1:15)

probs <- as.numeric(probs)
pr <- factor(pr, levels = c("p=5", "p=10", "p=15"))
method <- factor(method, levels = c("SB", "Const-Const", "SB-Const", "SB-SB"))

exp2 <- data.frame(probs, pr, method, Vars)
ggplot(exp2, aes(x = pr, y = probs)) +
  geom_point(shape = 21, size = 1, stroke = 1, color = "lightblue3") +
  geom_hline(yintercept = 0.5, linetype = 2, color = 8, alpha = 0.5, size = 1) + 
  labs(x = "Número de variables por grupo", 
       y = "Probabilidad inclusión a posteriori") + 
  theme_bw() + theme(legend.position = "none") + 
  coord_cartesian(ylim = c(0, 1)) + facet_wrap(~ method, ncol = 4)
```

En función del número de variables en cada grupo:

```{r, fig.width = 6, fig.height = 4, fig.align = "center", fig.cap = ' '}
cols <- paletteer_d("ggthemes::Hue_Circle")
ggplot(data = exp2[exp2$pr == "p=5",], aes(x = Vars, y = probs)) +
  geom_col(aes(fill = Vars), alpha = 0.7) + 
  geom_hline(yintercept = 0.5, linetype = 2, color = 8, alpha = 0.5, size = 1) + 
  scale_fill_manual(values = cols) +
  theme_bw() + theme(legend.position = "none", axis.text = element_text(size = 6)) + 
  labs(x = "5 variables", y = "Probabilidad inclusión a posteriori") +
  coord_cartesian(ylim = c(0, 1)) + facet_wrap(~ method, ncol = 4)
  
ggplot(data = exp2[exp2$pr == "p=10",], aes(x = Vars, y = probs)) +
  geom_col(aes(fill = Vars), alpha = 0.7) + 
  geom_hline(yintercept = 0.5, linetype = 2, color = 8, alpha = 0.5, size = 1) + 
    scale_fill_manual(values = cols) +
  theme_bw() + theme(legend.position = "none", axis.text = element_text(size = 6)) + 
  labs(x = "10 variables", y = "Probabilidad inclusión a posteriori") +
  coord_cartesian(ylim = c(0, 1)) + facet_wrap(~ method, ncol = 4)

ggplot(data = exp2[exp2$pr == "p=15",], aes(x = Vars, y = probs)) +
  geom_col(aes(fill = Vars), alpha = 0.7) + 
  geom_hline(yintercept = 0.5, linetype = 2, color = 8, alpha = 0.5, size = 1) + 
    scale_fill_manual(values = cols) +
  theme_bw() + theme(legend.position = "none", axis.text=element_text(size=6)) + 
  labs(x = "15 variables", y = "Probabilidad inclusión a posteriori") + 
  coord_cartesian(ylim = c(0, 1)) + facet_wrap(~ method, ncol = 4)
```


# Esperimento 3

Quiero ver qué pasa cuando aumento el número de variables falsas en cada grupo, manteniendo el mismo número de grupos, 4.

Los datos los genero con:

$\theta = 1 + \beta_1X_1+\beta_2X_2$, $\pi=\frac{e^{\theta}}{1 + e^{\theta}}$ e $Y\sim Ber(\pi)$. El primer grupo con 8 variables y el segundo con 4, no todas generan los datos.

Y luego añado 2 grupos falsos más con 8 y 4 variables cada uno. Se hace con n = 300 y n = 600 observaciones.

Con $\beta_1 = (0, 0, 0.55, 0.55, 0.55, 0.55, -0.49, -0.49)$, $\beta_2 = (0, 0, 0.46, 0.46)$ y n = 300 observaciones.

### Grupos

```{r, fig.width = 6, fig.height = 4, fig.align = "center", fig.cap = ' '}
probs <- c()
method <- c()
for (i in 1:10) {
  load(paste0("./Resultados_simulados/E3/resultado5.1.", i, ".Rdata")) # df1
  load(paste0("./Resultados_simulados/E3/resultado5.2.", i, ".Rdata")) # df2
  load(paste0("./Resultados_simulados/E3/resultado5.1.", i, "SB.Rdata")) # df1
  load(paste0("./Resultados_simulados/E3/resultado5.2.", i, "SB.Rdata")) # df2

  probs <- c(probs,
             # df1 con n = 300
             resultado5.1[[1]]$inclprob[resultado5.1[[1]]$inclprob[,1] != "-", 1], # CC
             resultado5.1[[2]]$inclprob[resultado5.1[[2]]$inclprob[,1] != "-", 1], # SBC
             resultado5.1[[3]]$inclprob[resultado5.1[[3]]$inclprob[,1] != "-", 1], # SBSB
             resultado5.1SB[[1]]$inclprob[resultado5.1SB[[1]]$inclprob[,1] != "-", 1], # SB
             # resultado5.1[[5]], # BAS no selecciona grupos
             # df1 con n = 600
             resultado5.2[[1]]$inclprob[resultado5.2[[1]]$inclprob[,1] != "-", 1],
             resultado5.2[[2]]$inclprob[resultado5.2[[2]]$inclprob[,1] != "-", 1],
             resultado5.2[[3]]$inclprob[resultado5.2[[3]]$inclprob[,1] != "-", 1],
             resultado5.2SB[[1]]$inclprob[resultado5.2SB[[1]]$inclprob[,1] != "-", 1]
             # resultado5.2[[5]]
             )
  method <- c(method,
              rep(c(rep("Const-Const", 4), rep("SB-Const", 4),
                    rep("SB-SB", 4), rep("SB", 4)), 2))
}

q <- rep(c(rep("true",2), rep("false",2)),4*20)
dfs <- rep(c(rep("df1.1", 4*4), rep("df1.2", 4*4)), 10)
Grupos <- rep(c(paste0("G", 1:4)), 4*20)

probs <- as.numeric(probs)
method <- factor(method, levels = c("SB", "Const-Const", "SB-Const", "SB-SB"))
q <- factor(q)
Grupos <- factor(Grupos, levels = c(paste0("G", 1:4)))
dfs <- factor(dfs)

exp3 <- data.frame(probs, method, q, Grupos, dfs)
cols <- paletteer_d("ggthemes::Tableau_20")
ggplot(data = exp3[exp3$dfs == "df1.1",], aes(x = Grupos, y = probs, fill = Grupos)) +
  geom_boxplot(alpha = 0.8, colour = "#474747", outlier.colour = 1) +
  geom_hline(yintercept = 0.5, linetype = 2, color = 8, alpha = 0.5, size = 1) +
  scale_fill_manual(values = cols) +
  theme_bw() + theme(legend.position = "none") +
  labs(x = " ", y = "Probabilidad inclusión a posteriori") +
  coord_cartesian(ylim = c(0, 1)) + facet_wrap(~ method, ncol = 4)
```

Porcentaje de grupos incorrectamente seleccionados e incorrectamente no seleccionados:

```{r}
# MPM
# Calculamos los grupos incorrectamente seleccionados
previas <- c("SB", "Const-Const", "SB-Const", "SB-SB")
matriz <- c()
for (j in 1:length(previas)) {
  matriz <- c(matriz,
              nrow(exp3[exp3[,3] == "false" & exp3[,1] > 0.5 &
                exp3$method == previas[j] & exp3$Grupos == "G3" &
                  exp3$dfs == "df1.1",])/(1*10)*100,
               nrow(exp3[exp3[,3] == "false" & exp3[,1] > 0.5 &
                exp3$method == previas[j] & exp3$Grupos == "G4"&
                  exp3$dfs == "df1.1",])/(1*10)*100)
}
matriz <- paste0(matriz, "%")
matriz <- matrix(matriz, ncol = 4)
rownames(matriz) <- c("G3", "G4")
colnames(matriz) <- previas
kable(matriz, caption = "Porcentaje de grupos incorrectamente seleccionados 
      para cada previa elegida.") %>%
  kable_styling()

# Calculamos laos grupos incorrectamente no seleccionados
matriz <- c()
for (j in 1:length(previas)) {
  matriz <- c(matriz,
              nrow(exp3[exp3[,3] == "true" & exp3[,1] < 0.5 &
                exp3$method == previas[j] & exp3$Grupos == "G1"&
                  exp3$dfs == "df1.1",])/(1*10)*100,
              nrow(exp3[exp3[,3] == "true" & exp3[,1] < 0.5 &
                exp3$method == previas[j] & exp3$Grupos == "G2"&
                  exp3$dfs == "df1.1",])/(1*10)*100)
}
matriz <- paste0(matriz, "%")
matriz <- matrix(matriz, ncol = 4)
rownames(matriz) <- c("G1", "G2")
colnames(matriz) <- previas
kable(matriz, caption = "Porcentaje de grupos incorrectamente no seleccionados 
      para cada previa elegida.") %>%
  kable_styling()
```

```{r}
# HPM con SBSB
indices <- c(0,8,12,20,24)
prop <- rep(0,4)
for (i in 1:10) {
  load(paste0("./Resultados_simulados/E3/resultado5.1.", i, ".Rdata")) # df1
  # load(paste0("./Resultados_simulados/E3/resultado5.2.", i, ".Rdata")) # df2
  
  for ( j in 2:5){
    if (sum(resultado5.1[[3]]$bestmodel[[1]][(indices[j - 1] + 1):indices[j]])>0) {
      prop[j - 1] <- prop[j - 1] + 1
    }
  }
}
## Proporción de veces que no incluye a los dos primeros grupos 
# y que sí incluye a los dos últimos
prop <- prop/10; prop[1:2] <- 1 - prop[1:2]
names(prop) <- paste0("G", 1:4)
kable(as.matrix(prop), caption = "Proporción de grupos incorrectamente seleccionados 
      e incorrectamente no seleccionados del HPM.")
```

### Variables agrupadas

```{r, fig.width = 10, fig.height = 6, fig.align = "center", fig.cap = ' '}
probs <- c()
method <- c()
for (i in 1:10) {
  load(paste0("./Resultados_simulados/E3/resultado5.1.", i, ".Rdata"))
  load(paste0("./Resultados_simulados/E3/resultado5.2.", i, ".Rdata"))
  load(paste0("./Resultados_simulados/E3/resultado5.1.", i, "SB.Rdata"))
  load(paste0("./Resultados_simulados/E3/resultado5.2.", i, "SB.Rdata"))

  probs <- c(probs,
             # df1 con n = 300
             resultado5.1[[1]]$inclprob[c(2:9,11:14,16:23,25:28), 2], # CC
             resultado5.1[[2]]$inclprob[c(2:9,11:14,16:23,25:28), 2], # SBC
             resultado5.1[[3]]$inclprob[c(2:9,11:14,16:23,25:28), 2], # SBSB
             resultado5.1SB[[1]]$inclprob[c(2:9,11:14,16:23,25:28), 2], # SB
             resultado5.1[[5]]$probne0[-1], # BAS
             # df1 con n = 600
             resultado5.2[[1]]$inclprob[c(2:9,11:14,16:23,25:28), 2],
             resultado5.2[[2]]$inclprob[c(2:9,11:14,16:23,25:28), 2],
             resultado5.2[[3]]$inclprob[c(2:9,11:14,16:23,25:28), 2],
             resultado5.2SB[[1]]$inclprob[c(2:9,11:14,16:23,25:28), 2],
             resultado5.2[[5]]$probne0[-1])
  
  method <- c(method,
              rep(c(rep("Const-Const", 12*2), rep("SB-Const", 12*2),
                    rep("SB-SB", 12*2), rep("SB", 12*2), rep("BAS", 12*2)), 2))
}

q <- rep(c(rep("false",2), rep("true",6), rep("false",2), 
           rep("true",2), rep("false",12)),5*20)
Vars <- rep(c(paste0("1.", 1:8), paste0("2.", 1:4),
                paste0("3.", 1:8), paste0("4.", 1:4)), 100)
dfs <- rep(c(rep("df1.1", 24*5), rep("df1.2", 24*5)), 10)

dfs <- factor(dfs)
probs <- as.numeric(probs)
method <- factor(method, levels = c("BAS", "SB", "Const-Const", 
                                    "SB-Const", "SB-SB"))
q <- factor(q)
Vars <- factor(Vars, levels = c(paste0("1.", 1:8), paste0("2.", 1:4),
                paste0("3.", 1:8), paste0("4.", 1:4)))

exp3vars <- data.frame(probs, method, q, Vars, dfs)

exp3vars$Grupos <- ifelse(str_detect(exp3vars$Vars, "^1"), "G1",
                      ifelse(str_detect(exp3vars$Vars, "^2"), "G2",
                             ifelse(str_detect(exp3vars$Vars, "^3"), "G3", "G4")))

cols <- paletteer_c("grDevices::Spectral", 30)[30:1]
ggplot(data = exp3vars[exp3vars$dfs == "df1.1" & 
                      (exp3vars$Grupos == "G1" | exp3vars$Grupos == "G2"),],
       aes(x = Vars, y = probs, fill = q)) +
  geom_boxplot(alpha = 0.8, colour = "#474747", outlier.colour = 1) + 
  geom_hline(yintercept = 0.5, linetype = 2, color = 8, alpha = 0.5, size = 1) +
  theme_bw() + theme(legend.position = "none", 
                      axis.text.x = element_blank(), axis.ticks.x = element_blank()) +
  labs(x = " ", y = "Probabilidad inclusión a posteriori") +
  coord_cartesian(ylim = c(0, 1)) + facet_wrap(~ method, ncol = 5)
```

```{r}
# Probabilidad del grupo correspondiente a cada variable
pG <- c()
for (i in 1:nrow(exp3)) {
  z <- i/4
  ifelse((z - floor(z)) == 0.25, probG <- rep(exp3$probs[4*floor(z) + 1], 8),
    ifelse((z - floor(z)) == 0.5, probG <- rep(exp3$probs[4*floor(z) + 2], 4),
        ifelse((z - floor(z)) == 0.75, probG <- rep(exp3$probs[4*floor(z) + 3], 8),
            ifelse((z - floor(z)) == 0, probG <- rep(exp3$probs[4*floor(z)], 4), 
                   NA))))
  pG <- c(pG, probG)
}
exp3vars$pG <- 9
exp3vars$pG[exp3vars$method == "BAS"] <- NA
exp3vars$pG[!is.na(exp3vars$pG)] <- pG
```

Porcentaje de variables agrupadas incorrectamente seleccionadas e incorrectamente no seleccionadas:

```{r}
# Calculamos las vars agrupadas incorrectamente seleccionadas
previas <- c("BAS", "SB", "Const-Const", "SB-Const", "SB-SB")
matriz <- c()
for (j in 1:length(previas)) {
  matriz <- c(matriz,
              nrow(exp3vars[exp3vars[,3] == "false" & exp3vars[,1] > 0.5 & 
                              (exp3vars$pG >0.5 | is.na(exp3vars$pG)) &
                exp3vars$method == previas[j] & exp3vars$Grupos == "G1"&
                  exp3vars$dfs == "df1.1",])/(2*10)*100,
              nrow(exp3vars[exp3vars[,3] == "false" & exp3vars[,1] > 0.5 &
                              (exp3vars$pG >0.5 | is.na(exp3vars$pG)) &
                exp3vars$method == previas[j] & exp3vars$Grupos == "G2"&
                  exp3vars$dfs == "df1.1",])/(2*10)*100,
              nrow(exp3vars[exp3vars[,3] == "false" & exp3vars[,1] > 0.5 &
                              (exp3vars$pG >0.5 | is.na(exp3vars$pG)) &
                exp3vars$method == previas[j] & exp3vars$Grupos == "G3" &
                  exp3vars$dfs == "df1.1",])/(8*10)*100,
               nrow(exp3vars[exp3vars[,3] == "false" & exp3vars[,1] > 0.5 &
                               (exp3vars$pG >0.5 | is.na(exp3vars$pG)) &
                exp3vars$method == previas[j] & exp3vars$Grupos == "G4"&
                  exp3vars$dfs == "df1.1",])/(4*10)*100)
}
matriz <- paste0(matriz, "%")
matriz <- matrix(matriz, ncol = 5)
rownames(matriz) <- c("G1", "G2", "G3", "G4")
colnames(matriz) <- previas
kable(t(matriz), caption = "Porcentaje de variables agrupadas incorrectamente 
      seleccionadas para cada previa elegida.") %>%
  kable_styling()

# Calculamos las vars agrupadas incorrectamente no seleccionadas
matriz <- c()
for (j in 1:length(previas)) {
  matriz <- c(matriz,
              nrow(exp3vars[exp3vars[,3] == "true" & ((exp3vars[,1] < 0.5 & 
                   is.na(exp3vars$pG)) | (exp3vars$method!= "BAS" & 
                   (exp3vars[,1] < 0.5 | exp3vars$pG <0.5))) &
                exp3vars$method == previas[j] & exp3vars$Grupos == "G1" &
                  exp3vars$dfs == "df1.1",])/(6*10)*100,
              nrow(exp3vars[exp3vars[,3] == "true" & ((exp3vars[,1] < 0.5 &
                   is.na(exp3vars$pG)) | (exp3vars$method!= "BAS" &
                   (exp3vars[,1] < 0.5 | exp3vars$pG <0.5))) &
                exp3vars$method == previas[j] & exp3vars$Grupos == "G2" &
                  exp3vars$dfs == "df1.1",])/(2*10)*100)
}
matriz <- paste0(matriz, "%")
matriz <- matrix(matriz, ncol = 5)
rownames(matriz) <- c("G1", "G2")
colnames(matriz) <- previas
kable(t(matriz), caption = "Porcentaje de variables agrupadas incorrectamente 
      no seleccionadas para cada previa elegida.") %>%
  kable_styling()
```

Con n = 600 observaciones.

### Grupos

```{r, fig.width = 6, fig.height = 4, fig.align = "center", fig.cap = ' '}
cols <- paletteer_d("ggthemes::Tableau_20")
ggplot(data = exp3[exp3$dfs == "df1.2",], aes(x = Grupos, y = probs, fill = Grupos)) +
  geom_boxplot(alpha = 0.8, colour = "#474747", outlier.colour = 1) +
  geom_hline(yintercept = 0.5, linetype = 2, color = 8, alpha = 0.5, size = 1) +
  scale_fill_manual(values = cols) +
  theme_bw() + theme(legend.position = "none") +
  labs(x = " ", y = "Probabilidad inclusión a posteriori") +
  coord_cartesian(ylim = c(0, 1)) + facet_wrap(~ method, ncol = 4)
```

Porcentaje de grupos incorrectamente seleccionados e incorrectamente no seleccionados:

```{r}
# Calculamos los grupos incorrectamente seleccionados
previas <- c("SB", "Const-Const", "SB-Const", "SB-SB")
matriz <- c()
for (j in 1:length(previas)) {
  matriz <- c(matriz,
              nrow(exp3[exp3[,3] == "false" & exp3[,1] > 0.5 &
                exp3$method == previas[j] & exp3$Grupos == "G3" &
                  exp3$dfs == "df1.2",])/(1*10)*100,
               nrow(exp3[exp3[,3] == "false" & exp3[,1] > 0.5 &
                exp3$method == previas[j] & exp3$Grupos == "G4"&
                  exp3$dfs == "df1.2",])/(1*10)*100)
}
matriz <- paste0(matriz, "%")
matriz <- matrix(matriz, ncol = 4)
rownames(matriz) <- c("G3", "G4")
colnames(matriz) <- previas
kable(matriz, caption = "Porcentaje de grupos incorrectamente seleccionados
      para cada previa elegida.") %>%
  kable_styling()

# Calculamos laos grupos incorrectamente no seleccionados
matriz <- c()
for (j in 1:length(previas)) {
  matriz <- c(matriz,
              nrow(exp3[exp3[,3] == "true" & exp3[,1] < 0.5 &
                exp3$method == previas[j] & exp3$Grupos == "G1"&
                  exp3$dfs == "df1.2",])/(1*10)*100,
              nrow(exp3[exp3[,3] == "true" & exp3[,1] < 0.5 &
                exp3$method == previas[j] & exp3$Grupos == "G2"&
                  exp3$dfs == "df1.2",])/(1*10)*100)
}
matriz <- paste0(matriz, "%")
matriz <- matrix(matriz, ncol = 4)
rownames(matriz) <- c("G1", "G2")
colnames(matriz) <- previas
kable(matriz, caption = "Porcentaje de grupos incorrectamente 
      no seleccionados para cada previa elegida.") %>%
  kable_styling()
```


```{r}
# HPM con SBSB
indices <- c(0,8,12,20,24)
prop <- rep(0,4)
for (i in 1:10) {
  # load(paste0("./Resultados_simulados/E3/resultado5.1.", i, ".Rdata")) # df1
  load(paste0("./Resultados_simulados/E3/resultado5.2.", i, ".Rdata")) # df2
  
  for ( j in 2:5){
    if (sum(resultado5.2[[3]]$bestmodel[[1]][(indices[j - 1] + 1):indices[j]]) > 0) {
      prop[j - 1] <- prop[j - 1] + 1
    }
  }
}
prop <- prop/10; prop[1:2] <- 1 - prop[1:2]
names(prop) <- paste0("G", 1:4)
kable(as.matrix(prop), caption = "Proporción de grupos incorrectamente seleccionadas 
      e incorrectamente no seleccionados del HPM.")
```

### Variables agrupadas

```{r, fig.width = 10, fig.height = 6, fig.align = "center", fig.cap = ' '}
ggplot(data = exp3vars[exp3vars$dfs == "df1.2" & 
                      (exp3vars$Grupos == "G1" | exp3vars$Grupos == "G2"),],
       aes(x = Vars, y = probs, fill = q)) +
  geom_boxplot(alpha = 0.8, colour = "#474747", outlier.colour = 1) +
  geom_hline(yintercept = 0.5, linetype = 2, color = 8, alpha = 0.5, size = 1) +
  theme_bw() + theme(legend.position = "none", 
                     axis.text.x = element_blank(), axis.ticks.x = element_blank())+
  labs(x = " ", y = "Probabilidad inclusión a posteriori")+
  coord_cartesian(ylim = c(0, 1)) +
  facet_wrap(~ method, ncol = 5)
```

Porcentaje de variables agrupadas incorrectamente seleccionadas e incorrectamente no seleccionadas:

```{r}
# Calculamos las vars agrupadas incorrectamente seleccionadas
previas <- c("BAS", "SB", "Const-Const", "SB-Const", "SB-SB")
matriz <- c()
for (j in 1:length(previas)) {
  matriz <- c(matriz,
              nrow(exp3vars[exp3vars[,3] == "false" & exp3vars[,1] > 0.5 & 
                              (exp3vars$pG >0.5 | is.na(exp3vars$pG)) &
                exp3vars$method == previas[j] & exp3vars$Grupos == "G1"&
                  exp3vars$dfs == "df1.2",])/(2*10)*100,
              nrow(exp3vars[exp3vars[,3] == "false" & exp3vars[,1] > 0.5 &
                              (exp3vars$pG >0.5 | is.na(exp3vars$pG)) &
                exp3vars$method == previas[j] & exp3vars$Grupos == "G2"&
                  exp3vars$dfs == "df1.2",])/(2*10)*100,
              nrow(exp3vars[exp3vars[,3] == "false" & exp3vars[,1] > 0.5 &
                              (exp3vars$pG >0.5 | is.na(exp3vars$pG)) &
                exp3vars$method == previas[j] & exp3vars$Grupos == "G3" &
                  exp3vars$dfs == "df1.2",])/(8*10)*100,
               nrow(exp3vars[exp3vars[,3] == "false" & exp3vars[,1] > 0.5 &
                               (exp3vars$pG >0.5 | is.na(exp3vars$pG)) &
                exp3vars$method == previas[j] & exp3vars$Grupos == "G4"&
                  exp3vars$dfs == "df1.2",])/(4*10)*100)
}
matriz <- paste0(matriz, "%")
matriz <- matrix(matriz, ncol = 5)
rownames(matriz) <- c("G1", "G2", "G3", "G4")
colnames(matriz) <- previas
kable(t(matriz), caption = "Porcentaje de variables agrupadas incorrectamente
      seleccionadas para cada previa elegida.") %>%
  kable_styling()

# Calculamos las vars agrupadas incorrectamente no seleccionadas
matriz <- c()
for (j in 1:length(previas)) {
  matriz <- c(matriz,
              nrow(exp3vars[exp3vars[,3] == "true" & ((exp3vars[,1] < 0.5 & 
                   is.na(exp3vars$pG)) |(exp3vars$method!= "BAS" & 
                   (exp3vars[,1] < 0.5 | exp3vars$pG <0.5))) &
                exp3vars$method == previas[j] & exp3vars$Grupos == "G1" &
                  exp3vars$dfs == "df1.2",])/(6*10)*100,
              nrow(exp3vars[exp3vars[,3] == "true" & ((exp3vars[,1] < 0.5 &
                  is.na(exp3vars$pG)) | (exp3vars$method!= "BAS" & 
                  (exp3vars[,1] < 0.5 | exp3vars$pG <0.5))) &
                exp3vars$method == previas[j] & exp3vars$Grupos == "G2"&
                  exp3vars$dfs == "df1.2",])/(2*10)*100)
}
matriz <- paste0(matriz, "%")
matriz <- matrix(matriz, ncol = 5)
rownames(matriz) <- c("G1", "G2")
colnames(matriz) <- previas
kable(t(matriz), caption = "Porcentaje de variables agrupadas incorrectamente 
      no seleccionadas para cada previa elegida.") %>%
  kable_styling()
```

Con $\beta_1 = (0.42, 0, 0, 0, 0, 0, 0, -0.4)$, $\beta_2 = (0.35, 0, 0, -0.3)$, con n = 300 observaciones.

### Grupos

```{r, fig.width = 6, fig.height = 4, fig.align = "center", fig.cap = ' '}
probs <- c()
method <- c()
for (i in 1:10) {
  load(paste0("./Resultados_simulados/E3/resultado5.1.", i, ".Rdata"))
  load(paste0("./Resultados_simulados/E3/resultado5.2.", i, ".Rdata"))
  load(paste0("./Resultados_simulados/E3/resultado5.1.", i, "SB.Rdata"))
  load(paste0("./Resultados_simulados/E3/resultado5.2.", i, "SB.Rdata"))

  probs <- c(probs,
             # df2 con n = 300
             resultado5.1[[6]]$inclprob[resultado5.1[[6]]$inclprob[,1] != "-", 1], # CC2
             resultado5.1[[7]]$inclprob[resultado5.1[[7]]$inclprob[,1] != "-", 1], # SBC2
             resultado5.1[[8]]$inclprob[resultado5.1[[8]]$inclprob[,1] != "-", 1], # SBSB2
             resultado5.1SB[[3]]$inclprob[resultado5.1SB[[3]]$inclprob[,1] != "-", 1], # SB2
             # resultado5.1[[10]] # BAS2
             # df2 con n = 600
             resultado5.2[[6]]$inclprob[resultado5.2[[6]]$inclprob[,1] != "-", 1],
             resultado5.2[[7]]$inclprob[resultado5.2[[7]]$inclprob[,1] != "-", 1],
             resultado5.2[[8]]$inclprob[resultado5.2[[8]]$inclprob[,1] != "-", 1],
             resultado5.2SB[[3]]$inclprob[resultado5.2SB[[3]]$inclprob[,1] != "-", 1]
             # resultado5.2[[10]])
  )
  method <- c(method,
              rep(c(rep("Const-Const", 4), rep("SB-Const", 4),
                    rep("SB-SB", 4), rep("SB", 4)), 2))
}

q <- rep(c(rep("true",2), rep("false",2)),4*20)
dfs <- rep(c(rep("df2.1", 4*4), rep("df2.2", 4*4)), 10)
Grupos <- rep(c(paste0("G", 1:4)), 4*20)

probs <- as.numeric(probs)
method <- factor(method, levels = c("SB", "Const-Const", "SB-Const", "SB-SB"))
q <- factor(q)
Grupos <- factor(Grupos, levels = c(paste0("G", 1:4)))
dfs <- factor(dfs)

exp3 <- data.frame(probs, method, q, Grupos, dfs)
cols <- paletteer_d("ggthemes::Tableau_20")
ggplot(data = exp3[exp3$dfs == "df2.1",], aes(x = Grupos, y = probs, fill = Grupos)) +
  geom_boxplot(alpha = 0.8, colour = "#474747", outlier.colour = 1) +
  geom_hline(yintercept = 0.5, linetype = 2, color = 8, alpha = 0.5, size = 1) +
  scale_fill_manual(values = cols) +
  theme_bw() + theme(legend.position = "none") +
  labs(x = " ", y = "Probabilidad inclusión a posteriori") +
  coord_cartesian(ylim = c(0, 1)) + facet_wrap(~ method, ncol = 4)
```

Porcentaje de grupos incorrectamente seleccionados e incorrectamente no seleccionados:

```{r}
# Calculamos los grupos incorrectamente seleccionados
previas <- c("SB", "Const-Const", "SB-Const", "SB-SB")
matriz <- c()
for (j in 1:length(previas)) {
  matriz <- c(matriz,
              nrow(exp3[exp3[,3] == "false" & exp3[,1] > 0.5 &
                exp3$method == previas[j] & exp3$Grupos == "G3" &
                  exp3$dfs == "df2.1",])/(1*10)*100,
               nrow(exp3[exp3[,3] == "false" & exp3[,1] > 0.5 &
                exp3$method == previas[j] & exp3$Grupos == "G4"&
                  exp3$dfs == "df2.1",])/(1*10)*100)
}
matriz <- paste0(matriz, "%")
matriz <- matrix(matriz, ncol = 4)
rownames(matriz) <- c("G3", "G4")
colnames(matriz) <- previas
kable(matriz, caption = "Porcentaje de grupos incorrectamente seleccionados 
      para cada previa elegida.") %>%
  kable_styling()

# Calculamos laos grupos incorrectamente no seleccionados
matriz <- c()
for (j in 1:length(previas)) {
  matriz <- c(matriz,
              nrow(exp3[exp3[,3] == "true" & exp3[,1] < 0.5 &
                exp3$method == previas[j] & exp3$Grupos == "G1"&
                  exp3$dfs == "df2.1",])/(1*10)*100,
              nrow(exp3[exp3[,3] == "true" & exp3[,1] < 0.5 &
                exp3$method == previas[j] & exp3$Grupos == "G2"&
                  exp3$dfs == "df2.1",])/(1*10)*100)
}
matriz <- paste0(matriz, "%")
matriz <- matrix(matriz, ncol = 4)
rownames(matriz) <- c("G1", "G2")
colnames(matriz) <- previas
kable(matriz, caption = "Porcentaje de grupos incorrectamente no
      seleccionados para cada previa elegida.") %>%
  kable_styling()
```

```{r}
# HPM con SBSB
indices <- c(0,8,12,20,24)
prop <- rep(0,4)
for (i in 1:10) {
  load(paste0("./Resultados_simulados/E3/resultado5.1.", i, ".Rdata")) # df1
  # load(paste0("./Resultados_simulados/E3/resultado5.2.", i, ".Rdata")) # df2
  
  for ( j in 2:5){
    if (sum(resultado5.1[[8]]$bestmodel[[1]][(indices[j - 1] + 1):indices[j]]) > 0) {
      prop[j - 1] <- prop[j - 1] + 1
    }
  }
}
## Proporción de veces que no incluye a los dos primeros grupos 
# y que sí incluye a los dos últimos
prop <- prop/10; prop[1:2] <- 1 - prop[1:2]
names(prop) <- paste0("G", 1:4)
kable(as.matrix(prop), caption = "Proporción de grupos incorrectamente 
      seleccionadas e incorrectamente no seleccionados del HPM.")
```

### Variables agrupadas

```{r, fig.width = 10, fig.height = 6, fig.align = "center", fig.cap = ' '}
probs <- c()
method <- c()
for (i in 1:10) {
  load(paste0("./Resultados_simulados/E3/resultado5.1.", i, ".Rdata"))
  load(paste0("./Resultados_simulados/E3/resultado5.2.", i, ".Rdata"))
  load(paste0("./Resultados_simulados/E3/resultado5.1.", i, "SB.Rdata"))
  load(paste0("./Resultados_simulados/E3/resultado5.2.", i, "SB.Rdata"))

  probs <- c(probs,
             # df2 con n = 300
             resultado5.1[[6]]$inclprob[c(2:9,11:14,16:23,25:28), 2], # CC2
             resultado5.1[[7]]$inclprob[c(2:9,11:14,16:23,25:28), 2], # SBC2
             resultado5.1[[8]]$inclprob[c(2:9,11:14,16:23,25:28), 2], # SBSB2
             resultado5.1SB[[3]]$inclprob[c(2:9,11:14,16:23,25:28), 2], # SB2
             resultado5.1[[10]]$probne0[-1], # BAS2
             # df2 con n = 600
             resultado5.2[[6]]$inclprob[c(2:9,11:14,16:23,25:28), 2],
             resultado5.2[[7]]$inclprob[c(2:9,11:14,16:23,25:28), 2],
             resultado5.2[[8]]$inclprob[c(2:9,11:14,16:23,25:28), 2],
             resultado5.2SB[[3]]$inclprob[c(2:9,11:14,16:23,25:28), 2],
             resultado5.2[[10]]$probne0[-1])
  method <- c(method,
              rep(c(rep("Const-Const", 12*2), rep("SB-Const", 12*2),
                    rep("SB-SB", 12*2), rep("SB", 12*2), rep("BAS", 12*2)), 2))
}

q <- rep(c(rep("true",1), rep("false",6), rep("true",2), rep("false",2),
           rep("true",1), rep("false",12)),5*20)
Vars <- rep(c(paste0("1.", 1:8), paste0("2.", 1:4),
                paste0("3.", 1:8), paste0("4.", 1:4)), 100)
dfs <- rep(c(rep("df2.1", 24*5), rep("df2.2", 24*5)), 10)

probs <- as.numeric(probs)
method <- factor(method, levels = c("BAS", "SB", "Const-Const", "SB-Const", "SB-SB"))
q <- factor(q)
Vars <- factor(Vars, levels = c(paste0("1.", 1:8), paste0("2.", 1:4),
                paste0("3.", 1:8), paste0("4.", 1:4)))
dfs <- factor(dfs)

exp3vars <- data.frame(probs, method, q, Vars, dfs)

exp3vars$Grupos <- ifelse(str_detect(exp3vars$Vars, "^1"), "G1",
                      ifelse(str_detect(exp3vars$Vars, "^2"), "G2",
                             ifelse(str_detect(exp3vars$Vars, "^3"), "G3", "G4")))

ggplot(data = exp3vars[exp3vars$dfs == "df2.1"& 
                      (exp3vars$Grupos == "G1" | exp3vars$Grupos == "G2"),],
       aes(x = Vars, y = probs, fill = q)) +
  geom_boxplot(alpha = 0.8, colour = "#474747", outlier.colour = 1) +
  geom_hline(yintercept = 0.5, linetype = 2, color = 8, alpha = 0.5, size = 1) +
  theme_bw() + theme(legend.position = "none", 
                     axis.text.x = element_blank(), axis.ticks.x = element_blank()) +
  labs(x = " ", y = "Probabilidad inclusión a posteriori") +
  coord_cartesian(ylim = c(0, 1)) + facet_wrap(~ method, ncol = 5)
```

```{r}
# Probabilidad del grupo correspondiente a cada variable
pG <- c()
for (i in 1:nrow(exp3)) {
  z <- i/4
  ifelse((z - floor(z)) == 0.25, probG <- rep(exp3$probs[4*floor(z) + 1], 8),
    ifelse((z - floor(z)) == 0.5, probG <- rep(exp3$probs[4*floor(z) + 2], 4),
        ifelse((z - floor(z)) == 0.75, probG <- rep(exp3$probs[4*floor(z) + 3], 8),
            ifelse((z - floor(z)) == 0, probG <- rep(exp3$probs[4*floor(z)], 4), 
                   NA))))
  pG <- c(pG, probG)
}
exp3vars$pG <- 9
exp3vars$pG[exp3vars$method == "BAS"] <- NA
exp3vars$pG[!is.na(exp3vars$pG)] <- pG
```

Porcentaje de variables agrupadas incorrectamente seleccionadas e incorrectamente no seleccionadas:

```{r}
# Calculamos las vars agrupadas incorrectamente seleccionadas
previas <- c("BAS", "SB", "Const-Const", "SB-Const", "SB-SB")
matriz <- c()
for (j in 1:length(previas)) {
  matriz <- c(matriz,
              nrow(exp3vars[exp3vars[,3] == "false" & exp3vars[,1] > 0.5 & 
                              (exp3vars$pG > 0.5 | is.na(exp3vars$pG)) &
                exp3vars$method == previas[j] & exp3vars$Grupos == "G1" &
                  exp3vars$dfs == "df2.1",])/(2*10)*100,
              nrow(exp3vars[exp3vars[,3] == "false" & exp3vars[,1] > 0.5 &
                              (exp3vars$pG > 0.5 | is.na(exp3vars$pG)) &
                exp3vars$method == previas[j] & exp3vars$Grupos == "G2" &
                  exp3vars$dfs == "df2.1",])/(2*10)*100,
              nrow(exp3vars[exp3vars[,3] == "false" & exp3vars[,1] > 0.5 &
                              (exp3vars$pG > 0.5 | is.na(exp3vars$pG)) &
                exp3vars$method == previas[j] & exp3vars$Grupos == "G3" &
                  exp3vars$dfs == "df2.1",])/(8*10)*100,
               nrow(exp3vars[exp3vars[,3] == "false" & exp3vars[,1] > 0.5 &
                               (exp3vars$pG > 0.5 | is.na(exp3vars$pG)) &
                exp3vars$method == previas[j] & exp3vars$Grupos == "G4" &
                  exp3vars$dfs == "df2.1",])/(4*10)*100)
}
matriz <- paste0(matriz, "%")
matriz <- matrix(matriz, ncol = 5)
rownames(matriz) <- c("G1", "G2", "G3", "G4")
colnames(matriz) <- previas
kable(t(matriz), caption = "Porcentaje de variables agrupadas incorrectamente 
      seleccionadas para cada previa elegida.") %>%
  kable_styling()

# Calculamos las vars agrupadas incorrectamente no seleccionadas
matriz <- c()
for (j in 1:length(previas)) {
  matriz <- c(matriz,
              nrow(exp3vars[exp3vars[,3] == "true" & ((exp3vars[,1] < 0.5 & 
                   is.na(exp3vars$pG)) | (exp3vars$method!= "BAS" & 
                   (exp3vars[,1] < 0.5 | exp3vars$pG < 0.5)))&
                exp3vars$method == previas[j] & exp3vars$Grupos == "G1"&
                  exp3vars$dfs == "df2.1",])/(6*10)*100,
              nrow(exp3vars[exp3vars[,3] == "true" & ((exp3vars[,1] < 0.5 &
                   is.na(exp3vars$pG)) | (exp3vars$method!= "BAS" & 
                   (exp3vars[,1] < 0.5 | exp3vars$pG < 0.5))) &
                exp3vars$method == previas[j] & exp3vars$Grupos == "G2" &
                  exp3vars$dfs == "df2.1",])/(2*10)*100)
}
matriz <- paste0(matriz, "%")
matriz <- matrix(matriz, ncol = 5)
rownames(matriz) <- c("G1", "G2")
colnames(matriz) <- previas
kable(t(matriz), caption = "Porcentaje de variables agrupadas incorrectamente 
      no seleccionadas para cada previa elegida.") %>%
  kable_styling()
```

Con n = 600 observaciones.

### Grupos

```{r, fig.width = 6, fig.height = 4, fig.align = "center", fig.cap = ' '}
cols <- paletteer_d("ggthemes::Tableau_20")
ggplot(data = exp3[exp3$dfs == "df2.2",], aes(x = Grupos, y = probs, fill = Grupos)) +
  geom_boxplot(alpha = 0.8, colour = "#474747", outlier.colour = 1) +
  geom_hline(yintercept = 0.5, linetype = 2, color = 8, alpha = 0.5, size = 1) +
  scale_fill_manual(values = cols) +
  theme_bw() + theme(legend.position = "none") +
  labs(x= " ", y= "Probabilidad inclusión a posteriori") +
  coord_cartesian(ylim = c(0, 1)) + facet_wrap(~ method, ncol = 4)
```

Porcentaje de grupos incorrectamente seleccionados e incorrectamente no seleccionados:

```{r}
# Calculamos los grupos incorrectamente seleccionados
previas <- c("SB", "Const-Const", "SB-Const", "SB-SB")
matriz <- c()
for (j in 1:length(previas)) {
  matriz <- c(matriz,
              nrow(exp3[exp3[,3] == "false" & exp3[,1] > 0.5 &
                exp3$method == previas[j] & exp3$Grupos == "G3" &
                  exp3$dfs == "df2.2",])/(1*10)*100,
               nrow(exp3[exp3[,3] == "false" & exp3[,1] > 0.5 &
                exp3$method == previas[j] & exp3$Grupos == "G4" &
                  exp3$dfs == "df2.2",])/(1*10)*100)
}
matriz <- paste0(matriz, "%")
matriz <- matrix(matriz, ncol = 4)
rownames(matriz) <- c("G3", "G4")
colnames(matriz) <- previas
kable(matriz, caption = "Porcentaje de grupos incorrectamente seleccionados 
      para cada previa elegida.") %>%
  kable_styling()

# Calculamos los grupos incorrectamente no seleccionados
matriz <- c()
for (j in 1:length(previas)) {
  matriz <- c(matriz,
              nrow(exp3[exp3[,3] == "true" & exp3[,1] < 0.5 &
                exp3$method == previas[j] & exp3$Grupos == "G1"&
                  exp3$dfs == "df2.2",])/(1*10)*100,
              nrow(exp3[exp3[,3] == "true" & exp3[,1] < 0.5 &
                exp3$method == previas[j] & exp3$Grupos == "G2"&
                  exp3$dfs == "df2.2",])/(1*10)*100)
}
matriz <- paste0(matriz, "%")
matriz <- matrix(matriz, ncol = 4)
rownames(matriz) <- c("G1", "G2")
colnames(matriz) <- previas
kable(matriz, caption = "Porcentaje de grupos incorrectamente no 
      seleccionados para cada previa elegida.") %>%
  kable_styling()
```

```{r}
# HPM con SBSB
indices <- c(0,8,12,20,24)
prop <- rep(0,4)
for (i in 1:10) {
  # load(paste0("./Resultados_simulados/E3/resultado5.1.", i, ".Rdata")) # df1
  load(paste0("./Resultados_simulados/E3/resultado5.2.", i, ".Rdata")) # df2
  
  for ( j in 2:5){
    if (sum(resultado5.2[[8]]$bestmodel[[1]][(indices[j - 1] + 1):indices[j]]) > 0) {
      prop[j - 1] <- prop[j - 1] + 1
    }
  }
}
## Proporción de veces que no incluye a los dos primeros grupos 
# y que sí incluye a los dos últimos
prop <- prop/10; prop[1:2] <- 1 - prop[1:2]
names(prop) <- paste0("G", 1:4)
kable(as.matrix(prop), caption = "Proporción de grupos incorrectamente
      seleccionadas e incorrectamente no seleccionados del HPM.")
```

### Variables agrupadas

```{r, fig.width = 10, fig.height = 6, fig.align = "center", fig.cap = ' '}
cols <- paletteer_c("grDevices::Spectral", 30)[30:1]
ggplot(data = exp3vars[exp3vars$dfs == "df2.2"& 
                      (exp3vars$Grupos == "G1" | exp3vars$Grupos == "G2"),],
       aes(x = Vars, y = probs, fill = q)) +
  geom_boxplot(alpha = 0.8, colour = "#474747", outlier.colour = 1) +
  geom_hline(yintercept = 0.5, linetype = 2, color = 8, alpha = 0.5, size = 1) +
  theme_bw() + theme(legend.position = "none", 
                     axis.text.x = element_blank(), axis.ticks.x = element_blank()) +
  labs(x = " ", y = "Probabilidad inclusión a posteriori") +
  coord_cartesian(ylim = c(0, 1)) +
  facet_wrap(~ method, ncol = 5)
```


Porcentaje de variables agrupadas incorrectamente seleccionadas e incorrectamente no seleccionadas:

```{r}
# Calculamos las vars agrupadas incorrectamente seleccionadas
previas <- c("BAS", "SB", "Const-Const", "SB-Const", "SB-SB")
matriz <- c()
for (j in 1:length(previas)) {
  matriz <- c(matriz,
              nrow(exp3vars[exp3vars[,3] == "false" & exp3vars[,1] > 0.5 & 
                              (exp3vars$pG > 0.5 | is.na(exp3vars$pG)) &
                exp3vars$method == previas[j] & exp3vars$Grupos == "G1" &
                  exp3vars$dfs == "df2.2",])/(2*10)*100,
              nrow(exp3vars[exp3vars[,3] == "false" & exp3vars[,1] > 0.5 &
                              (exp3vars$pG > 0.5 | is.na(exp3vars$pG)) &
                exp3vars$method == previas[j] & exp3vars$Grupos == "G2" &
                  exp3vars$dfs == "df2.2",])/(2*10)*100,
              nrow(exp3vars[exp3vars[,3] == "false" & exp3vars[,1] > 0.5 &
                              (exp3vars$pG > 0.5 | is.na(exp3vars$pG)) &
                exp3vars$method == previas[j] & exp3vars$Grupos == "G3" &
                  exp3vars$dfs == "df2.2",])/(8*10)*100,
               nrow(exp3vars[exp3vars[,3] == "false" & exp3vars[,1] > 0.5 &
                               (exp3vars$pG > 0.5 | is.na(exp3vars$pG)) &
                exp3vars$method == previas[j] & exp3vars$Grupos == "G4" &
                  exp3vars$dfs == "df2.2",])/(4*10)*100)
}
matriz <- paste0(matriz, "%")
matriz <- matrix(matriz, ncol = 5)
rownames(matriz) <- c("G1", "G2", "G3", "G4")
colnames(matriz) <- previas
kable(t(matriz), caption = "Porcentaje de variables agrupadas incorrectamente 
      seleccionadas para cada previa elegida.") %>%
  kable_styling()

# Calculamos las vars agrupadas incorrectamente no seleccionadas
matriz <- c()
for (j in 1:length(previas)) {
  matriz <- c(matriz,
              nrow(exp3vars[exp3vars[,3] == "true" & ((exp3vars[,1] < 0.5 & is.na(exp3vars$pG)) | (exp3vars$method!= "BAS" & (exp3vars[,1] < 0.5 | exp3vars$pG <0.5))) &
                exp3vars$method == previas[j] & exp3vars$Grupos == "G1"&
                  exp3vars$dfs == "df2.2",])/(6*10)*100,
              nrow(exp3vars[exp3vars[,3] == "true" & ((exp3vars[,1] < 0.5 & is.na(exp3vars$pG)) | (exp3vars$method!= "BAS" & (exp3vars[,1] < 0.5 | exp3vars$pG <0.5))) &
                exp3vars$method == previas[j] & exp3vars$Grupos == "G2"&
                  exp3vars$dfs == "df2.2",])/(2*10)*100)
}
matriz <- paste0(matriz, "%")
matriz <- matrix(matriz, ncol = 5)
rownames(matriz) <- c("G1", "G2")
colnames(matriz) <- previas
kable(t(matriz), caption = "Porcentaje de variables agrupadas incorrectamente 
      no seleccionadas para cada previa elegida.") %>%
  kable_styling()
```

### Frecuentista

```{r, eval = FALSE}
## Función para simular los datos de una regresión logística a partir de una 
# normal multivariante y los coeficientes especificados en 4.3
sim_log_regrs3 <- function (size, num_vars, beta_1, beta_2) {
  
  A <- matrix(runif(num_vars[1] ^ 2) * 2 - 1, ncol = num_vars[1])
  Sigma1 <- t(A) %*% A
  A <- matrix(runif(num_vars[2] ^ 2) * 2 - 1, ncol = num_vars[2]) 
  Sigma2 <- t(A) %*% A
  
  # genero las variables del predictor lineal a partir de una normal multivar
  X1 <- MASS::mvrnorm(size, mu = rep(0, nrow(Sigma1)), Sigma = Sigma1)
  X2 <- MASS::mvrnorm(size, mu = rep(0, nrow(Sigma2)), Sigma = Sigma2)
  X1 <- scale(X1, center = TRUE, scale = TRUE)
  X2 <- scale(X2, center = TRUE, scale = TRUE)
  
  intercepto <- 1
  cita <- intercepto + X1 %*% beta_1 + X2 %*% beta_2 # predictor lineal
  prob <- 1 / (1 + exp(-cita))
  y <- rbinom(n = size, size = 1, prob = prob) 
  
  df <- data.frame(y, X1, X2) # datos simulados originales
  nombres <-c("Y")
  for (i in 1:2){
    for(j in 1:num_vars[i]){
      nombres <- c(nombres, paste0("X",i,".",j))
    }
  }
  names(df) <- nombres
  return(df)
}
## Función auxiliar para introducir los grupos espurios
simulador_esp <- function (p, df, size, num_vars) {
  if (p < 3) stop("Como mínimo debe haber 3 grupos para comparar.")
  nombres <- names(df)
  for (i in 3:p) {
    A <- matrix(runif(num_vars[i] ^ 2) * 2 - 1, ncol = num_vars[i])
    Sigma <- t(A) %*% A # como antes
    
    X <- MASS::mvrnorm(size, mu = rep(0, nrow(Sigma)), Sigma = Sigma)
    X <- scale(X, center = TRUE, scale = TRUE)
    df <- data.frame(df, X) # banco de datos con vars espurias
    
    for (j in 1:num_vars[i]) {
      nombres <- c(nombres, paste0("X",i,".",j))
    }
  }
  names(df) <- nombres
  return(df)
}

n <- c(300, 600) # ??
num_vars <- c(8, 4, 8, 4)
p <- length(num_vars)
previas <- c("ConstConst", "SBConst",  "SBSB", "SB")
# Genero los datos simulados
set.seed(123)
listadf1 <- listadf2 <- listasimdf1 <- listasimdf2 <- list()
listadf1[[1]] <- listadf1[[2]] <- listadf2[[1]] <- listadf2[[2]] <- list()
listasimdf1[[1]] <- listasimdf1[[2]] <- listasimdf2[[1]] <- listasimdf2[[2]] <- list()
for (i in 1:10) {
  beta_1 <- c(0, 0, 0.55, 0.55, 0.55, 0.55, -0.49, -0.49)
  beta_2 <- c(0, 0, 0.46, 0.46)
  # df1 con beta_1, beta_2 y n=300
  listadf1[[1]][[i]] <- sim_log_regrs3(size = n[1], num_vars = num_vars[1:2],
                                       beta_1 = beta_1, beta_2 = beta_2)
  listasimdf1[[1]][[i]] <- simulador_esp(p, listadf1[[1]][[i]], n[1], num_vars)
  # df1 con beta_1, beta_2 y n=600
  listadf1[[2]][[i]] <- sim_log_regrs3(size = n[2], num_vars = num_vars[1:2],
                                       beta_1 = beta_1, beta_2 = beta_2)
  listasimdf1[[2]][[i]] <- simulador_esp(p, listadf1[[2]][[i]], n[2], num_vars)

  beta_1 <- c(0.42, rep(0, 6), -0.4)
  beta_2 <- c(0.35, 0, 0, -0.3)
  # df2 con beta_1, beta_2 y n=300
  listadf2[[1]][[i]] <- sim_log_regrs3(size = n[1], num_vars = num_vars[1:2],
                                       beta_1 = beta_1, beta_2 = beta_2)
  listasimdf2[[1]][[i]] <- simulador_esp(p, listadf2[[1]][[i]], n[1], num_vars)
  # df2 con beta_1, beta_2 y n=600
  listadf2[[2]][[i]] <- sim_log_regrs3(size = n[2], num_vars = num_vars[1:2],
                                       beta_1 = beta_1, beta_2 = beta_2)
  listasimdf2[[2]][[i]] <- simulador_esp(p, listadf2[[2]][[i]], n[2], num_vars)
}
```


```{r}
### grLasso, grMCP, grSCAD
group <- c(rep(1,8), rep(2,4), rep(3,8), rep(4,4))

sel.frec <- function(dfsim, group) {
  result <- list()
  metodos <- c("grLasso", "grMCP", "grSCAD")
  for (i in 1:3) {
    result[[i]] <- grpreg(dfsim[,-1],
                          dfsim$Y,
                          penalty = metodos[i],
                          family = c("binomial"),
                          group = group)
  }
  return(result)
}
# resultadosfrec1 <- resultadosfrec2 <- list()
# resultadosfrec1[[1]] <- resultadosfrec1[[2]] <- resultadosfrec2[[1]] <- resultadosfrec2[[2]] <- list()
# for (i in 1:10){
#   resultadosfrec1[[1]][[i]] <- sel.frec(listasimdf1[[1]][[i]], group) #df1, n=300
#   resultadosfrec1[[2]][[i]] <- sel.frec(listasimdf1[[2]][[i]], group) #df1, n=600
#   
#   resultadosfrec2[[1]][[i]] <- sel.frec(listasimdf2[[1]][[i]], group) #df2, n=300
#   resultadosfrec2[[2]][[i]] <- sel.frec(listasimdf2[[2]][[i]], group) #df2, n=600
# }
# save(resultadosfrec1, file = "./Resultados_simulados/resultadosfrec1.Rdata")
# save(resultadosfrec2, file = "./Resultados_simulados/resultadosfrec2.Rdata")
load("./Resultados_simulados/resultadosfrec1.Rdata")
load("./Resultados_simulados/resultadosfrec2.Rdata")

indices <- c(0,8,12,20,24)
# df1, n = 300
prop <- rep(0,4)
for (i in 1:10) {
  for ( j in 2:5){
    sel <- select(resultadosfrec1[[1]][[i]][[1]])$beta[-1] # gLasso
    if(sum(sel[(indices[j - 1] + 1):indices[j]]) > 0) {
      prop[j - 1] <- prop[j - 1] + 1
    }
  }
}
## Proporción de veces que no incluye a los dos primeros grupos 
# y que sí incluye a los dos últimos
prop <- prop/10; prop[1:2] <- 1 - prop[1:2]
names(prop) <- paste0("G", 1:4)
kable(as.matrix(prop), caption = "Proporción de grupos incorrectamente 
      seleccionados e incorrectamente no seleccionados con gLasso para
      el primer banco de datos con n = 300.")

# df1, n = 600
prop <- rep(0,4)
for (i in 1:10) {
  for ( j in 2:5){
    sel <- select(resultadosfrec1[[2]][[i]][[1]])$beta[-1]
    if(sum(sel[(indices[j - 1] + 1):indices[j]]) > 0) {
      prop[j - 1] <- prop[j - 1] + 1
    }
  }
}
## Proporción de veces que no incluye a los dos primeros grupos 
# y que sí incluye a los dos últimos
prop <- prop/10; prop[1:2] <- 1 - prop[1:2]
names(prop) <- paste0("G", 1:4)
kable(as.matrix(prop), caption = "Proporción de grupos incorrectamente 
      seleccionados e incorrectamente no seleccionados con gLasso para 
      el primer banco de datos con n = 600.")

# df2, n = 300
prop <- rep(0,4)
for (i in 1:10) {
  for ( j in 2:5){
    sel <- select(resultadosfrec2[[1]][[i]][[1]])$beta[-1]
    if(sum(sel[(indices[j - 1] + 1):indices[j]]) > 0) {
      prop[j - 1] <- prop[j - 1] + 1
    }
  }
}
## Proporción de veces que no incluye a los dos primeros grupos 
# y que sí incluye a los dos últimos
prop <- prop/10; prop[1:2] <- 1 - prop[1:2]
names(prop) <- paste0("G", 1:4)
kable(as.matrix(prop), caption = "Proporción de grupos incorrectamente 
      seleccionados e incorrectamente no seleccionados con gLasso para 
      el segundo banco de datos con n = 300.")

# df2, n = 600
prop <- rep(0,4)
for (i in 1:10) {
  for ( j in 2:5){
    sel <- select(resultadosfrec2[[2]][[i]][[1]])$beta[-1]
    if(sum(sel[(indices[j - 1] + 1):indices[j]]) > 0) {
      prop[j - 1] <- prop[j - 1] + 1
    }
  }
}
## Proporción de veces que no incluye a los dos primeros grupos 
# y que sí incluye a los dos últimos
prop <- prop/10; prop[1:2] <- 1 - prop[1:2]
names(prop) <- paste0("G", 1:4)
kable(as.matrix(prop), caption = "Proporción de grupos incorrectamente 
      seleccionados e incorrectamente no seleccionados con gLasso para 
      el segundo banco de datos con n = 600.")
```

```{r}
# df1, n = 300
prop <- rep(0,4)
for (i in 1:10) {
  for ( j in 2:5){
    sel <- select(resultadosfrec1[[1]][[i]][[2]])$beta[-1] # gMCP
    if(sum(sel[(indices[j - 1] + 1):indices[j]]) > 0) {
      prop[j - 1] <- prop[j - 1] + 1
    }
  }
}
## Proporción de veces que no incluye a los dos primeros grupos 
# y que sí incluye a los dos últimos
prop <- prop/10; prop[1:2] <- 1 - prop[1:2]
names(prop) <- paste0("G", 1:4)
kable(as.matrix(prop), caption = "Proporción de grupos incorrectamente 
      seleccionados e incorrectamente no seleccionados con gMCP para el 
      primer banco de datos con n = 300.")

# df1, n = 600
prop <- rep(0,4)
for (i in 1:10) {
  for ( j in 2:5){
    sel <- select(resultadosfrec1[[2]][[i]][[2]])$beta[-1]
    if(sum(sel[(indices[j - 1] + 1):indices[j]]) > 0) {
      prop[j - 1] <- prop[j - 1] + 1
    }
  }
}
## Proporción de veces que no incluye a los dos primeros grupos 
# y que sí incluye a los dos últimos
prop <- prop/10; prop[1:2] <- 1 - prop[1:2]
names(prop) <- paste0("G", 1:4)
kable(as.matrix(prop), caption = "Proporción de grupos incorrectamente 
      seleccionados e incorrectamente no seleccionados con gMCP para el
      primer banco de datos con n = 600.")

# df2, n = 300
prop <- rep(0,4)
for (i in 1:10) {
  for ( j in 2:5){
    sel <- select(resultadosfrec2[[1]][[i]][[2]])$beta[-1]
    if(sum(sel[(indices[j - 1] + 1):indices[j]]) > 0) {
      prop[j - 1] <- prop[j - 1] + 1
    }
  }
}
## Proporción de veces que no incluye a los dos primeros grupos 
# y que sí incluye a los dos últimos
prop <- prop/10; prop[1:2] <- 1 - prop[1:2]
names(prop) <- paste0("G", 1:4)
kable(as.matrix(prop), caption = "Proporción de grupos incorrectamente 
      seleccionados e incorrectamente no seleccionados con gMCP para el
      segundo banco de datos con n = 300.")

# df2, n = 600
prop <- rep(0,4)
for (i in 1:10) {
  for ( j in 2:5){
    sel <- select(resultadosfrec2[[2]][[i]][[2]])$beta[-1]
    if(sum(sel[(indices[j - 1] + 1):indices[j]]) > 0) {
      prop[j - 1] <- prop[j - 1] + 1
    }
  }
}
## Proporción de veces que no incluye a los dos primeros grupos 
# y que sí incluye a los dos últimos
prop <- prop/10; prop[1:2] <- 1 - prop[1:2]
names(prop) <- paste0("G", 1:4)
kable(as.matrix(prop), caption = "Proporción de grupos incorrectamente 
      seleccionados e incorrectamente no seleccionados con gMCP para el
      segundo banco de datos con n = 600.")
```

```{r}
# df1, n = 300
prop <- rep(0,4)
for (i in 1:10) {
  for ( j in 2:5){
    sel <- select(resultadosfrec1[[1]][[i]][[3]])$beta[-1] # gSCAD
    if(sum(sel[(indices[j - 1] + 1):indices[j]]) > 0) {
      prop[j - 1] <- prop[j - 1] + 1
    }
  }
}
## Proporción de veces que no incluye a los dos primeros grupos 
# y que sí incluye a los dos últimos
prop <- prop/10; prop[1:2] <- 1 - prop[1:2]
names(prop) <- paste0("G", 1:4)
kable(as.matrix(prop), caption = "Proporción de grupos incorrectamente 
      seleccionados e incorrectamente no seleccionados con gSCAD para 
      el primer banco de datos con n = 300.")

# df1, n = 600
prop <- rep(0,4)
for (i in 1:10) {
  for ( j in 2:5){
    sel <- select(resultadosfrec1[[2]][[i]][[3]])$beta[-1]
    if(sum(sel[(indices[j - 1] + 1):indices[j]]) > 0) {
      prop[j - 1] <- prop[j - 1] + 1
    }
  }
}
## Proporción de veces que no incluye a los dos primeros grupos 
# y que sí incluye a los dos últimos
prop <- prop/10; prop[1:2] <- 1 - prop[1:2]
names(prop) <- paste0("G", 1:4)
kable(as.matrix(prop), caption = "Proporción de grupos incorrectamente 
      seleccionados e incorrectamente no seleccionados con gSCAD para 
      el primer banco de datos con n = 600.")

# df2, n = 300
prop <- rep(0,4)
for (i in 1:10) {
  for ( j in 2:5){
    sel <- select(resultadosfrec2[[1]][[i]][[3]])$beta[-1]
    if(sum(sel[(indices[j - 1] + 1):indices[j]]) > 0) {
      prop[j - 1] <- prop[j - 1] + 1
    }
  }
}
## Proporción de veces que no incluye a los dos primeros grupos 
# y que sí incluye a los dos últimos
prop <- prop/10; prop[1:2] <- 1 - prop[1:2]
names(prop) <- paste0("G", 1:4)
kable(as.matrix(prop), caption = "Proporción de grupos incorrectamente 
      seleccionados e incorrectamente no seleccionados con gSCAD para 
      el segundo banco de datos con n = 300.")

#df2, n=600
prop <- rep(0,4)
for (i in 1:10) {
  for ( j in 2:5){
    sel <- select(resultadosfrec2[[2]][[i]][[3]])$beta[-1]
    if(sum(sel[(indices[j - 1] + 1):indices[j]]) > 0) {
      prop[j - 1] <- prop[j - 1] + 1
    }
  }
}
## Proporción de veces que no incluye a los dos primeros grupos 
# y que sí incluye a los dos últimos
prop <- prop/10; prop[1:2] <- 1 - prop[1:2]
names(prop) <- paste0("G", 1:4)
kable(as.matrix(prop), caption = "Proporción de grupos incorrectamente 
      seleccionados e incorrectamente no seleccionados con gSCAD para el
      segundo banco de datos con n = 600.")
```

# Experimento 4

## Experimento 4.0 

Los datos los genero con:

$\theta = 1 + \beta_1X_1 + \beta_2X_2+ \beta_3X_3$, $\pi=\frac{e^{\theta}}{1 + e^{\theta}}$ e $Y\sim Ber(\pi)$.

Los coeficientes de los grupos los genero con una normal de media 0.5 y desviación típica 0.1, 0.15, 0.2, respectivamente.

### Grupos
 
 En general:

```{r, fig.width = 6, fig.height = 4, fig.align = "center", fig.cap = ' ', results='hide'}
method <- grupos <- probs <- c()
n_vars <- c(5, 7, 9)
for (i in 1:10) {
  load(paste0("./Resultados_simulados/E4/resultado6.1.", i,".Rdata"))
  load(paste0("./Resultados_simulados/E4/resultado6.2.", i,".Rdata"))
  load(paste0("./Resultados_simulados/E4/resultado6.3.", i,".Rdata"))
  load(paste0("./Resultados_simulados/E4/resultado6.1.", i,"SB.Rdata"))
  load(paste0("./Resultados_simulados/E4/resultado6.2.", i,"SB.Rdata"))
  load(paste0("./Resultados_simulados/E4/resultado6.3.", i,"SB.Rdata"))
  probs <- c(probs,
             resultado6.1[[1]]$inclprob[resultado6.1[[1]]$inclprob[,1] != "-",1], # CC
             resultado6.1[[2]]$inclprob[resultado6.1[[2]]$inclprob[,1] != "-",1], # SBC
             resultado6.1[[3]]$inclprob[resultado6.1[[3]]$inclprob[,1] != "-",1], # SBSB
             resultado6.1SB[[1]]$inclprob[resultado6.1SB[[1]]$inclprob[,1] != "-",1], # SB
             resultado6.2[[1]]$inclprob[resultado6.2[[1]]$inclprob[,1] != "-",1], 
             resultado6.2[[2]]$inclprob[resultado6.2[[2]]$inclprob[,1] != "-",1],
             resultado6.2[[3]]$inclprob[resultado6.2[[3]]$inclprob[,1] != "-",1],
             resultado6.2SB[[1]]$inclprob[resultado6.2SB[[1]]$inclprob[,1] != "-",1],
             resultado6.3[[1]]$inclprob[resultado6.3[[1]]$inclprob[,1] != "-",1],
             resultado6.3[[2]]$inclprob[resultado6.3[[2]]$inclprob[,1] != "-",1],
             resultado6.3[[3]]$inclprob[resultado6.3[[3]]$inclprob[,1] != "-",1],
             resultado6.3SB[[1]]$inclprob[resultado6.3SB[[1]]$inclprob[,1] != "-",1])
  
  for (j in 1:3) {
    method <- c(method,
                rep("Const-Const", 3), rep("SB-Const", 3), 
                rep("SB-SB", 3), rep("SB", 3))
    grupos <- c(grupos, 
                rep(c("G1", "G2", "G3"), 4))
  }
}

pr <- rep(c(rep(n_vars[1], 12), rep(n_vars[2], 12),
                          rep(n_vars[3], 12)), 10)
probs <- as.numeric(probs)
method <- factor(method, levels = c("SB", "Const-Const", "SB-Const", "SB-SB"))
pr <- factor(pr)
grupos <- factor(grupos)

exp4 <- data.frame(pr, probs, method, grupos)

cols <- paletteer_d("ggthemes::wsj_rgby")
ggplot(data = exp4, aes(x = pr, y = probs, fill = grupos)) +
  geom_boxplot(alpha = 0.7, outlier.colour = 1) +
  scale_fill_manual(values = cols) +
  geom_hline(yintercept = 0.5, linetype = 2, color = 8, alpha = 0.5, linewidth = 1) +
  labs(x = "Número de variables por grupo", 
       y = "Probabilidad inclusión a posteriori") +
  theme_bw() + guides(fill = guide_legend(title = "Grupos")) +
  facet_wrap(~ method, ncol = 4) + coord_cartesian(ylim = c(0, 1))
```

### Variables agrupadas
 
En general:
 
```{r, fig.width = 6, fig.height = 4, fig.align = "center", fig.cap = ' '}
method <- Grupos <- probs <- Vars <- c()
n_vars <- c(5, 7, 9)
indices1 <- c(2:6, 8:12, 14:18)
indices2 <- c(2:8, 10:16, 18:24)
indices3 <- c(2:10, 12:20, 22:30)
for (i in 1:10) {
  load(paste0("./Resultados_simulados/E4/resultado6.1.", i,".Rdata"))
  load(paste0("./Resultados_simulados/E4/resultado6.2.", i,".Rdata"))
  load(paste0("./Resultados_simulados/E4/resultado6.3.", i,".Rdata"))
  load(paste0("./Resultados_simulados/E4/resultado6.1.", i,"SB.Rdata"))
  load(paste0("./Resultados_simulados/E4/resultado6.2.", i,"SB.Rdata"))
  load(paste0("./Resultados_simulados/E4/resultado6.3.", i,"SB.Rdata"))
  probs <- c(probs,
             resultado6.1[[1]]$inclprob[indices1, 2], # CC
             resultado6.1[[2]]$inclprob[indices1, 2], # SBC
             resultado6.1[[3]]$inclprob[indices1, 2], # SBSB
             resultado6.1SB[[1]]$inclprob[indices1, 2], # SB
             resultado6.2[[1]]$inclprob[indices2, 2], 
             resultado6.2[[2]]$inclprob[indices2, 2],
             resultado6.2[[3]]$inclprob[indices2, 2],
             resultado6.2SB[[1]]$inclprob[indices2, 2],
             resultado6.3[[1]]$inclprob[indices3, 2],
             resultado6.3[[2]]$inclprob[indices3, 2],
             resultado6.3[[3]]$inclprob[indices3, 2],
             resultado6.3SB[[1]]$inclprob[indices3, 2])
  
  for (j in 1:3) {
    method <- c(method,
                rep("Const-Const", n_vars[j]*3), rep("SB-Const", n_vars[j]*3), 
                rep("SB-SB", n_vars[j]*3), rep("SB", n_vars[j]*3))
    Grupos <- c(Grupos, 
                rep(c(rep("G1", n_vars[j]), rep("G2", n_vars[j]), 
                      rep("G3", n_vars[j])), 4))
    Vars <- c(Vars,
              rep(c(paste0("1.", 1:n_vars[j]), paste0("2.", 1:n_vars[j]), 
                paste0("3.", 1:n_vars[j])), 4))
  }
}

pr <- rep(c(rep(n_vars[1], n_vars[1]*12), rep(n_vars[2], n_vars[2]*12),
                          rep(n_vars[3], n_vars[3]*12)), 10)

probs <- as.numeric(probs)
method <- factor(method, levels = c("SB", "Const-Const", "SB-Const", "SB-SB"))
pr <- factor(pr)
Grupos <- factor(Grupos)
Vars <- factor(Vars, levels = c(paste0("1.", 1:n_vars[3]), 
                                paste0("2.", 1:n_vars[3]), 
                                paste0("3.", 1:n_vars[3])))

exp4vars <- data.frame(pr, probs, method, Grupos, Vars)

cols <- paletteer_d("ggthemes::wsj_rgby")
ggplot(data = exp4vars, aes(x = pr, y = probs, fill = Grupos)) +
  geom_boxplot(alpha = 0.7, outlier.colour = 1) +
  scale_fill_manual(values = cols) +
  geom_hline(yintercept = 0.5, linetype = 2, color = 8, alpha = 0.5, linewidth = 1) +
  labs(x = "Número de variables por grupo", 
       y = "Probabilidad inclusión a posteriori") +
  theme_bw() + guides(fill = guide_legend(title = "Grupos")) +
  facet_wrap(~ method, ncol = 4) + coord_cartesian(ylim = c(0, 1))
```

En función del número de variables:

```{r, fig.width = 6, fig.height = 4, fig.align = "center", fig.cap = ' '}
cols <- paletteer_d("ggthemes::wsj_rgby")
ggplot(data = exp4vars[exp4vars$pr == 5,], aes(x = Grupos, y = probs, fill = Grupos)) +
  geom_boxplot(alpha = 0.7, outlier.colour = 1) +
  scale_fill_manual(values = cols) + 
  geom_hline(yintercept = 0.5, linetype = 2, color = 8, alpha = 0.5, linewidth = 1) +
  labs(x = "5 variables por grupo", y = "Probabilidad inclusión a posteriori") +
  theme_bw() + theme(legend.position = "none")+
  facet_wrap(~ method, ncol = 4) + coord_cartesian(ylim = c(0, 1))

ggplot(data = exp4vars[exp4vars$pr == 7,], aes(x = Grupos, y = probs, fill = Grupos)) +
  geom_boxplot(alpha = 0.7, outlier.colour = 1) +
  scale_fill_manual(values = cols) +
  geom_hline(yintercept = 0.5, linetype = 2, color = 8, alpha = 0.5, linewidth = 1) +
  labs(x = "7 variables por grupo", y = "Probabilidad inclusión a posteriori") +
  theme_bw() + theme(legend.position = "none")+
  facet_wrap(~ method, ncol = 4) + coord_cartesian(ylim = c(0, 1))

ggplot(data = exp4vars[exp4vars$pr == 9,], aes(x = Grupos, y = probs, fill = Grupos)) +
  geom_boxplot(alpha = 0.7, outlier.colour = 1) +
  scale_fill_manual(values = cols) +
  geom_hline(yintercept = 0.5, linetype = 2, color = 8, alpha = 0.5, linewidth = 1) +
  labs(x = "9 variables por grupo", y = "Probabilidad inclusión a posteriori") +
  theme_bw() + theme(legend.position = "none")+
  facet_wrap(~ method, ncol = 4) + coord_cartesian(ylim = c(0, 1))
```

```{r, fig.width = 10, fig.height = 6, fig.align = "center", fig.cap = ' '}
cols <- paletteer_d("ggthemes::wsj_rgby")
ggplot(data = exp4vars[exp4vars$pr == 5,], aes(x = Vars, y = probs, fill = Grupos)) +
  geom_boxplot(alpha = 0.7, outlier.colour = 1) +
  scale_fill_manual(values = cols) +
  geom_hline(yintercept = 0.5, linetype = 2, color = 8, alpha = 0.5, linewidth = 1) +
  labs(x = "5 variables por grupo", y = "Probabilidad inclusión a posteriori") +
  theme_bw() + theme(axis.text.x = element_blank(), axis.ticks.x = element_blank()) +
  facet_wrap(~ method, ncol = 4) + coord_cartesian(ylim = c(0, 1))

ggplot(data = exp4vars[exp4vars$pr == 7,], aes(x = Vars, y = probs, fill = Grupos)) +
  geom_boxplot(alpha = 0.7, outlier.colour = 1) +
  scale_fill_manual(values = cols) +
  geom_hline(yintercept = 0.5, linetype = 2, color = 8, alpha = 0.5, linewidth = 1) +
  labs(x = "7 variables por grupo", y = "Probabilidad inclusión a posteriori") +
  theme_bw() + theme(axis.text.x = element_blank(), axis.ticks.x = element_blank()) +
  facet_wrap(~ method, ncol = 4) + coord_cartesian(ylim = c(0, 1))

ggplot(data = exp4vars[exp4vars$pr == 9,], aes(x = Vars, y = probs, fill = Grupos)) +
  geom_boxplot(alpha = 0.7, outlier.colour = 1) +
  scale_fill_manual(values = cols) +
  geom_hline(yintercept = 0.5, linetype = 2, color = 8, alpha = 0.5, linewidth = 1) +
  labs(x = "9 variables por grupo", y = "Probabilidad inclusión a posteriori") +
  theme_bw() + theme(axis.text.x = element_blank(), axis.ticks.x = element_blank()) +
  facet_wrap(~ method, ncol = 4) + coord_cartesian(ylim = c(0, 1))
```

Porcentaje de variables agrupadas incorrectamente no seleccionados:

```{r}
previas <- c("SB", "Const-Const", "SB-Const", "SB-SB")

# Calculamos los grupos incorrectamente no seleccionados
# SB
matriz <- c()
for (j in 1:3) {
  matriz <- c(matriz, 
              nrow(exp4vars[exp4vars[,2] < 0.5 & exp4vars$Grupos == paste0("G", j) &
                exp4vars$method == previas[1] & exp4vars$pr == 5,])/(5*10)*100,
              nrow(exp4vars[exp4vars[,2] < 0.5 & exp4vars$Grupos == paste0("G", j) &
                exp4vars$method == previas[1] & exp4vars$pr == 7,])/(7*10)*100,
              nrow(exp4vars[exp4vars[,2] < 0.5 & exp4vars$Grupos == paste0("G", j) &
                exp4vars$method == previas[1] & exp4vars$pr == 9,])/(9*10)*100)
}
matriz <- paste0(matriz, "%")
matriz <- matrix(matriz, ncol = 3)
rownames(matriz) <- paste0( "Num vars = ", unique(exp4$pr))
colnames(matriz) <- paste0("G", 1:3)
kable(matriz, caption = "Porcentaje de variables agrupadas incorrectamente no seleccionadas para SB.") %>%
  kable_styling()

# Const-Const
matriz <- c()
for (j in 1:3) {
  matriz <- c(matriz, 
              nrow(exp4vars[exp4vars[,2] < 0.5 & exp4vars$Grupos == paste0("G", j) &
                exp4vars$method == previas[2] & exp4vars$pr == 5,])/(5*10)*100,
              nrow(exp4vars[exp4vars[,2] < 0.5 & exp4vars$Grupos == paste0("G", j) &
                exp4vars$method == previas[2] & exp4vars$pr == 7,])/(7*10)*100,
              nrow(exp4vars[exp4vars[,2] < 0.5 & exp4vars$Grupos == paste0("G", j) &
                exp4vars$method == previas[2] & exp4vars$pr == 9,])/(9*10)*100)
}
matriz <- paste0(matriz, "%")
matriz <- matrix(matriz, ncol = 3)
rownames(matriz) <- paste0( "Num vars = ", unique(exp4$pr))
colnames(matriz) <- paste0("G", 1:3)
kable(matriz, caption = "Porcentaje de variables agrupadas incorrectamente no seleccionadas para Const-Const.") %>%
  kable_styling()

# SB-Const
matriz <- c()
for (j in 1:3) {
  matriz <- c(matriz, 
              nrow(exp4vars[exp4vars[,2] < 0.5 & exp4vars$Grupos == paste0("G", j) &
                exp4vars$method == previas[3] & exp4vars$pr == 5,])/(5*10)*100,
              nrow(exp4vars[exp4vars[,2] < 0.5 & exp4vars$Grupos == paste0("G", j) &
                exp4vars$method == previas[3] & exp4vars$pr == 7,])/(7*10)*100,
              nrow(exp4vars[exp4vars[,2] < 0.5 & exp4vars$Grupos == paste0("G", j) &
                exp4vars$method == previas[3] & exp4vars$pr == 9,])/(9*10)*100)
}
matriz <- paste0(matriz, "%")
matriz <- matrix(matriz, ncol = 3)
rownames(matriz) <- paste0( "Num vars = ", unique(exp4$pr))
colnames(matriz) <- paste0("G", 1:3)
kable(matriz, caption = "Porcentaje de variables agrupadas incorrectamente no seleccionadas para SB-Const.") %>%
  kable_styling()

# SB-SB
matriz <- c()
for (j in 1:3) {
  matriz <- c(matriz, 
              nrow(exp4vars[exp4vars[,2] < 0.5 & exp4vars$Grupos == paste0("G", j) &
                exp4vars$method == previas[4] & exp4vars$pr == 5,])/(5*10)*100,
              nrow(exp4vars[exp4vars[,2] < 0.5 & exp4vars$Grupos == paste0("G", j) &
                exp4vars$method == previas[4] & exp4vars$pr == 7,])/(7*10)*100,
              nrow(exp4vars[exp4vars[,2] < 0.5 & exp4vars$Grupos == paste0("G", j) &
                exp4vars$method == previas[4] & exp4vars$pr == 9,])/(9*10)*100)
}
matriz <- paste0(matriz, "%")
matriz <- matrix(matriz, ncol = 3)
rownames(matriz) <- paste0( "Num vars = ", unique(exp4$pr))
colnames(matriz) <- paste0("G", 1:3)
kable(matriz, caption = "Porcentaje de variables agrupadas incorrectamente no seleccionadas para SB-SB.") %>%
  kable_styling()
```

### Con BAS

```{r, fig.width = 6, fig.height = 4, fig.align = "center", fig.cap = ' '}
cols <- paletteer_d("ggthemes::wsj_rgby")
Grupos <- probs <- Vars <- c()
n_vars <- c(5, 7, 9)
for ( i in 1:10) {
  load(paste0("./Resultados_simulados/E4/resultado6.1.BAS.", i,".Rdata"))
  load(paste0("./Resultados_simulados/E4/resultado6.2.BAS.", i,".Rdata"))
  load(paste0("./Resultados_simulados/E4/resultado6.3.BAS.", i,".Rdata"))
  
  probs <- c(probs,
             resultado6.1.BAS$probne0[-1],
             resultado6.2.BAS$probne0[-1],
             resultado6.3.BAS$probne0[-1])
  
    for (j in 1:3) {
    Grupos <- c(Grupos, 
                c(rep("G1", n_vars[j]), rep("G2", n_vars[j]), 
                      rep("G3", n_vars[j])))
    Vars <- c(Vars,
              c(paste0("1.", 1:n_vars[j]), paste0("2.", 1:n_vars[j]), 
                paste0("3.", 1:n_vars[j])))
  }
}

pr <- rep(c(rep(n_vars[1], n_vars[1]*3), rep(n_vars[2], n_vars[2]*3),
                          rep(n_vars[3], n_vars[3]*3)), 10)
pr <- paste0(pr, " variables")
probs <- as.numeric(probs)
pr <- factor(pr)
Grupos <- factor(Grupos)
Vars <- factor(Vars, levels = c(paste0("1.", 1:n_vars[3]), 
                                paste0("2.", 1:n_vars[3]), 
                                paste0("3.", 1:n_vars[3])))
exp4BAS <- data.frame(probs, Grupos, Vars, pr)

ggplot(data = exp4BAS, aes(x = Grupos, y = probs, fill = Grupos)) +
  geom_boxplot(alpha = 0.7, outlier.colour = 1) +
  scale_fill_manual(values = cols) +
  geom_hline(yintercept = 0.5, linetype = 2, color = 8, alpha = 0.5, linewidth = 1) +
  labs(x = " ", y = "Probabilidad inclusión a posteriori", subtitle = "Número de variables por grupo") +
  theme_bw() + theme(legend.position = "none") +
  facet_wrap(~ pr, ncol = 4) + coord_cartesian(ylim = c(0, 1))
```

```{r, fig.width = 10, fig.height = 6, fig.align = "center", fig.cap = ' '}
ggplot(data = exp4BAS, aes(x = Vars, y = probs, fill = Grupos)) +
  geom_boxplot(alpha = 0.7, outlier.colour = 1) +
  scale_fill_manual(values = cols) +
  geom_hline(yintercept = 0.5, linetype = 2, color = 8, alpha = 0.5, linewidth = 1) +
  labs(x = " ", y = "Probabilidad inclusión a posteriori", subtitle = "Número de variables por grupo") +
  theme_bw() + theme(axis.text.x = element_blank(), axis.ticks.x = element_blank()) +
  facet_wrap(~ pr, ncol = 3) + coord_cartesian(ylim = c(0, 1))
```


## Experimento 4.1

Los datos los genero con:

$\theta = 1 + \beta_1X_1 + \beta_2X_2+ \beta_3X_3$, $\pi=\frac{e^{\theta}}{1 + e^{\theta}}$ e $Y\sim Ber(\pi)$.

Los coeficientes de los grupos los genero con una normal de media 0.5 y desviación típica 0.1, 0.15, 0.2, respectivamente.

Generamos los datos cambiando la correlación de las variables de los grupos. Lo hago para $\rho =$ 0.5, 0.6, 0.7 y 0.8. Lo repito todo 5 veces.

### Grupos
 
En general:

```{r, fig.width = 6, fig.height = 4, fig.align = "center", fig.cap = ' ', results='hide'}
rho <- c(0.5, 0.6, 0.7, 0.8)
probs <- method <- Grupos <- rhos <- pr <- c()
n_vars <- c(5, 7, 9)
for (i in 1:5) {
  for (j in 1:length(rho)) {
    load(paste0("./Resultados_simulados/E4/resultadorho", j, ".1.",i,".Rdata"))
    load(paste0("./Resultados_simulados/E4/resultadorho", j, ".2.",i,".Rdata"))
    load(paste0("./Resultados_simulados/E4/resultadorho", j, ".3.",i,".Rdata"))
    load(paste0("./Resultados_simulados/E4/resultadorho", j, ".1.",i,"SB.Rdata"))
    load(paste0("./Resultados_simulados/E4/resultadorho", j, ".2.",i,"SB.Rdata"))
    load(paste0("./Resultados_simulados/E4/resultadorho", j, ".3.",i,"SB.Rdata"))
    
    rhos <- c(rhos, rep(rho[j], (sum(n_vars))*12))
    
    probs <- c(probs, 
               resultadorho1.1[[1]]$inclprob[resultadorho1.1[[1]]$inclprob[,1] != "-",1], # CC
               resultadorho1.1[[2]]$inclprob[resultadorho1.1[[2]]$inclprob[,1] != "-",1], # SBC
               resultadorho1.1[[3]]$inclprob[resultadorho1.1[[3]]$inclprob[,1] != "-",1], # SBSB
               resultadorho1.1SB[[1]]$inclprob[resultadorho1.1SB[[1]]$inclprob[,1] != "-",1], # SB SBSB
               resultadorho1.2[[1]]$inclprob[resultadorho1.2[[1]]$inclprob[,1] != "-",1], 
               resultadorho1.2[[2]]$inclprob[resultadorho1.2[[2]]$inclprob[,1] != "-",1],
               resultadorho1.2[[3]]$inclprob[resultadorho1.2[[3]]$inclprob[,1] != "-",1],
               resultadorho1.2SB[[1]]$inclprob[resultadorho1.2SB[[1]]$inclprob[,1] != "-",1],
               resultadorho1.3[[1]]$inclprob[resultadorho1.3[[1]]$inclprob[,1] != "-",1],
               resultadorho1.3[[2]]$inclprob[resultadorho1.3[[2]]$inclprob[,1] != "-",1],
               resultadorho1.3[[3]]$inclprob[resultadorho1.3[[3]]$inclprob[,1] != "-",1],
               resultadorho1.3SB[[1]]$inclprob[resultadorho1.3SB[[1]]$inclprob[,1] != "-",1])
    
    for (k in 1:3) {
      method <- c(method,
                  rep("Const-Const", 3), rep("SB-Const", 3), 
                  rep("SB-SB", 3), rep("SB", 3))
      Grupos <- c(Grupos, 
                  rep(c("G1", "G2", "G3"), 4))
    }
  }
}

pr <- rep(c(rep(n_vars[1], 12), rep(n_vars[2], 12), rep(n_vars[3], 12)), 20)

probs <- as.numeric(probs)
method <- factor(method, levels = c("SB", "Const-Const", "SB-Const", "SB-SB"))
pr <- factor(pr)
Grupos <- factor(Grupos)

exp4 <- data.frame(rhos, probs, method, Grupos, pr)
cols <- paletteer_d("ggthemes::wsj_rgby")
ggplot(data = exp4, aes(x = pr, y = probs, fill = Grupos)) +
  geom_boxplot(alpha = 0.7, outlier.colour = 1) +
  scale_fill_manual(values = cols) +
  geom_hline(yintercept = 0.5, linetype = 2, color = 8, alpha = 0.5, linewidth = 1) +
  labs(x = "Número de variables por grupo", y = "Probabilidad inclusión a posteriori") +
  theme_bw() + guides(fill = guide_legend(title = "Grupos")) +
  facet_wrap(~ method, ncol = 4) + coord_cartesian(ylim = c(0, 1))
```


 ### Variables agrupadas
  
En general:  

```{r, fig.width = 6, fig.height = 4, fig.align = "center", fig.cap = ' '}
rho <- c(0.5, 0.6, 0.7, 0.8)
probs <- method <- Grupos <- rhos <- pr <- Vars <- c()
n_vars <- c(5, 7, 9)
indices1 <- c(2:6, 8:12, 14:18)
indices2 <- c(2:8, 10:16, 18:24)
indices3 <- c(2:10, 12:20, 22:30)

for (i in 1:5) {
  for (j in 1:length(rho)) {
    load(paste0("./Resultados_simulados/E4/resultadorho", j, ".1.",i,".Rdata"))
    load(paste0("./Resultados_simulados/E4/resultadorho", j, ".2.",i,".Rdata"))
    load(paste0("./Resultados_simulados/E4/resultadorho", j, ".3.",i,".Rdata"))
    load(paste0("./Resultados_simulados/E4/resultadorho", j, ".1.",i,"SB.Rdata"))
    load(paste0("./Resultados_simulados/E4/resultadorho", j, ".2.",i,"SB.Rdata"))
    load(paste0("./Resultados_simulados/E4/resultadorho", j, ".3.",i,"SB.Rdata"))
    
    rhos <- c(rhos, rep(rho[j], (sum(n_vars))*12))
    probs <- c(probs, 
               resultadorho1.1[[1]]$inclprob[indices1, 2], # CC
               resultadorho1.1[[2]]$inclprob[indices1, 2], # SBC
               resultadorho1.1[[3]]$inclprob[indices1, 2], # SBSB
               resultadorho1.1SB[[1]]$inclprob[indices1, 2], # SB
               resultadorho1.2[[1]]$inclprob[indices2, 2], 
               resultadorho1.2[[2]]$inclprob[indices2, 2],
               resultadorho1.2[[3]]$inclprob[indices2, 2],
               resultadorho1.2SB[[1]]$inclprob[indices2, 2],
               resultadorho1.3[[1]]$inclprob[indices3, 2],
               resultadorho1.3[[2]]$inclprob[indices3, 2],
               resultadorho1.3[[3]]$inclprob[indices3, 2],
               resultadorho1.3SB[[1]]$inclprob[indices3, 2])
    
    for (k in 1:3) {
      method <- c(method,
                  rep("Const-Const", n_vars[k]*3), rep("SB-Const", n_vars[k]*3),
                  rep("SB-SB", n_vars[k]*3), rep("SB", n_vars[k]*3))
      Grupos <- c(Grupos, 
                  rep(c(rep("G1", n_vars[k]), rep("G2", n_vars[k]), 
                        rep("G3", n_vars[k])), 4))
      Vars <- c(Vars,
              rep(c(paste0("1.", 1:n_vars[k]), paste0("2.", 1:n_vars[k]), 
                paste0("3.", 1:n_vars[k])), 4))
    }
    pr <- c(pr, c(rep(n_vars[1], n_vars[1]*12), rep(n_vars[2], n_vars[2]*12),
                  rep(n_vars[3], n_vars[3]*12)))
  }
}
rhos2 <- rhos
rhos <- factor(rhos)
probs <- as.numeric(probs)
method <- factor(method, levels = c("SB", "Const-Const", "SB-Const", "SB-SB"))
pr <- factor(pr)
Grupos <- factor(Grupos)
Vars <- factor(Vars, levels = c(paste0("1.", 1:n_vars[3]), paste0("2.", 1:n_vars[3]), 
                paste0("3.", 1:n_vars[3])))

exp4vars <- data.frame(rhos, probs, method, Grupos, pr, Vars)
cols <- paletteer_d("ggthemes::wsj_rgby")
ggplot(data = exp4vars, aes(x = rhos, y = probs, fill = Grupos)) +
  geom_boxplot(alpha = 0.7, outlier.colour = 1) +
  scale_fill_manual(values = cols) +
  geom_hline(yintercept = 0.5, linetype = 2, color = 8, alpha = 0.5, linewidth = 1) +
  labs(x = "Correlación por grupo", y = "Probabilidad inclusión a posteriori") +
  theme_bw() + guides(fill = guide_legend(title = "Grupos")) +
  facet_wrap(~ method, ncol = 4) + coord_cartesian(ylim = c(0, 1))
```

En función de la correlación:

```{r, fig.width = 6, fig.height = 4, fig.align = "center", fig.cap = ' '}
cols <- paletteer_d("ggthemes::wsj_rgby")
exp4vars$rhos <- rhos2
ggplot(data = exp4vars[exp4vars$rhos == 0.5,], aes(x = Grupos, y = probs, fill = Grupos)) +
  geom_boxplot(alpha = 0.7, outlier.colour = 1) +
  scale_fill_manual(values = cols) +
  geom_hline(yintercept = 0.5, linetype = 2, color = 8, alpha = 0.5, linewidth = 1) +
  labs(x = "ρ=0.5", y = "Probabilidad inclusión a posteriori") +
  theme_bw() + guides(fill = "none") +
  facet_wrap(~ method, ncol = 4) + coord_cartesian(ylim = c(0, 1))

ggplot(data = exp4vars[exp4vars$rhos == 0.6,], aes(x = Grupos, y = probs, fill = Grupos)) +
  geom_boxplot(alpha = 0.7, outlier.colour = 1) +
  scale_fill_manual(values = cols) +
  geom_hline(yintercept = 0.5, linetype = 2, color = 8, alpha = 0.5, linewidth = 1) +
  labs(x = "ρ=0.6", y = "Probabilidad inclusión a posteriori") +
  theme_bw() + guides(fill = "none") +
  facet_wrap(~ method, ncol = 4) + coord_cartesian(ylim = c(0, 1))

ggplot(data = exp4vars[exp4vars$rhos == 0.7,], aes(x = Grupos, y = probs, fill = Grupos)) +
  geom_boxplot(alpha = 0.7, outlier.colour = 1) +
  scale_fill_manual(values = cols) +
  geom_hline(yintercept = 0.5, linetype = 2, color = 8, alpha = 0.5, linewidth = 1) +
  labs(x = "ρ=0.7", y = "Probabilidad inclusión a posteriori") +
  theme_bw() + guides(fill = "none") +
  facet_wrap(~ method, ncol = 4) + coord_cartesian(ylim = c(0, 1))

ggplot(data = exp4vars[exp4vars$rhos == 0.8,], aes(x = Grupos, y = probs, fill = Grupos)) +
  geom_boxplot(alpha = 0.7, outlier.colour = 1) +
  scale_fill_manual(values = cols) +
  geom_hline(yintercept = 0.5, linetype = 2, color = 8, alpha = 0.5, linewidth = 1) +
  labs(x = "ρ=0.8", y = "Probabilidad inclusión a posteriori") +
  theme_bw() + guides(fill = "none") +
  facet_wrap(~ method, ncol = 4) + coord_cartesian(ylim = c(0, 1))
```

```{r, fig.width = 10, fig.height = 6, fig.align = "center", fig.cap = ' '}
cols <- paletteer_d("ggthemes::wsj_rgby")
ggplot(data = exp4vars[exp4vars$rhos == 0.5,], aes(x = Vars, y = probs, fill = Grupos)) +
  geom_boxplot(alpha = 0.7, outlier.colour = 1) +
  scale_fill_manual(values = cols) +
  geom_hline(yintercept = 0.5, linetype = 2, color = 8, alpha = 0.5, linewidth = 1) +
  labs(x = "ρ=0.5", y = "Probabilidad inclusión a posteriori") +
  theme_bw() + theme(axis.text.x = element_blank(), axis.ticks.x = element_blank()) +
  facet_wrap(~ method, ncol = 4) + coord_cartesian(ylim = c(0, 1))

ggplot(data = exp4vars[exp4vars$rhos == 0.6,], aes(x = Vars, y = probs, fill = Grupos)) +
  geom_boxplot(alpha = 0.7, outlier.colour = 1) +
  scale_fill_manual(values = cols) +
  geom_hline(yintercept = 0.5, linetype = 2, color = 8, alpha = 0.5, linewidth = 1) +
  labs(x = "ρ=0.6", y = "Probabilidad inclusión a posteriori") +
  theme_bw() + theme(axis.text.x = element_blank(), axis.ticks.x = element_blank()) +
  facet_wrap(~ method, ncol = 4) + coord_cartesian(ylim = c(0, 1))

ggplot(data = exp4vars[exp4vars$rhos == 0.7,], aes(x = Vars, y = probs, fill = Grupos)) +
  geom_boxplot(alpha = 0.7, outlier.colour = 1) +
  scale_fill_manual(values = cols) +
  geom_hline(yintercept = 0.5, linetype = 2, color = 8, alpha = 0.5, linewidth = 1) +
  labs(x = "ρ=0.7", y = "Probabilidad inclusión a posteriori") +
  theme_bw() + theme(axis.text.x = element_blank(), axis.ticks.x = element_blank()) + 
  facet_wrap(~ method, ncol = 4) + coord_cartesian(ylim = c(0, 1))

ggplot(data = exp4vars[exp4vars$rhos == 0.8,], aes(x = Vars, y = probs, fill = Grupos)) +
  geom_boxplot(alpha = 0.7, outlier.colour = 1) +
  scale_fill_manual(values = cols) +
  geom_hline(yintercept = 0.5, linetype = 2, color = 8, alpha = 0.5, linewidth = 1) +
  labs(x = "ρ=0.8", y = "Probabilidad inclusión a posteriori") +
  theme_bw() + theme(axis.text.x = element_blank(), axis.ticks.x = element_blank()) +
  facet_wrap(~ method, ncol = 4) + coord_cartesian(ylim = c(0, 1))
```

Porcentaje de variables agrupadas incorrectamente no seleccionadas:

```{r}
exp4vars$rhos <- rhos

# SB
matriz <- c()
for (j in 1:3) {
  matriz <- c(matriz, 
              nrow(exp4vars[exp4vars[,2] < 0.5 & exp4vars$method == previas[1] &
                exp4vars$Grupos == paste0("G", j) & exp4vars$rhos == 0.5,])/((5+7+9)*5)*100,
              nrow(exp4vars[exp4vars[,2] < 0.5 & exp4vars$method == previas[1] &
                exp4vars$Grupos == paste0("G", j) & exp4vars$rhos == 0.6,])/((5+7+9)*5)*100,
              nrow(exp4vars[exp4vars[,2] < 0.5 & exp4vars$method == previas[1] &
                exp4vars$Grupos == paste0("G", j) & exp4vars$rhos == 0.7,])/((5+7+9)*5)*100,
              nrow(exp4vars[exp4vars[,2] < 0.5 & exp4vars$method == previas[1] &
                exp4vars$Grupos == paste0("G", j) & exp4vars$rhos == 0.8,])/((5+7+9)*5)*100)
}
matriz <- paste0(matriz, "%")
matriz <- matrix(matriz, ncol = 3)
rownames(matriz) <- paste0("ρ=", c(unique(exp4$rho)))
colnames(matriz) <- paste0("G", 1:3)
kable(matriz, caption = "Porcentaje de variables agrupadas incorrectamente 
      no seleccionadas para SB.") %>%
  kable_styling()

# Const-Const
matriz <- c()
for (j in 1:3) {
  matriz <- c(matriz, 
              nrow(exp4vars[exp4vars[,2] < 0.5 & exp4vars$method == previas[2] &
                exp4vars$Grupos == paste0("G", j) & exp4vars$rhos == 0.5,])/((5+7+9)*5)*100,
              nrow(exp4vars[exp4vars[,2] < 0.5 & exp4vars$method == previas[2] &
                exp4vars$Grupos == paste0("G", j) & exp4vars$rhos == 0.6,])/((5+7+9)*5)*100,
              nrow(exp4vars[exp4vars[,2] < 0.5 & exp4vars$method == previas[2] &
                exp4vars$Grupos == paste0("G", j) & exp4vars$rhos == 0.7,])/((5+7+9)*5)*100,
              nrow(exp4vars[exp4vars[,2] < 0.5 & exp4vars$method == previas[2] &
                exp4vars$Grupos == paste0("G", j) & exp4vars$rhos == 0.8,])/((5+7+9)*5)*100)
}
matriz <- paste0(matriz, "%")
matriz <- matrix(matriz, ncol = 3)
rownames(matriz) <- paste0("ρ=", c(unique(exp4$rho)))
colnames(matriz) <- paste0("G", 1:3)
kable(matriz, caption = "Porcentaje de variables agrupadas incorrectamente 
      no seleccionadas para Const-Const.") %>%
  kable_styling()

# SB-Const
matriz <- c()
for (j in 1:3) {
  matriz <- c(matriz, 
              nrow(exp4vars[exp4vars[,2] < 0.5 & exp4vars$method == previas[3] &
                exp4vars$Grupos == paste0("G", j) & exp4vars$rhos == 0.5,])/((5+7+9)*5)*100,
              nrow(exp4vars[exp4vars[,2] < 0.5 & exp4vars$method == previas[3] &
                exp4vars$Grupos == paste0("G", j) & exp4vars$rhos == 0.6,])/((5+7+9)*5)*100,
              nrow(exp4vars[exp4vars[,2] < 0.5 & exp4vars$method == previas[3] &
                exp4vars$Grupos == paste0("G", j) & exp4vars$rhos == 0.7,])/((5+7+9)*5)*100,
              nrow(exp4vars[exp4vars[,2] < 0.5 & exp4vars$method == previas[3] &
                exp4vars$Grupos == paste0("G", j) & exp4vars$rhos == 0.8,])/((5+7+9)*5)*100)
}
matriz <- paste0(matriz, "%")
matriz <- matrix(matriz, ncol = 3)
rownames(matriz) <- paste0("ρ=", c(unique(exp4$rho)))
colnames(matriz) <- paste0("G", 1:3)
kable(matriz, caption = "Porcentaje de variables agrupadas incorrectamente 
      no seleccionadas para SB-Const.") %>%
  kable_styling()

# SB-SB
matriz <- c()
for (j in 1:3) {
  matriz <- c(matriz, 
              nrow(exp4vars[exp4vars[,2] < 0.5 & exp4vars$method == previas[4] &
                exp4vars$Grupos == paste0("G", j) & exp4vars$rhos == 0.5,])/((5+7+9)*5)*100,
              nrow(exp4vars[exp4vars[,2] < 0.5 & exp4vars$method == previas[4] &
                exp4vars$Grupos == paste0("G", j) & exp4vars$rhos == 0.6,])/((5+7+9)*5)*100,
              nrow(exp4vars[exp4vars[,2] < 0.5 & exp4vars$method == previas[4] &
                exp4vars$Grupos == paste0("G", j) & exp4vars$rhos == 0.7,])/((5+7+9)*5)*100,
              nrow(exp4vars[exp4vars[,2] < 0.5 & exp4vars$method == previas[4] &
                exp4vars$Grupos == paste0("G", j) & exp4vars$rhos == 0.8,])/((5+7+9)*5)*100)
}
matriz <- paste0(matriz, "%")
matriz <- matrix(matriz, ncol = 3)
rownames(matriz) <- paste0("ρ=", c(unique(exp4$rho)))
colnames(matriz) <- paste0("G", 1:3)
kable(matriz, caption = "Porcentaje de variables agrupadas incorrectamente 
      no seleccionadas para SB-SB.") %>%
  kable_styling()
```

## Experimento 4.2

Los datos los genero con:

$\theta = 1 + \beta_1X_1 + \beta_2X_2+ \beta_3X_3$, $\pi=\frac{e^{\theta}}{1 + e^{\theta}}$ e $Y\sim Ber(\pi)$.

Cada grupo tiene 20 variables, todas generan los datos. De esas 20, seleccionamos las 5 primeras y le pasamos a GS ese banco de datos. Lo mismo con las 7 y 9 primeras.

Los coeficientes de los grupos los genero con una normal de media 0.2 y desviación típica 0.1, 0.15, 0.2, respectivamente

### Grupos
 
En general:

```{r, fig.width = 6, fig.height = 4, fig.align = "center", fig.cap = ' ', results='hide'}
rho <- c(0.5, 0.6, 0.7, 0.8)
probs <- method <- Grupos <- rhos <- pr <- c()
n_vars <- c(5, 7, 9)
for (i in 1:5) {
  for (j in 1:length(rho)) {
    load(paste0("./Resultados_simulados/E4/resultadorho", j, ".1.",i,"c2.Rdata"))
    load(paste0("./Resultados_simulados/E4/resultadorho", j, ".2.",i,"c2.Rdata"))
    load(paste0("./Resultados_simulados/E4/resultadorho", j, ".3.",i,"c2.Rdata"))
    load(paste0("./Resultados_simulados/E4/resultadorho", j, ".1.",i,"c2SB.Rdata"))
    load(paste0("./Resultados_simulados/E4/resultadorho", j, ".2.",i,"c2SB.Rdata"))
    load(paste0("./Resultados_simulados/E4/resultadorho", j, ".3.",i,"c2SB.Rdata"))
    
    rhos <- c(rhos, rep(rho[j], (sum(n_vars))*12))
    
    probs <- c(probs, 
               resultadorho2.1[[1]]$inclprob[resultadorho2.1[[1]]$inclprob[,1] != "-",1], # CC
               resultadorho2.1[[2]]$inclprob[resultadorho2.1[[2]]$inclprob[,1] != "-",1], # SBC
               resultadorho2.1[[3]]$inclprob[resultadorho2.1[[3]]$inclprob[,1] != "-",1], # SBSB
               resultadorho2.1SB[[1]]$inclprob[resultadorho2.1SB[[1]]$inclprob[,1] != "-",1], # SB SBSB
               resultadorho2.2[[1]]$inclprob[resultadorho2.2[[1]]$inclprob[,1] != "-",1], 
               resultadorho2.2[[2]]$inclprob[resultadorho2.2[[2]]$inclprob[,1] != "-",1],
               resultadorho2.2[[3]]$inclprob[resultadorho2.2[[3]]$inclprob[,1] != "-",1],
               resultadorho2.2SB[[1]]$inclprob[resultadorho2.2SB[[1]]$inclprob[,1] != "-",1],
               resultadorho2.3[[1]]$inclprob[resultadorho2.3[[1]]$inclprob[,1] != "-",1],
               resultadorho2.3[[2]]$inclprob[resultadorho2.3[[2]]$inclprob[,1] != "-",1],
               resultadorho2.3[[3]]$inclprob[resultadorho2.3[[3]]$inclprob[,1] != "-",1],
               resultadorho2.3SB[[1]]$inclprob[resultadorho2.3SB[[1]]$inclprob[,1] != "-",1])
    
    for (k in 1:3) {
      method <- c(method,
                  rep("Const-Const", 3), rep("SB-Const", 3), 
                  rep("SB-SB", 3), rep("SB", 3))
      Grupos <- c(Grupos, 
                  rep(c("G1", "G2", "G3"), 4))
    }
  }
}

pr <- rep(c(rep(n_vars[1], 12), rep(n_vars[2], 12), rep(n_vars[3], 12)), 20)

probs <- as.numeric(probs)
method <- factor(method, levels = c("SB", "Const-Const", "SB-Const", "SB-SB"))
pr <- factor(pr)
Grupos <- factor(Grupos)

exp4 <- data.frame(rhos, probs, method, Grupos, pr)
cols <- paletteer_d("ggthemes::wsj_rgby")
ggplot(data = exp4, aes(x = pr, y = probs, fill = Grupos)) +
  geom_boxplot(alpha = 0.7, outlier.colour = 1) +
  scale_fill_manual(values = cols) +
  geom_hline(yintercept = 0.5, linetype = 2, color = 8, alpha = 0.5, linewidth = 1) +
  labs(x = "Número de variables por grupo", 
       y = "Probabilidad inclusión a posteriori") +
  theme_bw() + guides(fill = guide_legend(title = "Grupos")) +
  facet_wrap(~ method, ncol = 4) + coord_cartesian(ylim = c(0, 1))
```

### Variables agrupadas

En general:

```{r, fig.width = 6, fig.height = 4, fig.align = "center", fig.cap = ' '}
rho <- c(0.5, 0.6, 0.7, 0.8)
probs <- method <- Grupos <- rhos <- pr <- Vars <- c()
n_vars <- c(5, 7, 9)
indices1 <- c(2:6, 8:12, 14:18)
indices2 <- c(2:8, 10:16, 18:24)
indices3 <- c(2:10, 12:20, 22:30)

for (i in 1:5) {
  for (j in 1:length(rho)) {
    load(paste0("./Resultados_simulados/E4/resultadorho", j, ".1.",i,"c2.Rdata"))
    load(paste0("./Resultados_simulados/E4/resultadorho", j, ".2.",i,"c2.Rdata"))
    load(paste0("./Resultados_simulados/E4/resultadorho", j, ".3.",i,"c2.Rdata"))
    load(paste0("./Resultados_simulados/E4/resultadorho", j, ".1.",i,"c2SB.Rdata"))
    load(paste0("./Resultados_simulados/E4/resultadorho", j, ".2.",i,"c2SB.Rdata"))
    load(paste0("./Resultados_simulados/E4/resultadorho", j, ".3.",i,"c2SB.Rdata"))
    
    rhos <- c(rhos, rep(rho[j], (sum(n_vars))*12))
    
    probs <- c(probs, 
               resultadorho2.1[[1]]$inclprob[indices1, 2], # CC
               resultadorho2.1[[2]]$inclprob[indices1, 2], # SBC
               resultadorho2.1[[3]]$inclprob[indices1, 2], # SBSB
               resultadorho2.1SB[[1]]$inclprob[indices1, 2], # SB
               resultadorho2.2[[1]]$inclprob[indices2, 2], 
               resultadorho2.2[[2]]$inclprob[indices2, 2],
               resultadorho2.2[[3]]$inclprob[indices2, 2],
               resultadorho2.2SB[[1]]$inclprob[indices2, 2],
               resultadorho2.3[[1]]$inclprob[indices3, 2],
               resultadorho2.3[[2]]$inclprob[indices3, 2],
               resultadorho2.3[[3]]$inclprob[indices3, 2],
               resultadorho2.3SB[[1]]$inclprob[indices3, 2])
    
    for (k in 1:3) {
      method <- c(method,
                  rep("Const-Const", n_vars[k]*3), rep("SB-Const", n_vars[k]*3),
                  rep("SB-SB", n_vars[k]*3), rep("SB", n_vars[k]*3))
      Grupos <- c(Grupos, 
                  rep(c(rep("G1", n_vars[k]), rep("G2", n_vars[k]), 
                        rep("G3", n_vars[k])), 4))
      Vars <- c(Vars,
                rep(c(paste0("1.", 1:n_vars[k]), paste0("2.", 1:n_vars[k]), 
                paste0("3.", 1:n_vars[k])), 4))
    }
    pr <- c(pr, c(rep(n_vars[1], n_vars[1]*12), rep(n_vars[2], n_vars[2]*12),
                  rep(n_vars[3], n_vars[3]*12)))
  }
}
rhos2 <- rhos
rhos <- factor(rhos)
probs <- as.numeric(probs)
method <- factor(method, levels = c("SB", "Const-Const", "SB-Const", "SB-SB"))
pr <- factor(pr)
Grupos <- factor(Grupos)
Vars <- factor(Vars, levels = c(paste0("1.", 1:n_vars[3]), paste0("2.", 1:n_vars[3]), 
                paste0("3.", 1:n_vars[3])))

exp4vars <- data.frame(rhos, probs, method, Grupos, pr, Vars)
cols <- paletteer_d("ggthemes::wsj_rgby")
ggplot(data = exp4vars, aes(x = rhos, y = probs, fill = Grupos)) +
  geom_boxplot(alpha = 0.7, outlier.colour = 1) +
  scale_fill_manual(values = cols) +
  geom_hline(yintercept = 0.5, linetype = 2, color = 8, alpha = 0.5, linewidth = 1) +
  labs(x = "Correlación por grupo", y = "Probabilidad inclusión a posteriori") +
  theme_bw() + guides(fill = guide_legend(title = "Grupos")) +
  facet_wrap(~ method, ncol = 4) + coord_cartesian(ylim = c(0, 1))
```

En función de la correlación:

```{r, fig.width = 6, fig.height = 4, fig.align = "center", fig.cap = ' '}
exp4vars$rhos <- rhos2
ggplot(data = exp4vars[exp4vars$rhos == 0.5,], aes(x = Grupos, y = probs, fill = Grupos)) +
  geom_boxplot(alpha = 0.7, outlier.colour = 1) +
  scale_fill_manual(values = cols) +
  geom_hline(yintercept = 0.5, linetype = 2, color = 8, alpha = 0.5, linewidth = 1) +
  labs(x = "ρ=0.5", y = "Probabilidad inclusión a posteriori") +
  theme_bw() + theme(axis.text.x = element_blank(), 
                     axis.ticks.x = element_blank()) +
  guides(fill = "none") +
  facet_wrap(~ method, ncol = 4) + coord_cartesian(ylim = c(0, 1))

ggplot(data = exp4vars[exp4vars$rhos == 0.6,], aes(x = Grupos, y = probs, fill = Grupos)) +
  geom_boxplot(alpha = 0.7, outlier.colour = 1) +
  scale_fill_manual(values = cols) +
  geom_hline(yintercept = 0.5, linetype = 2, color = 8, alpha = 0.5, linewidth = 1) +
  labs(x = "ρ=0.6", y = "Probabilidad inclusión a posteriori") +
  theme_bw() + theme(axis.text.x = element_blank(),
                     axis.ticks.x = element_blank()) +
  guides(fill = "none") +
  facet_wrap(~ method, ncol = 4) + coord_cartesian(ylim = c(0, 1))

ggplot(data = exp4vars[exp4vars$rhos == 0.7,], aes(x = Grupos, y = probs, fill = Grupos)) +
  geom_boxplot(alpha = 0.7, outlier.colour = 1) +
  scale_fill_manual(values = cols) +
  geom_hline(yintercept = 0.5, linetype = 2, color = 8, alpha = 0.5, linewidth = 1) +
  labs(x = "ρ=0.7", y = "Probabilidad inclusión a posteriori") +
  theme_bw() + theme(axis.text.x = element_blank(),
                     axis.ticks.x = element_blank()) +
  guides(fill = "none") +
  facet_wrap(~ method, ncol = 4) + coord_cartesian(ylim = c(0, 1))

ggplot(data = exp4vars[exp4vars$rhos == 0.8,], aes(x = Grupos, y = probs, fill = Grupos)) +
  geom_boxplot(alpha = 0.7, outlier.colour = 1) +
  scale_fill_manual(values = cols) +
  geom_hline(yintercept = 0.5, linetype = 2, color = 8, alpha = 0.5, linewidth = 1) +
  labs(x = "ρ=0.8", y = "Probabilidad inclusión a posteriori") +
  theme_bw() + theme(axis.text.x=element_blank(),
                    axis.ticks.x=element_blank()) +
  guides(fill = "none") +
  facet_wrap(~ method, ncol = 4) + coord_cartesian(ylim = c(0, 1))
```


```{r, fig.width = 10, fig.height = 6, fig.align = "center", fig.cap = ' '}
cols <- paletteer_d("ggthemes::wsj_rgby")
ggplot(data = exp4vars[exp4vars$rhos == 0.5,], aes(x = Vars, y = probs, fill = Grupos)) +
  geom_boxplot(alpha = 0.7, outlier.colour = 1) +
  scale_fill_manual(values = cols) +
  geom_hline(yintercept = 0.5, linetype = 2, color = 8, alpha = 0.5, linewidth = 1) +
  labs(x = "ρ=0.5", y = "Probabilidad inclusión a posteriori") +
  theme_bw() + theme(axis.text.x = element_blank(),
                     axis.ticks.x = element_blank()) +
  facet_wrap(~ method, ncol = 4) + coord_cartesian(ylim = c(0, 1))

ggplot(data = exp4vars[exp4vars$rhos == 0.6,], aes(x = Vars, y = probs, fill = Grupos)) +
  geom_boxplot(alpha = 0.7, outlier.colour = 1) +
  scale_fill_manual(values = cols) +
  geom_hline(yintercept = 0.5, linetype = 2, color = 8, alpha = 0.5, linewidth = 1) +
  labs(x = "ρ=0.6", y = "Probabilidad inclusión a posteriori") +
  theme_bw() + theme(axis.text.x = element_blank(),
                     axis.ticks.x = element_blank()) +
  facet_wrap(~ method, ncol = 4) + coord_cartesian(ylim = c(0, 1))

ggplot(data = exp4vars[exp4vars$rhos == 0.7,], aes(x = Vars, y = probs, fill = Grupos)) +
  geom_boxplot(alpha = 0.7, outlier.colour = 1) +
  scale_fill_manual(values = cols) +
  geom_hline(yintercept = 0.5, linetype = 2, color = 8, alpha = 0.5, linewidth = 1) +
  labs(x = "ρ=0.7", y = "Probabilidad inclusión a posteriori") +
  theme_bw() + theme(axis.text.x = element_blank(),
                     axis.ticks.x = element_blank()) +
  facet_wrap(~ method, ncol = 4) + coord_cartesian(ylim = c(0, 1))

ggplot(data = exp4vars[exp4vars$rhos == 0.8,], aes(x = Vars, y = probs, fill = Grupos)) +
  geom_boxplot(alpha = 0.7, outlier.colour = 1) +
  scale_fill_manual(values = cols) +
  geom_hline(yintercept = 0.5, linetype = 2, color = 8, alpha = 0.5, linewidth = 1) +
  labs(x = "ρ=0.8", y = "Probabilidad inclusión a posteriori") +
  theme_bw() + theme(axis.text.x = element_blank(),
                     axis.ticks.x = element_blank()) +
  facet_wrap(~ method, ncol = 4) + coord_cartesian(ylim = c(0, 1))
```

Porcentaje de variables agrupadas incorrectamente no seleccionadas:



```{r}
# En función de la correlación:
matriz <- c()
for (j in 1:3) {
  matriz <- c(matriz, 
              nrow(exp4vars[exp4vars[,2] < 0.5 & exp4vars$method == previas[1] &
                exp4vars$Grupos == paste0("G", j) & exp4vars$rhos == 0.5,])/((5+7+9)*5)*100,
              nrow(exp4vars[exp4vars[,2] < 0.5 & exp4vars$method == previas[1] &
                exp4vars$Grupos == paste0("G", j) & exp4vars$rhos == 0.6,])/((5+7+9)*5)*100,
              nrow(exp4vars[exp4vars[,2] < 0.5 & exp4vars$method == previas[1] &
                exp4vars$Grupos == paste0("G", j) & exp4vars$rhos == 0.7,])/((5+7+9)*5)*100,
              nrow(exp4vars[exp4vars[,2] < 0.5 & exp4vars$method == previas[1] &
                exp4vars$Grupos == paste0("G", j) & exp4vars$rhos == 0.8,])/((5+7+9)*5)*100)
}
matriz <- paste0(matriz, "%")
matriz <- matrix(matriz, ncol = 3)
rownames(matriz) <- paste0("ρ=", c(unique(exp4$rho)))
colnames(matriz) <- paste0("G", 1:3)
kable(matriz, caption = "Porcentaje de variables agrupadas incorrectamente 
      no seleccionadas para SB.") %>%
  kable_styling()

matriz <- c()
for (j in 1:3) {
  matriz <- c(matriz, 
              nrow(exp4vars[exp4vars[,2] < 0.5 & exp4vars$method == previas[2] &
                exp4vars$Grupos == paste0("G", j) & exp4vars$rhos == 0.5,])/((5+7+9)*5)*100,
              nrow(exp4vars[exp4vars[,2] < 0.5 & exp4vars$method == previas[2] &
                exp4vars$Grupos == paste0("G", j) & exp4vars$rhos == 0.6,])/((5+7+9)*5)*100,
              nrow(exp4vars[exp4vars[,2] < 0.5 & exp4vars$method == previas[2] &
                exp4vars$Grupos == paste0("G", j) & exp4vars$rhos == 0.7,])/((5+7+9)*5)*100,
              nrow(exp4vars[exp4vars[,2] < 0.5 & exp4vars$method == previas[2] &
                exp4vars$Grupos == paste0("G", j) & exp4vars$rhos == 0.8,])/((5+7+9)*5)*100)
}
matriz <- paste0(matriz, "%")
matriz <- matrix(matriz, ncol = 3)
rownames(matriz) <- paste0("ρ=", c(unique(exp4$rho)))
colnames(matriz) <- paste0("G", 1:3)
kable(matriz, caption = "Porcentaje de variables agrupadas incorrectamente
      no seleccionadas para Const-Const.") %>%
  kable_styling()

matriz <- c()
for (j in 1:3) {
  matriz <- c(matriz, 
              nrow(exp4vars[exp4vars[,2] < 0.5 & exp4vars$method == previas[3] &
                exp4vars$Grupos == paste0("G", j) & exp4vars$rhos == 0.5,])/((5+7+9)*5)*100,
              nrow(exp4vars[exp4vars[,2] < 0.5 & exp4vars$method == previas[3] &
                exp4vars$Grupos == paste0("G", j) & exp4vars$rhos == 0.6,])/((5+7+9)*5)*100,
              nrow(exp4vars[exp4vars[,2] < 0.5 & exp4vars$method == previas[3] &
                exp4vars$Grupos == paste0("G", j) & exp4vars$rhos == 0.7,])/((5+7+9)*5)*100,
              nrow(exp4vars[exp4vars[,2] < 0.5 & exp4vars$method == previas[3] &
                exp4vars$Grupos == paste0("G", j) & exp4vars$rhos == 0.8,])/((5+7+9)*5)*100)
}
matriz <- paste0(matriz, "%")
matriz <- matrix(matriz, ncol = 3)
rownames(matriz) <- paste0("ρ=", c(unique(exp4$rho)))
colnames(matriz) <- paste0("G", 1:3)
kable(matriz, caption = "Porcentaje de variables agrupadas incorrectamente no
      seleccionadas para SB-Const.") %>%
  kable_styling()

matriz <- c()
for (j in 1:3) {
  matriz <- c(matriz, 
              nrow(exp4vars[exp4vars[,2] < 0.5 & exp4vars$method == previas[4] &
                exp4vars$Grupos == paste0("G", j) & exp4vars$rhos == 0.5,])/((5+7+9)*5)*100,
              nrow(exp4vars[exp4vars[,2] < 0.5 & exp4vars$method == previas[4] &
                exp4vars$Grupos == paste0("G", j) & exp4vars$rhos == 0.6,])/((5+7+9)*5)*100,
              nrow(exp4vars[exp4vars[,2] < 0.5 & exp4vars$method == previas[4] &
                exp4vars$Grupos == paste0("G", j) & exp4vars$rhos == 0.7,])/((5+7+9)*5)*100,
              nrow(exp4vars[exp4vars[,2] < 0.5 & exp4vars$method == previas[4] &
                exp4vars$Grupos == paste0("G", j) & exp4vars$rhos == 0.8,])/((5+7+9)*5)*100)
}
matriz <- paste0(matriz, "%")
matriz <- matrix(matriz, ncol = 3)
rownames(matriz) <- paste0("ρ=", c(unique(exp4$rho)))
colnames(matriz) <- paste0("G", 1:3)
kable(matriz, caption = "Porcentaje de variables agrupadas incorrectamente no
      seleccionadas para SB-SB.") %>%
  kable_styling()

```

## Experimento 4.3

Como en 4.0 pero cambiando la correlación de los grupos a 0.2, 0.8 y 0.8, respectivamente. Los datos los genero con:

$\theta = 1 + \beta_1X_1 + \beta_2X_2+ \beta_3X_3$, $\pi=\frac{e^{\theta}}{1 + e^{\theta}}$ e $Y\sim Ber(\pi)$.

Los coeficientes los genero de una normal de media 0.5 y desviación típica de 0.1, 0.15 y 0.2, respectivamente.

### Grupos
 
En general:

```{r, fig.width = 6, fig.height = 4, fig.align = "center", fig.cap = ' ', results='hide'}
method <- Grupos <- probs <- c()
n_vars <- c(5, 7, 9)
for (i in 1:10) {
  load(paste0("./Resultados_simulados/E4/resultado7.1.", i,".Rdata"))
  load(paste0("./Resultados_simulados/E4/resultado7.2.", i,".Rdata"))
  load(paste0("./Resultados_simulados/E4/resultado7.3.", i,".Rdata"))
  load(paste0("./Resultados_simulados/E4/resultado7.1.", i,"SB.Rdata"))
  load(paste0("./Resultados_simulados/E4/resultado7.2.", i,"SB.Rdata"))
  load(paste0("./Resultados_simulados/E4/resultado7.3.", i,"SB.Rdata"))
  probs <- c(probs,
             resultado7.1[[1]]$inclprob[resultado7.1[[1]]$inclprob[,1] != "-",1], # CC
             resultado7.1[[2]]$inclprob[resultado7.1[[2]]$inclprob[,1] != "-",1], # SBC
             resultado7.1[[3]]$inclprob[resultado7.1[[3]]$inclprob[,1] != "-",1], # SBSB
             resultado7.1SB[[1]]$inclprob[resultado7.1SB[[1]]$inclprob[,1] != "-",1], # SB
             resultado7.2[[1]]$inclprob[resultado7.2[[1]]$inclprob[,1] != "-",1], 
             resultado7.2[[2]]$inclprob[resultado7.2[[2]]$inclprob[,1] != "-",1],
             resultado7.2[[3]]$inclprob[resultado7.2[[3]]$inclprob[,1] != "-",1],
             resultado7.2SB[[1]]$inclprob[resultado7.2SB[[1]]$inclprob[,1] != "-",1],
             resultado7.3[[1]]$inclprob[resultado7.3[[1]]$inclprob[,1] != "-",1],
             resultado7.3[[2]]$inclprob[resultado7.3[[2]]$inclprob[,1] != "-",1],
             resultado7.3[[3]]$inclprob[resultado7.3[[3]]$inclprob[,1] != "-",1],
             resultado7.3SB[[1]]$inclprob[resultado7.3SB[[1]]$inclprob[,1] != "-",1])
  
  for (j in 1:3) {
    method <- c(method,
                rep("Const-Const", 3), rep("SB-Const", 3), 
                rep("SB-SB", 3), rep("SB", 3))
    Grupos <- c(Grupos, rep(c("G1", "G2", "G3"), 4))
  }
}

pr <- rep(c(rep(n_vars[1], 12), rep(n_vars[2], 12), rep(n_vars[3], 12)), 10)

probs <- as.numeric(probs)
method <- factor(method, levels = c("SB", "Const-Const", "SB-Const", "SB-SB"))
pr <- factor(pr)
Grupos <- factor(Grupos)

exp4 <- data.frame(pr, probs, method, Grupos)

cols <- paletteer_d("ggthemes::wsj_rgby")
ggplot(data = exp4, aes(x = pr, y = probs, fill = Grupos)) +
  geom_boxplot(alpha = 0.7, outlier.colour = 1) +
  scale_fill_manual(values = cols) +
  geom_hline(yintercept = 0.5, linetype = 2, color = 8, alpha = 0.5, linewidth = 1) +
  labs(x = "Número de variables por grupo", 
       y = "Probabilidad inclusión a posteriori") +
  theme_bw() +
  guides(fill = guide_legend(title = "Grupos")) +
  facet_wrap(~ method, ncol = 4) + coord_cartesian(ylim = c(0, 1))
```

### Variables agrupadas
 
En general:
 
```{r, fig.width = 6, fig.height = 4, fig.align = "center", fig.cap = ' '}
method <- Grupos <- probs <- Vars <- c()
n_vars <- c(5, 7, 9)
indices1 <- c(2:6, 8:12, 14:18)
indices2 <- c(2:8, 10:16, 18:24)
indices3 <- c(2:10, 12:20, 22:30)
for (i in 1:10) {
  load(paste0("./Resultados_simulados/E4/resultado7.1.", i,".Rdata"))
  load(paste0("./Resultados_simulados/E4/resultado7.2.", i,".Rdata"))
  load(paste0("./Resultados_simulados/E4/resultado7.3.", i,".Rdata"))
  load(paste0("./Resultados_simulados/E4/resultado7.1.", i,"SB.Rdata"))
  load(paste0("./Resultados_simulados/E4/resultado7.2.", i,"SB.Rdata"))
  load(paste0("./Resultados_simulados/E4/resultado7.3.", i,"SB.Rdata"))
  probs <- c(probs,
             resultado7.1[[1]]$inclprob[indices1, 2], # CC
             resultado7.1[[2]]$inclprob[indices1, 2], # SBC
             resultado7.1[[3]]$inclprob[indices1, 2], # SBSB
             resultado7.1SB[[1]]$inclprob[indices1, 2], # SB
             resultado7.2[[1]]$inclprob[indices2, 2], 
             resultado7.2[[2]]$inclprob[indices2, 2],
             resultado7.2[[3]]$inclprob[indices2, 2],
             resultado7.2SB[[1]]$inclprob[indices2, 2],
             resultado7.3[[1]]$inclprob[indices3, 2],
             resultado7.3[[2]]$inclprob[indices3, 2],
             resultado7.3[[3]]$inclprob[indices3, 2],
             resultado7.3SB[[1]]$inclprob[indices3, 2])
  
  for (j in 1:3) {
    method <- c(method,
                rep("Const-Const", n_vars[j]*3), rep("SB-Const", n_vars[j]*3), 
                rep("SB-SB", n_vars[j]*3), rep("SB", n_vars[j]*3))
    Grupos <- c(Grupos, 
                rep(c(rep("G1", n_vars[j]), rep("G2", n_vars[j]), 
                      rep("G3", n_vars[j])), 4))
    Vars <- c(Vars,
              rep(c(paste0("1.", 1:n_vars[j]), paste0("2.", 1:n_vars[j]), 
                paste0("3.", 1:n_vars[j])), 4))
  }
}

pr <- rep(c(rep(n_vars[1], n_vars[1]*12), rep(n_vars[2], n_vars[2]*12),
            rep(n_vars[3], n_vars[3]*12)), 10)

probs <- as.numeric(probs)
method <- factor(method, levels = c("SB", "Const-Const", "SB-Const", "SB-SB"))
pr <- factor(pr)
Grupos <- factor(Grupos)
Vars <- factor(Vars, levels = c(paste0("1.", 1:n_vars[3]), 
                     paste0("2.", 1:n_vars[3]), paste0("3.", 1:n_vars[3])))

exp4vars <- data.frame(pr, probs, method, Grupos, Vars)

cols <- paletteer_d("ggthemes::wsj_rgby")
ggplot(data = exp4vars, aes(x = pr, y = probs, fill = Grupos)) +
  geom_boxplot(alpha = 0.7, outlier.colour = 1) +
  scale_fill_manual(values = cols) +
  geom_hline(yintercept = 0.5, linetype = 2, color = 8, alpha = 0.5, linewidth = 1) +
  labs(x = "Número de variables por grupo", 
       y = "Probabilidad inclusión a posteriori") +
  theme_bw() +
  guides(fill = guide_legend(title = "Grupos")) +
  facet_wrap(~ method, ncol = 4) + coord_cartesian(ylim = c(0, 1))
```

En función del número de variables:

```{r, fig.width = 6, fig.height = 4, fig.align = "center", fig.cap = ' '}
cols <- paletteer_d("ggthemes::wsj_rgby")
ggplot(data = exp4vars[exp4vars$pr == 5,], aes(x = Grupos, y = probs, fill = Grupos)) +
  geom_boxplot(alpha = 0.7, outlier.colour = 1) +
  scale_fill_manual(values = cols) +
  geom_hline(yintercept = 0.5, linetype = 2, color = 8, alpha = 0.5, linewidth = 1) +
  labs(x = "5 variables por grupo", y = "Probabilidad inclusión a posteriori") +
  theme_bw() + guides(fill = "none") +
  facet_wrap(~ method, ncol = 4) + coord_cartesian(ylim = c(0, 1))

ggplot(data = exp4vars[exp4vars$pr == 7,], aes(x = Grupos, y = probs, fill = Grupos)) +
  geom_boxplot(alpha = 0.7, outlier.colour = 1) +
  scale_fill_manual(values = cols) +
  geom_hline(yintercept = 0.5, linetype = 2, color = 8, alpha = 0.5, linewidth = 1) +
  labs(x = "7 variables por grupo", 
       y = "Probabilidad inclusión a posteriori") +
  theme_bw() + guides(fill = "none") +
  facet_wrap(~ method, ncol = 4) + coord_cartesian(ylim = c(0, 1))

ggplot(data = exp4vars[exp4vars$pr == 9,], aes(x = Grupos, y = probs, fill = Grupos)) +
  geom_boxplot(alpha = 0.7, outlier.colour = 1) +
  scale_fill_manual(values = cols) +
  geom_hline(yintercept = 0.5, linetype = 2, color = 8, alpha = 0.5, linewidth = 1) +
  labs(x = "9 variables por grupo", y = "Probabilidad inclusión a posteriori") +
  theme_bw() + guides(fill = "none") +
  facet_wrap(~ method, ncol = 4) + coord_cartesian(ylim = c(0, 1))
```

```{r, fig.width = 10, fig.height = 6, fig.align = "center", fig.cap = ' '}
ggplot(data = exp4vars[exp4vars$pr == 5,], aes(x = Vars, y = probs, fill = Grupos)) +
  geom_boxplot(alpha = 0.7, outlier.colour = 1) +
  scale_fill_manual(values = cols) +
  geom_hline(yintercept = 0.5, linetype = 2, color = 8, alpha = 0.5, linewidth = 1) +
  labs(x = "5 variables por grupo", y = "Probabilidad inclusión a posteriori") +
  theme_bw() + theme(axis.text.x = element_blank(), axis.ticks.x = element_blank()) +
  facet_wrap(~ method, ncol = 4) + coord_cartesian(ylim = c(0, 1))

ggplot(data = exp4vars[exp4vars$pr == 7,], aes(x = Vars, y = probs, fill = Grupos)) +
  geom_boxplot(alpha = 0.7, outlier.colour = 1) +
  scale_fill_manual(values = cols) +
  geom_hline(yintercept = 0.5, linetype = 2, color = 8, alpha = 0.5, linewidth = 1) +
  labs(x = "7 variables por grupo", y = "Probabilidad inclusión a posteriori") +
  theme_bw() + theme(axis.text.x = element_blank(), axis.ticks.x = element_blank()) +
  facet_wrap(~ method, ncol = 4) + coord_cartesian(ylim = c(0, 1))

ggplot(data = exp4vars[exp4vars$pr == 9,], aes(x = Vars, y = probs, fill = Grupos)) +
  geom_boxplot(alpha = 0.7, outlier.colour = 1) +
  scale_fill_manual(values = cols) +
  geom_hline(yintercept = 0.5, linetype = 2, color = 8, alpha = 0.5, linewidth = 1) +
  labs(x = "9 variables por grupo", y = "Probabilidad inclusión a posteriori") +
  theme_bw() + theme(axis.text.x = element_blank(), axis.ticks.x = element_blank()) +
  facet_wrap(~ method, ncol = 4) + coord_cartesian(ylim = c(0, 1))
```

Porcentaje de variables agrupadas incorrectamente no seleccionados:

```{r}
previas <- c("SB", "Const-Const", "SB-Const", "SB-SB")

# Calculamos los grupos incorrectamente no seleccionados
# SB
matriz <- c()
for (j in 1:3) {
  matriz <- c(matriz, 
              nrow(exp4vars[exp4vars[,2] < 0.5 & exp4vars$Grupos == paste0("G", j) &
                exp4vars$method == previas[1] & exp4vars$pr == 5,])/(5*10)*100,
              nrow(exp4vars[exp4vars[,2] < 0.5 & exp4vars$Grupos == paste0("G", j) &
                exp4vars$method == previas[1] & exp4vars$pr == 7,])/(7*10)*100,
              nrow(exp4vars[exp4vars[,2] < 0.5 & exp4vars$Grupos == paste0("G", j) &
                exp4vars$method == previas[1] & exp4vars$pr == 9,])/(9*10)*100)
}
matriz <- paste0(matriz, "%")
matriz <- matrix(matriz, ncol = 3)
rownames(matriz) <- paste0( "Num vars = ", unique(exp4$pr))
colnames(matriz) <- paste0("G", 1:3)
kable(matriz, caption = "Porcentaje de variables agrupadas incorrectamente 
      no seleccionadas para SB.") %>%
  kable_styling()

# Const-Const
matriz <- c()
for (j in 1:3) {
  matriz <- c(matriz, 
              nrow(exp4vars[exp4vars[,2] < 0.5 & exp4vars$Grupos == paste0("G", j) &
                exp4vars$method == previas[2] & exp4vars$pr == 5,])/(5*10)*100,
              nrow(exp4vars[exp4vars[,2] < 0.5 & exp4vars$Grupos == paste0("G", j) &
                exp4vars$method == previas[2] & exp4vars$pr == 7,])/(7*10)*100,
              nrow(exp4vars[exp4vars[,2] < 0.5 & exp4vars$Grupos == paste0("G", j) &
                exp4vars$method == previas[2] & exp4vars$pr == 9,])/(9*10)*100)
}
matriz <- paste0(matriz, "%")
matriz <- matrix(matriz, ncol = 3)
rownames(matriz) <- paste0( "Num vars = ", unique(exp4$pr))
colnames(matriz) <- paste0("G", 1:3)
kable(matriz, caption = "Porcentaje de variables agrupadas incorrectamente 
      no seleccionadas para Const-Const.") %>%
  kable_styling()

# SB-Const
matriz <- c()
for (j in 1:3) {
  matriz <- c(matriz, 
              nrow(exp4vars[exp4vars[,2] < 0.5 & exp4vars$Grupos == paste0("G", j) &
                exp4vars$method == previas[3] & exp4vars$pr == 5,])/(5*10)*100,
              nrow(exp4vars[exp4vars[,2] < 0.5 & exp4vars$Grupos == paste0("G", j) &
                exp4vars$method == previas[3] & exp4vars$pr == 7,])/(7*10)*100,
              nrow(exp4vars[exp4vars[,2] < 0.5 & exp4vars$Grupos == paste0("G", j) &
                exp4vars$method == previas[3] & exp4vars$pr == 9,])/(9*10)*100)
}
matriz <- paste0(matriz, "%")
matriz <- matrix(matriz, ncol = 3)
rownames(matriz) <- paste0( "Num vars = ", unique(exp4$pr))
colnames(matriz) <- paste0("G", 1:3)
kable(matriz, caption = "Porcentaje de variables agrupadas incorrectamente 
      no seleccionadas para SB-Const.") %>%
  kable_styling()

# SB-SB
matriz <- c()
for (j in 1:3) {
  matriz <- c(matriz, 
              nrow(exp4vars[exp4vars[,2] < 0.5 & exp4vars$Grupos == paste0("G", j) &
                exp4vars$method == previas[4] & exp4vars$pr == 5,])/(5*10)*100,
              nrow(exp4vars[exp4vars[,2] < 0.5 & exp4vars$Grupos == paste0("G", j) &
                exp4vars$method == previas[4] & exp4vars$pr == 7,])/(7*10)*100,
              nrow(exp4vars[exp4vars[,2] < 0.5 & exp4vars$Grupos == paste0("G", j) &
                exp4vars$method == previas[4] & exp4vars$pr == 9,])/(9*10)*100)
}
matriz <- paste0(matriz, "%")
matriz <- matrix(matriz, ncol = 3)
rownames(matriz) <- paste0( "Num vars = ", unique(exp4$pr))
colnames(matriz) <- paste0("G", 1:3)
kable(matriz, caption = "Porcentaje de variables agrupadas incorrectamente 
      no seleccionadas para SB-SB.") %>%
  kable_styling()
```

## Experimento 4.4

Los datos los genero con:

$\theta = 1 + \beta_1X_1 + \beta_2X_2+ \beta_3X_3$, $\pi=\frac{e^{\theta}}{1 + e^{\theta}}$ e $Y\sim Ber(\pi)$.

Los coeficientes de los grupos los genero con una normal de media 0.5 y desviación típica 0.1, 0.15, 0.2, respectivamente.

Como en 4.0 con una correlación de 0.75 para las variables de los grupos, pero pasándole incorrectamente a GS la lista de los grupos: diciendole que las dos primeras variables de G2 y las tres primeras de G3 están en G1.

### Grupos
 
En general:

```{r, fig.width = 6, fig.height = 3, fig.align = "center", fig.cap = ' ', results='hide'}
method <- Grupos <- probs <- c()
n_vars <- c(5, 7, 9)
for (i in 1:10) {
  load(paste0("./Resultados_simulados/E4/resultado8.1.", i,".Rdata"))
  load(paste0("./Resultados_simulados/E4/resultado8.2.", i,".Rdata"))
  load(paste0("./Resultados_simulados/E4/resultado8.3.", i,".Rdata"))
  load(paste0("./Resultados_simulados/E4/resultado8.1.", i,"SB.Rdata"))
  load(paste0("./Resultados_simulados/E4/resultado8.2.", i,"SB.Rdata"))
  load(paste0("./Resultados_simulados/E4/resultado8.3.", i,"SB.Rdata"))
  probs <- c(probs,
             resultado8.1[[1]]$inclprob[resultado8.1[[1]]$inclprob[,1] != "-",1], # CC
             resultado8.1[[2]]$inclprob[resultado8.1[[2]]$inclprob[,1] != "-",1], # SBC
             resultado8.1[[3]]$inclprob[resultado8.1[[3]]$inclprob[,1] != "-",1], # SBSB
             resultado8.1SB[[1]]$inclprob[resultado8.1SB[[1]]$inclprob[,1] != "-",1], # SB
             resultado8.2[[1]]$inclprob[resultado8.2[[1]]$inclprob[,1] != "-",1], 
             resultado8.2[[2]]$inclprob[resultado8.2[[2]]$inclprob[,1] != "-",1],
             resultado8.2[[3]]$inclprob[resultado8.2[[3]]$inclprob[,1] != "-",1],
             resultado8.2SB[[1]]$inclprob[resultado8.2SB[[1]]$inclprob[,1] != "-",1],
             resultado8.3[[1]]$inclprob[resultado8.3[[1]]$inclprob[,1] != "-",1],
             resultado8.3[[2]]$inclprob[resultado8.3[[2]]$inclprob[,1] != "-",1],
             resultado8.3[[3]]$inclprob[resultado8.3[[3]]$inclprob[,1] != "-",1],
             resultado8.3SB[[1]]$inclprob[resultado8.3SB[[1]]$inclprob[,1] != "-",1]
             )
  
  for (j in 1:3) {
    method <- c(method,
                rep("Const-Const", 3), rep("SB-Const", 3), 
                rep("SB-SB", 3), rep("SB", 3))
    Grupos <- c(Grupos, 
                rep(c("G1", "G2", "G3"), 4))
  }
}

pr <- rep(c(rep(n_vars[1], 12), rep(n_vars[2], 12), rep(n_vars[3], 12)), 10)

probs <- as.numeric(probs)
method <- factor(method, levels = c("SB", "Const-Const", "SB-Const", "SB-SB"))
pr <- factor(pr)
Grupos <- factor(Grupos)

exp4 <- data.frame(pr, probs, method, Grupos)

cols <- paletteer_d("ggthemes::wsj_rgby")
ggplot(data = exp4, aes(x = pr, y = probs, color = Grupos)) +
  geom_point(alpha = 0.4) +
  scale_color_manual(values = cols) +
  geom_hline(yintercept = 0.5, linetype = 2, color = 8, alpha = 0.5, linewidth = 1) +
  labs(x = "Número de variables por grupo", 
       y = "Probabilidad inclusión a posteriori") +
  theme_bw() + guides(fill = guide_legend(title = "Grupos")) +
  facet_wrap(~ method, ncol = 4) + coord_cartesian(ylim = c(0, 1))
```

### Variables agrupadas
 
En general:
 
```{r, fig.width = 6, fig.height = 4, fig.align = "center", fig.cap = ' '}
method <- Grupos <- probs <- Vars <- c()
n_vars <- c(5, 7, 9)
indices1 <- c(2:11, 13:15, 17:18)
indices2 <- c(2:13, 15:19, 21:24)
indices3 <- c(2:15, 17:23, 25:30)
for (i in 1:10) {
  load(paste0("./Resultados_simulados/E4/resultado8.1.", i,".Rdata"))
  load(paste0("./Resultados_simulados/E4/resultado8.2.", i,".Rdata"))
  load(paste0("./Resultados_simulados/E4/resultado8.3.", i,".Rdata"))
  load(paste0("./Resultados_simulados/E4/resultado8.1.", i,"SB.Rdata"))
  load(paste0("./Resultados_simulados/E4/resultado8.2.", i,"SB.Rdata"))
  load(paste0("./Resultados_simulados/E4/resultado8.3.", i,"SB.Rdata"))
  probs <- c(probs,
             resultado8.1[[1]]$inclprob[indices1, 2], # CC
             resultado8.1[[2]]$inclprob[indices1, 2], # SBC
             resultado8.1[[3]]$inclprob[indices1, 2], # SBSB
             resultado8.1SB[[1]]$inclprob[indices1, 2], # SB
             resultado8.2[[1]]$inclprob[indices2, 2], 
             resultado8.2[[2]]$inclprob[indices2, 2],
             resultado8.2[[3]]$inclprob[indices2, 2],
             resultado8.2SB[[1]]$inclprob[indices2, 2],
             resultado8.3[[1]]$inclprob[indices3, 2],
             resultado8.3[[2]]$inclprob[indices3, 2],
             resultado8.3[[3]]$inclprob[indices3, 2],
             resultado8.3SB[[1]]$inclprob[indices3, 2])
  
  for (j in 1:3) {
    method <- c(method,
                rep("Const-Const", n_vars[j]*3), rep("SB-Const", n_vars[j]*3), 
                rep("SB-SB", n_vars[j]*3), rep("SB", n_vars[j]*3))
    Grupos <- c(Grupos, 
                rep(c(rep("G1", n_vars[j]), rep("G2", 2), rep("G3", 3), 
                      rep("G2", n_vars[j] - 2), rep("G3", n_vars[j] - 3)), 4))
    Vars <- c(Vars,
              rep(c(paste0("1.", 1:n_vars[j]), paste0("2.", 1:2), paste0("3.", 1:3),
                    paste0("2.", 3:n_vars[j]), paste0("3.", 4:n_vars[j])), 4))
  }
}

pr <- rep(c(rep(n_vars[1], n_vars[1]*12), rep(n_vars[2], n_vars[2]*12),
                          rep(n_vars[3], n_vars[3]*12)), 10)

probs <- as.numeric(probs)
method <- factor(method, levels = c("SB", "Const-Const", "SB-Const", "SB-SB"))
pr <- factor(pr)
Grupos <- factor(Grupos)
Vars <- factor(Vars, levels = c(paste0("1.", 1:n_vars[3]), paste0("2.", 1:n_vars[3]), 
                paste0("3.", 1:n_vars[3])))

exp4vars <- data.frame(pr, probs, method, Grupos, Vars)

cols <- paletteer_d("ggthemes::wsj_rgby")
ggplot(data = exp4vars, aes(x = pr, y = probs, fill = Grupos)) +
  geom_boxplot(alpha = 0.7, outlier.colour = 1) +
  scale_fill_manual(values = cols) +
  geom_hline(yintercept = 0.5, linetype = 2, color = 8, alpha = 0.5, linewidth = 1) +
  labs(x = "Número de variables por grupo", 
       y = "Probabilidad inclusión a posteriori") +
  theme_bw() + guides(fill = guide_legend(title = "Grupos")) +
  facet_wrap(~ method, ncol = 4) + coord_cartesian(ylim = c(0, 1))
```

En función del número de variables:

```{r, fig.width = 6, fig.height = 4, fig.align = "center", fig.cap = ' '}
cols <- paletteer_d("ggthemes::wsj_rgby")
ggplot(data = exp4vars[exp4vars$pr == 5,], aes(x = Grupos, y = probs, fill = Grupos)) +
  geom_boxplot(alpha = 0.7, outlier.colour = 1) +
  scale_fill_manual(values = cols) +
  geom_hline(yintercept = 0.5, linetype = 2, color = 8, alpha = 0.5, linewidth = 1) +
  labs(x = "5 variables por grupo", y = "Probabilidad inclusión a posteriori") +
  theme_bw() + guides(fill = "none") +
  facet_wrap(~ method, ncol = 4) + coord_cartesian(ylim = c(0, 1))

ggplot(data = exp4vars[exp4vars$pr == 7,], aes(x = Grupos, y = probs, fill = Grupos)) +
  geom_boxplot(alpha = 0.7, outlier.colour = 1) + 
  scale_fill_manual(values = cols) +
  geom_hline(yintercept = 0.5, linetype = 2, color = 8, alpha = 0.5, linewidth = 1) +
  labs(x = "7 variables por grupo", y = "Probabilidad inclusión a posteriori") +
  theme_bw() + guides(fill = "none") +
  facet_wrap(~ method, ncol = 4) + coord_cartesian(ylim = c(0, 1))

ggplot(data = exp4vars[exp4vars$pr == 9,], aes(x = Grupos, y = probs, fill = Grupos)) +
  geom_boxplot(alpha = 0.7, outlier.colour = 1) +
  scale_fill_manual(values = cols) +
  geom_hline(yintercept = 0.5, linetype = 2, color = 8, alpha = 0.5, linewidth = 1) +
  labs(x = "9 variables por grupo", y = "Probabilidad inclusión a posteriori") +
  theme_bw() + guides(fill = "none") +
  facet_wrap(~ method, ncol = 4) + coord_cartesian(ylim = c(0, 1))
```


```{r, fig.width = 10, fig.height = 6, fig.align = "center", fig.cap = ' '}

ggplot(data = exp4vars[exp4vars$pr == 5,], aes(x = Vars, y = probs, fill = Grupos)) +
  geom_boxplot(alpha = 0.7, outlier.colour = 1) +
  scale_fill_manual(values = cols) +
  geom_hline(yintercept = 0.5, linetype = 2, color = 8, alpha = 0.5, linewidth = 1) +
  labs(x = "5 variables por grupo", y = "Probabilidad inclusión a posteriori") +
  theme_bw() + theme(axis.text.x = element_blank(), axis.ticks.x = element_blank()) +
  facet_wrap(~ method, ncol = 4) + coord_cartesian(ylim = c(0, 1))

ggplot(data = exp4vars[exp4vars$pr == 7,], aes(x = Vars, y = probs, fill = Grupos)) +
  geom_boxplot(alpha = 0.7, outlier.colour = 1) +
  scale_fill_manual(values = cols) +
  geom_hline(yintercept = 0.5, linetype = 2, color = 8, alpha = 0.5, linewidth = 1) +
  labs(x = "7 variables por grupo", y = "Probabilidad inclusión a posteriori") +
  theme_bw() + theme(axis.text.x = element_blank(), axis.ticks.x = element_blank()) +
  facet_wrap(~ method, ncol = 4) + coord_cartesian(ylim = c(0, 1))

ggplot(data = exp4vars[exp4vars$pr == 9,], aes(x = Vars, y = probs, fill = Grupos)) +
  geom_boxplot(alpha = 0.7, outlier.colour = 1) +
  scale_fill_manual(values = cols) +
  geom_hline(yintercept = 0.5, linetype = 2, color = 8, alpha = 0.5, linewidth = 1) +
  labs(x = "9 variable por grupo", y = "Probabilidad inclusión a posteriori") +
  theme_bw() + theme(axis.text.x = element_blank(), axis.ticks.x = element_blank()) +
  facet_wrap(~ method, ncol = 4) + coord_cartesian(ylim = c(0, 1))
```

Porcentaje de variables agrupadas incorrectamente no seleccionados:

```{r}
previas <- c("SB", "Const-Const", "SB-Const", "SB-SB")

# Calculamos los grupos incorrectamente no seleccionados
# SB
matriz <- c()
for (j in 1:3) {
  matriz <- c(matriz, 
              nrow(exp4vars[exp4vars[,2] < 0.5 & exp4vars$Grupos == paste0("G", j) &
                exp4vars$method == previas[1] & exp4vars$pr == 5,])/(5*10)*100,
              nrow(exp4vars[exp4vars[,2] < 0.5 & exp4vars$Grupos == paste0("G", j) &
                exp4vars$method == previas[1] & exp4vars$pr == 7,])/(7*10)*100,
              nrow(exp4vars[exp4vars[,2] < 0.5 & exp4vars$Grupos == paste0("G", j) &
                exp4vars$method == previas[1] & exp4vars$pr == 9,])/(9*10)*100)
}
matriz <- paste0(matriz, "%")
matriz <- matrix(matriz, ncol = 3)
rownames(matriz) <- paste0( "Num vars = ", unique(exp4$pr))
colnames(matriz) <- paste0("G", 1:3)
kable(matriz, caption = "Porcentaje de variables agrupadas incorrectamente 
      no seleccionadas para SB.") %>%
  kable_styling()

# Const-Const
matriz <- c()
for (j in 1:3) {
  matriz <- c(matriz, 
              nrow(exp4vars[exp4vars[,2] < 0.5 & exp4vars$Grupos == paste0("G", j) &
                exp4vars$method == previas[2] & exp4vars$pr == 5,])/(5*10)*100,
              nrow(exp4vars[exp4vars[,2] < 0.5 & exp4vars$Grupos == paste0("G", j) &
                exp4vars$method == previas[2] & exp4vars$pr == 7,])/(7*10)*100,
              nrow(exp4vars[exp4vars[,2] < 0.5 & exp4vars$Grupos == paste0("G", j) &
                exp4vars$method == previas[2] & exp4vars$pr == 9,])/(9*10)*100)
}
matriz <- paste0(matriz, "%")
matriz <- matrix(matriz, ncol = 3)
rownames(matriz) <- paste0( "Num vars = ", unique(exp4$pr))
colnames(matriz) <- paste0("G", 1:3)
kable(matriz, caption = "Porcentaje de variables agrupadas incorrectamente 
      no seleccionadas para Const-Const.") %>%
  kable_styling()

# SB-Const
matriz <- c()
for (j in 1:3) {
  matriz <- c(matriz, 
              nrow(exp4vars[exp4vars[,2] < 0.5 & exp4vars$Grupos == paste0("G", j) &
                exp4vars$method == previas[3] & exp4vars$pr == 5,])/(5*10)*100,
              nrow(exp4vars[exp4vars[,2] < 0.5 & exp4vars$Grupos == paste0("G", j) &
                exp4vars$method == previas[3] & exp4vars$pr == 7,])/(7*10)*100,
              nrow(exp4vars[exp4vars[,2] < 0.5 & exp4vars$Grupos == paste0("G", j) &
                exp4vars$method == previas[3] & exp4vars$pr == 9,])/(9*10)*100)
}
matriz <- paste0(matriz, "%")
matriz <- matrix(matriz, ncol = 3)
rownames(matriz) <- paste0( "Num vars = ", unique(exp4$pr))
colnames(matriz) <- paste0("G", 1:3)
kable(matriz, caption = "Porcentaje de variables agrupadas incorrectamente 
      no seleccionadas para SB-Const.") %>%
  kable_styling()

# SB-SB
matriz <- c()
for (j in 1:3) {
  matriz <- c(matriz, 
              nrow(exp4vars[exp4vars[,2] < 0.5 & exp4vars$Grupos == paste0("G", j) &
                exp4vars$method == previas[4] & exp4vars$pr == 5,])/(5*10)*100,
              nrow(exp4vars[exp4vars[,2] < 0.5 & exp4vars$Grupos == paste0("G", j) &
                exp4vars$method == previas[4] & exp4vars$pr == 7,])/(7*10)*100,
              nrow(exp4vars[exp4vars[,2] < 0.5 & exp4vars$Grupos == paste0("G", j) &
                exp4vars$method == previas[4] & exp4vars$pr == 9,])/(9*10)*100)
}
matriz <- paste0(matriz, "%")
matriz <- matrix(matriz, ncol = 3)
rownames(matriz) <- paste0( "Num vars = ", unique(exp4$pr))
colnames(matriz) <- paste0("G", 1:3)
kable(matriz, caption = "Porcentaje de variables agrupadas incorrectamente 
      no seleccionadas para SB-SB.") %>%
  kable_styling()
```

## Experimento 4.5

Quiero ver qué pasa cuando añado un grupo falso con el mismo número de variables que el resto. En este caso la correlación es 0.9. Los datos los genero con:

$\theta = 1 + \beta_1X_1 + \beta_2X_2+ \beta_3X_3$, $\pi=\frac{e^{\theta}}{1 + e^{\theta}}$ e $Y\sim Ber(\pi)$.

Los coeficientes de los grupos los genero con una normal de media 0.5 y desviación típica 0.1, 0.15, 0.2, respectivamente

Como en 4.0 con una correlación de 0.9, pero añadiendo un cuarto grupo falso con el mismo número de variables que los grupos que generan los datos.

### Grupos

En general:

```{r, fig.width = 6, fig.height = 4, fig.align = "center", fig.cap = ' '}
method <- Grupos <- probs <- c()
n_vars <- c(5, 7, 9)
for (i in 1:5) {
  load(paste0("./Resultados_simulados/E4/resultado9.1.", i,".Rdata"))
  load(paste0("./Resultados_simulados/E4/resultado9.2.", i,".Rdata"))
  load(paste0("./Resultados_simulados/E4/resultado9.3.", i,".Rdata"))
  load(paste0("./Resultados_simulados/E4/resultado9.1.", i,"SB.Rdata"))
  load(paste0("./Resultados_simulados/E4/resultado9.2.", i,"SB.Rdata"))
  load(paste0("./Resultados_simulados/E4/resultado9.3.", i,"SB.Rdata"))
  probs <- c(probs,
             resultado9.1[[1]]$inclprob[resultado9.1[[1]]$inclprob[,1] != "-",1], # CC
             resultado9.1[[2]]$inclprob[resultado9.1[[2]]$inclprob[,1] != "-",1], # SBC
             resultado9.1[[3]]$inclprob[resultado9.1[[3]]$inclprob[,1] != "-",1], # SBSB
             resultado9.1SB[[1]]$inclprob[resultado9.1SB[[1]]$inclprob[,1] != "-",1], # SB
             resultado9.2[[1]]$inclprob[resultado9.2[[1]]$inclprob[,1] != "-",1],
             resultado9.2[[2]]$inclprob[resultado9.2[[2]]$inclprob[,1] != "-",1],
             resultado9.2[[3]]$inclprob[resultado9.2[[3]]$inclprob[,1] != "-",1],
             resultado9.2SB[[1]]$inclprob[resultado9.2SB[[1]]$inclprob[,1] != "-",1],
             resultado9.3[[1]]$inclprob[resultado9.3[[1]]$inclprob[,1] != "-",1],
             resultado9.3[[2]]$inclprob[resultado9.3[[2]]$inclprob[,1] != "-",1],
             resultado9.3[[3]]$inclprob[resultado9.3[[3]]$inclprob[,1] != "-",1],
             resultado9.3SB[[1]]$inclprob[resultado9.3SB[[1]]$inclprob[,1] != "-",1])

  for (j in 1:3) {
    method <- c(method,
                rep("Const-Const", 4), rep("SB-Const", 4),
                rep("SB-SB", 4), rep("SB", 4))
    Grupos <- c(Grupos, rep(c("G1", "G2", "G3", "G4"), 4))
  }
}

pr <- rep(c(rep(n_vars[1], 16), rep(n_vars[2], 16),
                          rep(n_vars[3], 16)), 5)
pr2 <- pr

probs <- as.numeric(probs)
method <- factor(method, levels = c("SB", "Const-Const", "SB-Const", "SB-SB"))
pr <- factor(pr)
Grupos <- factor(Grupos)

exp4 <- data.frame(pr, probs, method, Grupos)

cols <- paletteer_d("ggthemes::wsj_rgby")
ggplot(data = exp4, aes(x = pr, y = probs, color = Grupos)) +
  geom_point(alpha = 0.4) +
  scale_color_manual(values = cols) +
  geom_hline(yintercept = 0.5, linetype = 2, color = 8, alpha = 0.5, linewidth = 1) +
  labs(x = "Número de variables por grupo", y = "Probabilidad inclusión a posteriori") +
  theme_bw() + guides(fill = guide_legend(title = "Grupos")) +
  facet_wrap(~ method, ncol = 4) + coord_cartesian(ylim = c(0, 1))
```

En función del número de variables:

```{r, fig.width = 6, fig.height = 4, fig.align = "center", fig.cap = ' '}
ggplot(data = exp4[exp4$pr == 5,], aes(x = Grupos, y = probs, fill = Grupos)) +
  geom_boxplot(alpha = 0.7, outlier.colour = 1) +
  scale_fill_manual(values = cols) +
  geom_hline(yintercept = 0.5, linetype = 2, color = 8, alpha = 0.5, linewidth = 1) +
  labs(x = "5 variables por grupo", y = "Probabilidad inclusión a posteriori") +
  theme_bw() +
  guides(fill = "none") +
  facet_wrap(~ method, ncol = 4) + coord_cartesian(ylim = c(0, 1))

ggplot(data = exp4[exp4$pr == 7,], aes(x = Grupos, y = probs, fill = Grupos)) +
  geom_boxplot(alpha = 0.7, outlier.colour = 1) +
  scale_fill_manual(values = cols) +
  geom_hline(yintercept = 0.5, linetype = 2, color = 8, alpha = 0.5, linewidth = 1) +
  labs(x = "7 variables por grupo", y = "Probabilidad inclusión a posteriori") +
  theme_bw() + guides(fill = "none") +
  facet_wrap(~ method, ncol = 4) + coord_cartesian(ylim = c(0, 1))

ggplot(data = exp4[exp4$pr == 9,], aes(x = Grupos, y = probs, fill = Grupos)) +
  geom_boxplot(alpha = 0.7, outlier.colour = 1) +
  scale_fill_manual(values = cols) +
  geom_hline(yintercept = 0.5, linetype = 2, color = 8, alpha = 0.5, linewidth = 1) +
  labs(x = "9 variables por grupo", y = "Probabilidad inclusión a posteriori") +
  theme_bw() + guides(fill = "none") +
  facet_wrap(~ method, ncol = 4) + coord_cartesian(ylim = c(0, 1))
```

Porcentaje de grupos incorrectamente seleccionados:

```{r}
previas <- c("SB", "Const-Const", "SB-Const", "SB-SB")
## Incorrectamente seleccionados
# SB
matriz <- c()
for (j in 1:1) {
  matriz <- c(matriz,
              nrow(exp4[exp4[,2] > 0.5 & exp4$pr == 5 &
                exp4$method == previas[1] & exp4$Grupos == "G4",])/(1*5)*100,
              nrow(exp4[exp4[,2] > 0.5 & exp4$pr == 7 &
                exp4$method == previas[1] & exp4$Grupos == "G4",])/(1*5)*100,
              nrow(exp4[exp4[,2] > 0.5 & exp4$pr == 9 &
                exp4$method == previas[1] & exp4$Grupos == "G4",])/(1*5)*100)
}
matriz <- paste0(matriz, "%")
matriz <- matrix(matriz, ncol = 1)
rownames(matriz) <- paste0("Num vars =", c(5,7,9))
colnames(matriz) <- c("G4")
kable(matriz, caption = "Porcentaje de grupos incorrectamente seleccionados 
      con SB.") %>%
  kable_styling()

# Const-Const
matriz <- c()
for (j in 1:1) {
  matriz <- c(matriz,
              nrow(exp4[exp4[,2] > 0.5 & exp4$pr == 5 &
                exp4$method == previas[2] & exp4$Grupos == "G4",])/(1*5)*100,
              nrow(exp4[exp4[,2] > 0.5 & exp4$pr == 7 &
                exp4$method == previas[2] & exp4$Grupos == "G4",])/(1*5)*100,
              nrow(exp4[exp4[,2] > 0.5 & exp4$pr == 9 &
                exp4$method == previas[2] & exp4$Grupos == "G4",])/(1*5)*100)
}
matriz <- paste0(matriz, "%")
matriz <- matrix(matriz, ncol = 1)
rownames(matriz) <- paste0("Num vars =", c(5,7,9))
colnames(matriz) <- c("G4")
kable(matriz, caption = "Porcentaje de grupos incorrectamente seleccionados 
      con Const-Const.") %>%
  kable_styling()

# SB-Const
matriz <- c()
for (j in 1:1) {
  matriz <- c(matriz,
              nrow(exp4[exp4[,2] > 0.5 & exp4$pr == 5 &
                exp4$method == previas[3] & exp4$Grupos == "G4",])/(1*5)*100,
              nrow(exp4[exp4[,2] > 0.5 & exp4$pr == 7 &
                exp4$method == previas[3] & exp4$Grupos == "G4",])/(1*5)*100,
              nrow(exp4[exp4[,2] > 0.5 & exp4$pr == 9 &
                exp4$method == previas[3] & exp4$Grupos == "G4",])/(1*5)*100)
}
matriz <- paste0(matriz, "%")
matriz <- matrix(matriz, ncol = 1)
rownames(matriz) <- paste0("Num vars =", c(5,7,9))
colnames(matriz) <- c("G4")
kable(matriz, caption = "Porcentaje de grupos incorrectamente seleccionados 
      con SB-Const.") %>%
  kable_styling()

# SB-SB
matriz <- c()
for (j in 1:1) {
  matriz <- c(matriz,
              nrow(exp4[exp4[,2] > 0.5 & exp4$pr == 5 &
                exp4$method == previas[4] & exp4$Grupos == "G4",])/(1*5)*100,
              nrow(exp4[exp4[,2] > 0.5 & exp4$pr == 7 &
                exp4$method == previas[4] & exp4$Grupos == "G4",])/(1*5)*100,
              nrow(exp4[exp4[,2] > 0.5 & exp4$pr == 9 &
                exp4$method == previas[4] & exp4$Grupos == "G4",])/(1*5)*100)
}
matriz <- paste0(matriz, "%")
matriz <- matrix(matriz, ncol = 1)
rownames(matriz) <- paste0("Num vars =", c(5,7,9))
colnames(matriz) <- c("G4")
kable(matriz, caption = "Porcentaje de grupos incorrectamente seleccionados 
      con SB-SB.") %>%
  kable_styling()
```

Porcentaje de grupos incorrectamente no seleccionados:

```{r}
## Incorrectamente no seleccionados

# SB
matriz <- c()
for (j in 1:3) {
  matriz <- c(matriz,
              nrow(exp4[exp4[,2] < 0.5 & exp4$pr == 5 &
                exp4$method == previas[1] & 
                exp4$Grupos == paste0("G", j),])/(1*5)*100,
              nrow(exp4[exp4[,2] < 0.5 & exp4$pr == 7 &
                exp4$method == previas[1] & 
                  exp4$Grupos == paste0("G", j),])/(1*5)*100,
              nrow(exp4[exp4[,2] < 0.5 & exp4$pr == 9 &
                exp4$method == previas[1] & 
                  exp4$Grupos == paste0("G", j),])/(1*5)*100)
}
matriz <- paste0(matriz, "%")
matriz <- matrix(matriz, ncol = 3)
rownames(matriz) <- paste0("Num vars =", c(5,7,9))
colnames(matriz) <- c("G1", "G2", "G3")
kable(matriz, caption = "Porcentaje de grupos incorrectamente no seleccionados 
      con SB.") %>%
  kable_styling()

# Const-Const
matriz <- c()
for (j in 1:3) {
  matriz <- c(matriz,
              nrow(exp4[exp4[,2] < 0.5 & exp4$pr == 5 &
                exp4$method == previas[2] & 
                exp4$Grupos == paste0("G", j),])/(1*5)*100,
              nrow(exp4[exp4[,2] < 0.5 & exp4$pr == 7 &
                exp4$method == previas[2] & 
                  exp4$Grupos == paste0("G", j),])/(1*5)*100,
              nrow(exp4[exp4[,2] < 0.5 & exp4$pr == 9 &
                exp4$method == previas[2] & 
                  exp4$Grupos == paste0("G", j),])/(1*5)*100)
}
matriz <- paste0(matriz, "%")
matriz <- matrix(matriz, ncol = 3)
rownames(matriz) <- paste0("Num vars =", c(5,7,9))
colnames(matriz) <- c("G1", "G2", "G3")
kable(matriz, caption = "Porcentaje de grupos incorrectamente no seleccionados 
      con Const-Const.") %>%
  kable_styling()

# SB-Const
matriz <- c()
for (j in 1:3) {
  matriz <- c(matriz,
              nrow(exp4[exp4[,2] < 0.5 & exp4$pr == 5 &
                exp4$method == previas[3] & 
                exp4$Grupos == paste0("G", j),])/(1*5)*100,
              nrow(exp4[exp4[,2] < 0.5 & exp4$pr == 7 &
                exp4$method == previas[3] & 
                  exp4$Grupos == paste0("G", j),])/(1*5)*100,
              nrow(exp4[exp4[,2] < 0.5 & exp4$pr == 9 &
                exp4$method == previas[3] & 
                  exp4$Grupos == paste0("G", j),])/(1*5)*100)
}
matriz <- paste0(matriz, "%")
matriz <- matrix(matriz, ncol = 3)
rownames(matriz) <- paste0("Num vars =", c(5,7,9))
colnames(matriz) <- c("G1", "G2", "G3")
kable(matriz, caption = "Porcentaje de grupos incorrectamente no seleccionados 
      con SB-Const.") %>%
  kable_styling()

# SB-SB
matriz <- c()
for (j in 1:3) {
  matriz <- c(matriz,
              nrow(exp4[exp4[,2] < 0.5 & exp4$pr == 5 &
                exp4$method == previas[4] & 
                exp4$Grupos == paste0("G", j),])/(1*5)*100,
              nrow(exp4[exp4[,2] < 0.5 & exp4$pr == 7 &
                exp4$method == previas[4] & 
                  exp4$Grupos == paste0("G", j),])/(1*5)*100,
              nrow(exp4[exp4[,2] < 0.5 & exp4$pr == 9 &
                exp4$method == previas[4] & 
                  exp4$Grupos == paste0("G", j),])/(1*5)*100)
}
matriz <- paste0(matriz, "%")
matriz <- matrix(matriz, ncol = 3)
rownames(matriz) <- paste0("Num vars =", c(5,7,9))
colnames(matriz) <- c("G1", "G2", "G3")
kable(matriz, caption = "Porcentaje de grupos incorrectamente no seleccionados 
      con SB-SB.") %>%
  kable_styling()
```

### Variables agrupadas

En general:

```{r, fig.width = 6, fig.height = 4, fig.align = "center", fig.cap = ' '}
method <- Grupos <- probs <- Vars <- c()
n_vars <- c(5, 7, 9)
indices1 <- c(2:6, 8:12, 14:18, 20:24)
indices2 <- c(2:8, 10:16, 18:24, 26:32)
indices3 <- c(2:10, 12:20, 22:30, 32:40)
for (i in 1:5) {
  load(paste0("./Resultados_simulados/E4/resultado9.1.", i,".Rdata"))
  load(paste0("./Resultados_simulados/E4/resultado9.2.", i,".Rdata"))
  load(paste0("./Resultados_simulados/E4/resultado9.3.", i,".Rdata"))
  load(paste0("./Resultados_simulados/E4/resultado9.1.", i,"SB.Rdata"))
  load(paste0("./Resultados_simulados/E4/resultado9.2.", i,"SB.Rdata"))
  load(paste0("./Resultados_simulados/E4/resultado9.3.", i,"SB.Rdata"))
  probs <- c(probs,
             resultado9.1[[1]]$inclprob[indices1, 2], # CC
             resultado9.1[[2]]$inclprob[indices1, 2], # SBC
             resultado9.1[[3]]$inclprob[indices1, 2], # SBSB
             resultado9.1SB[[1]]$inclprob[indices1, 2], # SB
             resultado9.2[[1]]$inclprob[indices2, 2],
             resultado9.2[[2]]$inclprob[indices2, 2],
             resultado9.2[[3]]$inclprob[indices2, 2],
             resultado9.2SB[[1]]$inclprob[indices2, 2],
             resultado9.3[[1]]$inclprob[indices3, 2],
             resultado9.3[[2]]$inclprob[indices3, 2],
             resultado9.3[[3]]$inclprob[indices3, 2],
             resultado9.3SB[[1]]$inclprob[indices3, 2])

  for (j in 1:3) {
    method <- c(method,
                rep("Const-Const", n_vars[j]*4), rep("SB-Const", n_vars[j]*4),
                rep("SB-SB", n_vars[j]*4), rep("SB", n_vars[j]*4))
    Grupos <- c(Grupos,
                rep(c(rep("G1", n_vars[j]), rep("G2", n_vars[j]),
                      rep("G3", n_vars[j]), rep("G4", n_vars[j])), 4))
    Vars <- c(Vars,
              rep(c(paste0("1.", 1:n_vars[j]), paste0("2.", 1:n_vars[j]),
                paste0("3.", 1:n_vars[j]), paste0("4.", 1:n_vars[j])), 4))
  }
}

pr <- rep(c(rep(n_vars[1], n_vars[1]*16), rep(n_vars[2], n_vars[2]*16),
            rep(n_vars[3], n_vars[3]*16)), 5)

probs <- as.numeric(probs)
method <- factor(method, levels = c("SB", "Const-Const", "SB-Const", "SB-SB"))
pr <- factor(pr)
Grupos <- factor(Grupos)
Vars <- factor(Vars, levels = c(paste0("1.", 1:n_vars[3]), paste0("2.", 1:n_vars[3]),
                paste0("3.", 1:n_vars[3]), paste0("4.", 1:n_vars[3])))

exp4vars <- data.frame(pr, probs, method, Grupos, Vars)
```


```{r, fig.width = 6, fig.height = 4, fig.align = "center", fig.cap = ' '}
pG <- c()
for (i in 1:nrow(exp4)) {
  probG <- rep(exp4$probs[i], pr2[i])
  pG <- c(pG, probG)
}
exp4vars$pG <- pG

cols <- paletteer_d("ggthemes::wsj_rgby")
ggplot(data = exp4vars, aes(x = pr, y = probs, fill = Grupos)) +
  geom_boxplot(alpha = 0.7, outlier.colour = 1) +
  scale_fill_manual(values = cols) +
  geom_hline(yintercept = 0.5, linetype = 2, color = 8, alpha = 0.5, linewidth = 1) +
  labs(x = "Número de variables por grupo", y = "Probabilidad inclusión a posteriori") +
  theme_bw() + guides(fill = guide_legend(title = "Grupos")) +
  facet_wrap(~ method, ncol = 4) + coord_cartesian(ylim = c(0, 1))
```

En función del número de variables:

```{r, fig.width = 6, fig.height = 4, fig.align = "center", fig.cap = ' '}
cols <- paletteer_d("ggthemes::wsj_rgby")
ggplot(data = exp4vars[exp4vars$pr == 5,], 
       aes(x = Grupos, y = probs, fill = Grupos)) +
  geom_boxplot(alpha = 0.7, outlier.colour = 1) +
  scale_fill_manual(values = cols) +
  geom_hline(yintercept = 0.5, linetype = 2, color = 8, alpha = 0.5, linewidth = 1) +
  labs(x = "5 variables por grupo", y = "Probabilidad inclusión a posteriori") +
  theme_bw() + guides(fill = "none") +
  facet_wrap(~ method, ncol = 4) + coord_cartesian(ylim = c(0, 1))

ggplot(data = exp4vars[exp4vars$pr == 7,], 
       aes(x = Grupos, y = probs, fill = Grupos)) +
  geom_boxplot(alpha = 0.7, outlier.colour = 1) +
  scale_fill_manual(values = cols) +
  geom_hline(yintercept = 0.5, linetype = 2, color = 8, alpha = 0.5, linewidth = 1) +
  labs(x = "7 variables por grupo", y = "Probabilidad inclusión a posteriori") +
  theme_bw() + guides(fill = "none") +
  facet_wrap(~ method, ncol = 4) + coord_cartesian(ylim = c(0, 1))

ggplot(data = exp4vars[exp4vars$pr == 9,], 
       aes(x = Grupos, y = probs, fill = Grupos)) +
  geom_boxplot(alpha = 0.7, outlier.colour = 1) +
  scale_fill_manual(values = cols) +
  geom_hline(yintercept = 0.5, linetype = 2, color = 8, alpha = 0.5, linewidth = 1) +
  labs(x = "9 variables por grupo", y = "Probabilidad inclusión a posteriori") +
  theme_bw() + guides(fill = "none") +
  facet_wrap(~ method, ncol = 4) + coord_cartesian(ylim = c(0, 1))
```


```{r, fig.width = 10, fig.height = 6, fig.align = "center", fig.cap = ' ', eval = FALSE}
ggplot(data = exp4vars[exp4vars$pr == 5,], 
       aes(x = Vars, y = probs, fill = Grupos)) +
  geom_boxplot(alpha = 0.7, outlier.colour = 1) +
  scale_fill_manual(values = cols) +
  geom_hline(yintercept = 0.5, linetype = 2, color = 8, alpha = 0.5, linewidth = 1) +
  labs(x = "5 variables por grupo", y = "Probabilidad inclusión a posteriori") +
  theme_bw() + theme(axis.text.x = element_blank(), axis.ticks.x = element_blank()) +
  facet_wrap(~ method, ncol = 4) + coord_cartesian(ylim = c(0, 1))

ggplot(data = exp4vars[exp4vars$pr == 7,], 
       aes(x = Vars, y = probs, fill = Grupos)) +
  geom_boxplot(alpha = 0.7, outlier.colour = 1) +
  scale_fill_manual(values = cols) +
  geom_hline(yintercept = 0.5, linetype = 2, color = 8, alpha = 0.5, linewidth = 1) +
  labs(x = "7 variables por grupo", y = "Probabilidad inclusión a posteriori") +
  theme_bw() + theme(axis.text.x = element_blank(), axis.ticks.x = element_blank()) +
  facet_wrap(~ method, ncol = 4) + coord_cartesian(ylim = c(0, 1))

ggplot(data = exp4vars[exp4vars$pr == 9,], 
       aes(x = Vars, y = probs, fill = Grupos)) +
  geom_boxplot(alpha = 0.7, outlier.colour = 1) +
  scale_fill_manual(values = cols) +
  geom_hline(yintercept = 0.5, linetype = 2, color = 8, alpha = 0.5, linewidth = 1) +
  labs(x = "9 variables por grupo", y = "Probabilidad inclusión a posteriori") +
  theme_bw() + theme(axis.text.x = element_blank(), axis.ticks.x = element_blank()) +
  facet_wrap(~ method, ncol = 4) + coord_cartesian(ylim = c(0, 1))
```

Porcentaje de variables agrupadas incorrectamente no seleccionados:

```{r}
previas <- c("SB", "Const-Const", "SB-Const", "SB-SB")

# Calculamos los grupos incorrectamente no seleccionados
# SB
matriz <- c()
for (j in 1:3) {
  matriz <- c(matriz, 
              nrow(exp4vars[exp4vars[,2] < 0.5 & exp4vars$Grupos == paste0("G", j) &
                exp4vars$method == previas[1] & exp4vars$pr == 5,])/(5*5)*100,
              nrow(exp4vars[exp4vars[,2] < 0.5 & exp4vars$Grupos == paste0("G", j) &
                exp4vars$method == previas[1] & exp4vars$pr == 7,])/(7*5)*100,
              nrow(exp4vars[exp4vars[,2] < 0.5 & exp4vars$Grupos == paste0("G", j) &
                exp4vars$method == previas[1] & exp4vars$pr == 9,])/(9*5)*100)
}
matriz <- paste0(matriz, "%")
matriz <- matrix(matriz, ncol = 3)
rownames(matriz) <- paste0( "Num vars = ", unique(exp4$pr))
colnames(matriz) <- paste0("G", 1:3)
kable(matriz, caption = "Porcentaje de variables agrupadas incorrectamente no seleccionadas para SB.") %>%
  kable_styling()

# Const-Const
matriz <- c()
for (j in 1:3) {
  matriz <- c(matriz, 
              nrow(exp4vars[(exp4vars[,2] < 0.5| exp4vars$pG < 0.5) & exp4vars$Grupos == paste0("G", j) &
                exp4vars$method == previas[2] & exp4vars$pr == 5,])/(5*5)*100,
              nrow(exp4vars[(exp4vars[,2] < 0.5| exp4vars$pG < 0.5) & exp4vars$Grupos == paste0("G", j) &
                exp4vars$method == previas[2] & exp4vars$pr == 7,])/(7*5)*100,
              nrow(exp4vars[(exp4vars[,2] < 0.5| exp4vars$pG < 0.5) & exp4vars$Grupos == paste0("G", j) &
                exp4vars$method == previas[2] & exp4vars$pr == 9,])/(9*5)*100)
}
matriz <- paste0(matriz, "%")
matriz <- matrix(matriz, ncol = 3)
rownames(matriz) <- paste0( "Num vars = ", unique(exp4$pr))
colnames(matriz) <- paste0("G", 1:3)
kable(matriz, caption = "Porcentaje de variables agrupadas incorrectamente no seleccionadas para Const-Const.") %>%
  kable_styling()

# SB-Const
matriz <- c()
for (j in 1:3) {
  matriz <- c(matriz, 
              nrow(exp4vars[(exp4vars[,2] < 0.5| exp4vars$pG < 0.5) & exp4vars$Grupos == paste0("G", j) &
                exp4vars$method == previas[3] & exp4vars$pr == 5,])/(5*5)*100,
              nrow(exp4vars[(exp4vars[,2] < 0.5| exp4vars$pG < 0.5) & exp4vars$Grupos == paste0("G", j) &
                exp4vars$method == previas[3] & exp4vars$pr == 7,])/(7*5)*100,
              nrow(exp4vars[(exp4vars[,2] < 0.5| exp4vars$pG < 0.5) & exp4vars$Grupos == paste0("G", j) &
                exp4vars$method == previas[3] & exp4vars$pr == 9,])/(9*5)*100)
}
matriz <- paste0(matriz, "%")
matriz <- matrix(matriz, ncol = 3)
rownames(matriz) <- paste0( "Num vars = ", unique(exp4$pr))
colnames(matriz) <- paste0("G", 1:3)
kable(matriz, caption = "Porcentaje de variables agrupadas incorrectamente no seleccionadas para SB-Const.") %>%
  kable_styling()

# SB-SB
matriz <- c()
for (j in 1:3) {
  matriz <- c(matriz, 
              nrow(exp4vars[(exp4vars[,2] < 0.5| exp4vars$pG < 0.5) & exp4vars$Grupos == paste0("G", j) &
                exp4vars$method == previas[4] & exp4vars$pr == 5,])/(5*5)*100,
              nrow(exp4vars[(exp4vars[,2] < 0.5| exp4vars$pG < 0.5) & exp4vars$Grupos == paste0("G", j) &
                exp4vars$method == previas[4] & exp4vars$pr == 7,])/(7*5)*100,
              nrow(exp4vars[(exp4vars[,2] < 0.5| exp4vars$pG < 0.5) & exp4vars$Grupos == paste0("G", j) &
                exp4vars$method == previas[4] & exp4vars$pr == 9,])/(9*5)*100)
}
matriz <- paste0(matriz, "%")
matriz <- matrix(matriz, ncol = 3)
rownames(matriz) <- paste0( "Num vars = ", unique(exp4$pr))
colnames(matriz) <- paste0("G", 1:3)
kable(matriz, caption = "Porcentaje de variables agrupadas incorrectamente no seleccionadas para SB-SB.") %>%
  kable_styling()
```

Porcentaje de variables agrupadas incorrectamente seleccionados:

```{r}
previas <- c("SB", "Const-Const", "SB-Const", "SB-SB")

# Calculamos los grupos incorrectamente no seleccionados
# SB
matriz <- c()
for (j in 4:4) {
  matriz <- c(matriz, 
              nrow(exp4vars[exp4vars[,2] > 0.5 & exp4vars$Grupos == paste0("G", j) &
                exp4vars$method == previas[1] & exp4vars$pr == 5,])/(5*5)*100,
              nrow(exp4vars[exp4vars[,2] > 0.5 & exp4vars$Grupos == paste0("G", j) &
                exp4vars$method == previas[1] & exp4vars$pr == 7,])/(7*5)*100,
              nrow(exp4vars[exp4vars[,2] > 0.5 & exp4vars$Grupos == paste0("G", j) &
                exp4vars$method == previas[1] & exp4vars$pr == 9,])/(9*5)*100)
}
matriz <- paste0(matriz, "%")
matriz <- matrix(matriz, ncol = 1)
rownames(matriz) <- paste0( "Num vars = ", unique(exp4$pr))
colnames(matriz) <- paste0("G", 4)
kable(matriz, caption = "Porcentaje de variables agrupadas incorrectamente seleccionadas para SB.") %>%
  kable_styling()

# Const-Const
matriz <- c()
for (j in 4:4) {
  matriz <- c(matriz, 
              nrow(exp4vars[exp4vars[,2] > 0.5 & exp4vars$Grupos == paste0("G", j) &
                exp4vars$method == previas[2] & exp4vars$pr == 5,])/(5*5)*100,
              nrow(exp4vars[exp4vars[,2] > 0.5 & exp4vars$Grupos == paste0("G", j) &
                exp4vars$method == previas[2] & exp4vars$pr == 7,])/(7*5)*100,
              nrow(exp4vars[exp4vars[,2] > 0.5 & exp4vars$Grupos == paste0("G", j) &
                exp4vars$method == previas[2] & exp4vars$pr == 9,])/(9*5)*100)
}
matriz <- paste0(matriz, "%")
matriz <- matrix(matriz, ncol = 1)
rownames(matriz) <- paste0( "Num vars = ", unique(exp4$pr))
colnames(matriz) <- paste0("G", 4)
kable(matriz, caption = "Porcentaje de variables agrupadas incorrectamente seleccionadas para Const-Const.") %>%
  kable_styling()

# SB-Const
matriz <- c()
for (j in 4:4) {
  matriz <- c(matriz, 
              nrow(exp4vars[exp4vars[,2] > 0.5 & exp4vars$Grupos == paste0("G", j) & exp4vars$pG > 0.5 &
                exp4vars$method == previas[3] & exp4vars$pr == 5,])/(5*5)*100,
              nrow(exp4vars[exp4vars[,2] > 0.5 & exp4vars$Grupos == paste0("G", j) & exp4vars$pG > 0.5 &
                exp4vars$method == previas[3] & exp4vars$pr == 7,])/(7*5)*100,
              nrow(exp4vars[exp4vars[,2] > 0.5 & exp4vars$Grupos == paste0("G", j) & exp4vars$pG > 0.5 &
                exp4vars$method == previas[3] & exp4vars$pr == 9,])/(9*5)*100)
}
matriz <- paste0(matriz, "%")
matriz <- matrix(matriz, ncol = 1)
rownames(matriz) <- paste0( "Num vars = ", unique(exp4$pr))
colnames(matriz) <- paste0("G", 4)
kable(matriz, caption = "Porcentaje de variables agrupadas incorrectamente seleccionadas para SB-Const.") %>%
  kable_styling()

# SB-SB
matriz <- c()
for (j in 4:4) {
  matriz <- c(matriz, 
              nrow(exp4vars[exp4vars[,2] > 0.5 & exp4vars$Grupos == paste0("G", j) & exp4vars$pG > 0.5 &
                exp4vars$method == previas[4] & exp4vars$pr == 5,])/(5*5)*100,
              nrow(exp4vars[exp4vars[,2] > 0.5 & exp4vars$Grupos == paste0("G", j) & exp4vars$pG > 0.5 &
                exp4vars$method == previas[4] & exp4vars$pr == 7,])/(7*5)*100,
              nrow(exp4vars[exp4vars[,2] > 0.5 & exp4vars$Grupos == paste0("G", j) & exp4vars$pG > 0.5 &
                exp4vars$method == previas[4] & exp4vars$pr == 9,])/(9*5)*100)
}
matriz <- paste0(matriz, "%")
matriz <- matrix(matriz, ncol = 1)
rownames(matriz) <- paste0( "Num vars = ", unique(exp4$pr))
colnames(matriz) <- paste0("G", 4)
kable(matriz, caption = "Porcentaje de variables agrupadas incorrectamente seleccionadas para SB-SB.") %>%
  kable_styling()
```
